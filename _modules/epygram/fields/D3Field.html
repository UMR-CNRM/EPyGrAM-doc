
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>epygram.fields.D3Field &#8212; epygram 1.4.15 documentation</title>
    <link rel="stylesheet" href="../../../_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../_static/language_data.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">epygram 1.4.15 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../../epygram.html" accesskey="U">epygram</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for epygram.fields.D3Field</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1"># Copyright (c) Météo France (2014-)</span>
<span class="c1"># This software is governed by the CeCILL-C license under French law.</span>
<span class="c1"># http://www.cecill.info</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Contains the class that handle a Horizontal 2D field.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span><span class="p">,</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">unicode_literals</span><span class="p">,</span> <span class="n">division</span>
<span class="kn">import</span> <span class="nn">six</span>

<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="kn">import</span> <span class="nn">footprints</span>
<span class="kn">from</span> <span class="nn">footprints</span> <span class="k">import</span> <span class="n">FPDict</span><span class="p">,</span> <span class="n">FPList</span><span class="p">,</span> <span class="n">proxy</span> <span class="k">as</span> <span class="n">fpx</span>
<span class="kn">from</span> <span class="nn">bronx.graphics.axes</span> <span class="k">import</span> <span class="n">set_figax</span>
<span class="kn">from</span> <span class="nn">bronx.syntax.arrays</span> <span class="k">import</span> <span class="n">stretch_array</span>

<span class="kn">from</span> <span class="nn">epygram</span> <span class="k">import</span> <span class="n">epygramError</span><span class="p">,</span> <span class="n">config</span>
<span class="kn">from</span> <span class="nn">epygram.util</span> <span class="k">import</span> <span class="p">(</span><span class="n">write_formatted</span><span class="p">,</span> <span class="n">Angle</span><span class="p">,</span>
                          <span class="n">degrees_nearest_mod</span><span class="p">,</span>
                          <span class="n">as_numpy_array</span><span class="p">,</span>
                          <span class="n">moveaxis</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">epygram.base</span> <span class="k">import</span> <span class="n">Field</span><span class="p">,</span> <span class="n">FieldSet</span><span class="p">,</span> <span class="n">FieldValidity</span><span class="p">,</span> <span class="n">FieldValidityList</span><span class="p">,</span> <span class="n">Resource</span>
<span class="kn">from</span> <span class="nn">epygram.geometries</span> <span class="k">import</span> <span class="n">D3Geometry</span><span class="p">,</span> <span class="n">SpectralGeometry</span>
<span class="kn">from</span> <span class="nn">epygram.geometries.D3Geometry</span> <span class="k">import</span> <span class="n">D3ProjectedGeometry</span><span class="p">,</span> <span class="n">D3RectangularGridGeometry</span>


<div class="viewcode-block" id="_D3CommonField"><a class="viewcode-back" href="../../../library/D3Field.html#epygram.fields.D3Field._D3CommonField">[docs]</a><span class="k">class</span> <span class="nc">_D3CommonField</span><span class="p">(</span><span class="n">Field</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    3-Dimensions common field class.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_collector</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;field&#39;</span><span class="p">,)</span>
    <span class="n">_abstract</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">_footprint</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">attr</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
            <span class="n">structure</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">values</span><span class="o">=</span><span class="nb">set</span><span class="p">([</span><span class="s1">&#39;3D&#39;</span><span class="p">]),</span>
                <span class="n">info</span><span class="o">=</span><span class="s2">&quot;Type of Field geometry.&quot;</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">spectral</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns True if the field is spectral.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectral_geometry</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectral_geometry</span> <span class="o">!=</span> <span class="s1">&#39;__unknown__&#39;</span>

<span class="c1">###########################</span>
<span class="c1"># ABOUT VERTICAL GEOMETRY #</span>
<span class="c1">###########################</span>
<div class="viewcode-block" id="_D3CommonField.use_field_as_vcoord"><a class="viewcode-back" href="../../../library/D3Field.html#epygram.fields.D3Field._D3CommonField.use_field_as_vcoord">[docs]</a>    <span class="k">def</span> <span class="nf">use_field_as_vcoord</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">force_kind</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">validity_check</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Use values from the field as vertical coordinates.</span>
<span class="sd">        One example of use: field1 is a temperature field</span>
<span class="sd">        extracted from a resource on hybrid levels whereas</span>
<span class="sd">        field2 is the pressure field expressed on the same</span>
<span class="sd">        grid. field1.use_field_as_vcoord(field2) transforms</span>
<span class="sd">        the vertical coordinate of field1 to obtain a field</span>
<span class="sd">        on pressure levels.</span>

<span class="sd">        :param field: must be a field on the same geometry and</span>
<span class="sd">                      validity as self that we will use to replace</span>
<span class="sd">                      the vertical coordinate. &#39;generic&#39; fid must</span>
<span class="sd">                      allow to recognize the vertical coordinate</span>
<span class="sd">                      type (except if force_kind is set)</span>
<span class="sd">        :param force_kind: if not None, is used as the vertical</span>
<span class="sd">                           coordinate kind instead of trying to</span>
<span class="sd">                           guess it from the fid</span>
<span class="sd">        :param validity_check: if True (default) checks if validity</span>
<span class="sd">                               of current object and of field</span>
<span class="sd">                               parameter are the same</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span> <span class="o">!=</span> <span class="n">field</span><span class="o">.</span><span class="n">geometry</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">epygramError</span><span class="p">(</span><span class="s2">&quot;geometries must be identical&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">validity_check</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">validity</span> <span class="o">!=</span> <span class="n">field</span><span class="o">.</span><span class="n">validity</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">epygramError</span><span class="p">(</span><span class="s2">&quot;validities must be identical, &quot;</span> <span class="o">+</span> \
                               <span class="s2">&quot;or validity_check must be False&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">spectral</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">epygramError</span><span class="p">(</span><span class="s2">&quot;field must not be spectral&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">vcoordinate</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">as_vcoordinate</span><span class="p">(</span><span class="n">force_kind</span><span class="p">)</span></div>

<div class="viewcode-block" id="_D3CommonField.as_vcoordinate"><a class="viewcode-back" href="../../../library/D3Field.html#epygram.fields.D3Field._D3CommonField.as_vcoordinate">[docs]</a>    <span class="k">def</span> <span class="nf">as_vcoordinate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force_kind</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a VGeometry build from the values of field.</span>
<span class="sd">        Field must have a &#39;generic&#39; fid allowing to</span>
<span class="sd">        recognize the vertical coordinate type (except if</span>
<span class="sd">        force_kind is set)</span>

<span class="sd">        :param force_kind: if not None, is used as the vertical</span>
<span class="sd">                           coordinate kind instead of trying to</span>
<span class="sd">                           guess it from the fid</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">force_kind</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;generic&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fid</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">epygramError</span><span class="p">(</span><span class="s2">&quot;fid must contain a &#39;generic&#39; key or force_kind must be set&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;discipline&#39;</span><span class="p">,</span> <span class="s1">&#39;parameterCategory&#39;</span><span class="p">,</span> <span class="s1">&#39;parameterNumber&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fid</span><span class="p">[</span><span class="s1">&#39;generic&#39;</span><span class="p">]:</span>
                    <span class="k">raise</span> <span class="n">epygramError</span><span class="p">(</span><span class="s2">&quot;fid[&#39;generic&#39;] must contain the &quot;</span> <span class="o">+</span> <span class="n">k</span> <span class="o">+</span> <span class="s2">&quot; key.&quot;</span><span class="p">)</span>
            <span class="n">fid</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fid</span><span class="p">[</span><span class="s1">&#39;generic&#39;</span><span class="p">][</span><span class="s1">&#39;discipline&#39;</span><span class="p">],</span>
                   <span class="bp">self</span><span class="o">.</span><span class="n">fid</span><span class="p">[</span><span class="s1">&#39;generic&#39;</span><span class="p">][</span><span class="s1">&#39;parameterCategory&#39;</span><span class="p">],</span>
                   <span class="bp">self</span><span class="o">.</span><span class="n">fid</span><span class="p">[</span><span class="s1">&#39;generic&#39;</span><span class="p">][</span><span class="s1">&#39;parameterNumber&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">fid</span> <span class="o">==</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">vcoord</span> <span class="o">=</span> <span class="mi">100</span>
            <span class="k">elif</span> <span class="n">fid</span> <span class="o">==</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">):</span>
                <span class="n">vcoord</span> <span class="o">=</span> <span class="mi">102</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Do not know which kind of vertical coordinate fid corresponds to&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vcoord</span> <span class="o">=</span> <span class="n">force_kind</span>

        <span class="n">levels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getdata</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">vcoord</span> <span class="o">==</span> <span class="mi">100</span><span class="p">:</span>
            <span class="n">levels</span> <span class="o">=</span> <span class="n">levels</span> <span class="o">/</span> <span class="mf">100.</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">validity</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># data is an array z, y, x with z being optional</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">vcoordinate</span><span class="o">.</span><span class="n">levels</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># in case z dimension does not exist in data</span>
                <span class="n">levels</span> <span class="o">=</span> <span class="p">[</span><span class="n">levels</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># data is an array t, z, y, x with z being optional</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">vcoordinate</span><span class="o">.</span><span class="n">levels</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># in case z dimension does not exist in data</span>
                <span class="n">levels</span> <span class="o">=</span> <span class="p">[</span><span class="n">levels</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># if z dimension exist, z and t dimensions must be exchanged</span>
                <span class="n">levels</span> <span class="o">=</span> <span class="n">levels</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">kwargs_vcoord</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;structure&#39;</span><span class="p">:</span><span class="s1">&#39;V&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;typeoffirstfixedsurface&#39;</span><span class="p">:</span> <span class="n">vcoord</span><span class="p">,</span>
                         <span class="s1">&#39;position_on_grid&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">vcoordinate</span><span class="o">.</span><span class="n">position_on_grid</span><span class="p">,</span>
                         <span class="s1">&#39;levels&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">levels</span><span class="p">)</span>
                         <span class="p">}</span>
        <span class="k">return</span> <span class="n">fpx</span><span class="o">.</span><span class="n">geometry</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs_vcoord</span><span class="p">)</span></div>

<span class="c1">##############</span>
<span class="c1"># ABOUT DATA #</span>
<span class="c1">##############</span>

<div class="viewcode-block" id="_D3CommonField.getvalue_ll"><a class="viewcode-back" href="../../../library/D3Field.html#epygram.fields.D3Field._D3CommonField.getvalue_ll">[docs]</a>    <span class="k">def</span> <span class="nf">getvalue_ll</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lon</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">level</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">k</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">validity</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">,</span>
                    <span class="n">neighborinfo</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">one</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">external_distance</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the value of the field on point of coordinates</span>
<span class="sd">        (*lon, lat, level*).</span>
<span class="sd">        *lon* and *lat* may be list/numpy.array.</span>

<span class="sd">        :param interpolation: if:\n</span>
<span class="sd">                              - &#39;nearest&#39; (default), returns the value of the</span>
<span class="sd">                                nearest neighboring gridpoint;</span>
<span class="sd">                              - &#39;linear&#39;, computes and returns the field value</span>
<span class="sd">                                with bilinear or linear spline interpolation;</span>
<span class="sd">                              - &#39;cubic&#39;, computes and returns the field value</span>
<span class="sd">                                with cubic spline interpolation;</span>
<span class="sd">        :param level: is the True level not the index of the level. Depending on</span>
<span class="sd">                      the vertical coordinate, it could be expressed in Pa, m.</span>
<span class="sd">        :param k: is the index of the level.</span>
<span class="sd">        :param validity: is a FieldValidity or a FieldValidityList instance</span>
<span class="sd">        :param neighborinfo: if set to **True**, returns a tuple</span>
<span class="sd">                             *(value, (lon, lat))*, with *(lon, lat)* being</span>
<span class="sd">                             the actual coordinates of the neighboring gridpoint</span>
<span class="sd">                             (only for *interpolation == &#39;nearest&#39;*).</span>
<span class="sd">        :param one: if False and len(lon) is 1, returns [value] instead of value.</span>
<span class="sd">        :param external_distance: can be a dict containing the target point value</span>
<span class="sd">          and an external field on the same grid as self, to which the distance</span>
<span class="sd">          is computed within the 4 horizontally nearest points; e.g.</span>
<span class="sd">          {&#39;target_value&#39;:4810, &#39;external_field&#39;:an_H2DField_with_same_geometry}.</span>
<span class="sd">          If so, the nearest point is selected with</span>
<span class="sd">          distance = abs(target_value - external_field.data)</span>

<span class="sd">        When linear interpolation method is choosen, if the grid is rectangular,</span>
<span class="sd">        the interpolation is a bilinear one on the model grid, otherwise it</span>
<span class="sd">        is a spline interpolation on the lat/lon domain.</span>

<span class="sd">        Warning: for interpolation on Gauss geometries, requires the</span>
<span class="sd">        :mod:`pyproj` module.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectral</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">epygramError</span><span class="p">(</span><span class="s2">&quot;field must be gridpoint to get value of a&quot;</span> <span class="o">+</span>
                               <span class="s2">&quot; lon/lat point.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">vcoordinate</span><span class="o">.</span><span class="n">levels</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> \
           <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">vcoordinate</span><span class="o">.</span><span class="n">levels</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">vcoordinate</span><span class="o">.</span><span class="n">levels</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="n">epygramError</span><span class="p">(</span><span class="s1">&#39;Some levels are represented twice in levels list.&#39;</span><span class="p">)</span>

        <span class="c1"># We look for indexes for time coordinate (no interpolation)</span>
        <span class="k">if</span> <span class="n">validity</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">validity</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">epygramError</span><span class="p">(</span><span class="s2">&quot;*validity* is mandatory when there are several validities&quot;</span><span class="p">)</span>
            <span class="n">t</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">validity</span><span class="p">,</span> <span class="n">FieldValidity</span><span class="p">):</span>
                <span class="n">validity</span> <span class="o">=</span> <span class="n">FieldValidityList</span><span class="p">(</span><span class="n">validity</span><span class="p">)</span>
            <span class="n">t</span> <span class="o">=</span> <span class="p">[[</span><span class="n">ind</span> <span class="k">for</span> <span class="n">ind</span> <span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">validity</span><span class="p">)</span> <span class="k">if</span> <span class="n">val</span> <span class="o">==</span> <span class="n">v</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">validity</span><span class="p">]</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">as_numpy_array</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

        <span class="c1"># We look for indexes for vertical coordinate (no interpolation)</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">level</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">epygramError</span><span class="p">(</span><span class="s2">&quot;*level* and *k* cannot be different from None together&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">k</span> <span class="ow">is</span> <span class="n">level</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">datashape</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="n">epygramError</span><span class="p">(</span><span class="s2">&quot;*level* or *k* is mandatory when field has a vertical coordinate&quot;</span><span class="p">)</span>
            <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">elif</span> <span class="n">k</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># level is not None</span>
            <span class="n">k</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">vcoordinate</span><span class="o">.</span><span class="n">levels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">as_numpy_array</span><span class="p">(</span><span class="n">level</span><span class="p">)]</span>
        <span class="n">k</span> <span class="o">=</span> <span class="n">as_numpy_array</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">lon</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">lat</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">epygramError</span><span class="p">(</span><span class="s2">&quot;*lon* and *lat* are mandatory&quot;</span><span class="p">)</span>
        <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span> <span class="o">=</span> <span class="n">as_numpy_array</span><span class="p">(</span><span class="n">lon</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">as_numpy_array</span><span class="p">(</span><span class="n">lat</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lon</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lat</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">epygramError</span><span class="p">(</span><span class="s2">&quot;*lon* and *lat* must have the same length&quot;</span><span class="p">)</span>

        <span class="n">sizes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">t</span><span class="p">]])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sizes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sizes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="mi">1</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sizes</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">epygramError</span><span class="p">(</span><span class="s2">&quot;each of lon, lat, k/level and validity must be scalar or have the same length as the others&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">interpolation</span> <span class="o">==</span> <span class="s1">&#39;linear&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="p">,</span> <span class="n">D3RectangularGridGeometry</span><span class="p">):</span>
                <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;bilinear&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;linear_spline&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">method</span> <span class="o">=</span> <span class="n">interpolation</span>

        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;nearest&#39;</span><span class="p">:</span>
            <span class="p">(</span><span class="n">ri</span><span class="p">,</span> <span class="n">rj</span><span class="p">)</span> <span class="o">=</span> <span class="n">moveaxis</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">nearest_points</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;n&#39;</span><span class="p">:</span><span class="s1">&#39;1&#39;</span><span class="p">},</span>
                                            <span class="n">external_distance</span><span class="o">=</span><span class="n">external_distance</span><span class="p">)),</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getvalue_ij</span><span class="p">(</span><span class="n">ri</span><span class="p">,</span> <span class="n">rj</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">one</span><span class="o">=</span><span class="n">one</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">neighborinfo</span><span class="p">:</span>
                <span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">ij2ll</span><span class="p">(</span><span class="n">ri</span><span class="p">,</span> <span class="n">rj</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">lon</span><span class="p">)</span> <span class="ow">in</span> <span class="p">((</span><span class="mi">1</span><span class="p">,),</span> <span class="p">()):</span>
                    <span class="n">lon</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">lon</span><span class="p">)</span>
                    <span class="n">lat</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">lat</span><span class="p">)</span>
                <span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">))</span>

        <span class="k">elif</span> <span class="n">method</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;linear_spline&#39;</span><span class="p">,</span> <span class="s1">&#39;cubic&#39;</span><span class="p">,</span> <span class="s1">&#39;bilinear&#39;</span><span class="p">):</span>
            <span class="n">lon</span> <span class="o">=</span> <span class="n">lon</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lon</span><span class="p">)</span> <span class="o">==</span> <span class="nb">max</span><span class="p">(</span><span class="n">sizes</span><span class="p">)</span> <span class="k">else</span> <span class="n">lon</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">sizes</span><span class="p">))</span>
            <span class="n">lat</span> <span class="o">=</span> <span class="n">lat</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lat</span><span class="p">)</span> <span class="o">==</span> <span class="nb">max</span><span class="p">(</span><span class="n">sizes</span><span class="p">)</span> <span class="k">else</span> <span class="n">lat</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">sizes</span><span class="p">))</span>
            <span class="n">k</span> <span class="o">=</span> <span class="n">k</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">==</span> <span class="nb">max</span><span class="p">(</span><span class="n">sizes</span><span class="p">)</span> <span class="k">else</span> <span class="n">k</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">sizes</span><span class="p">))</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">t</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="o">==</span> <span class="nb">max</span><span class="p">(</span><span class="n">sizes</span><span class="p">)</span> <span class="k">else</span> <span class="n">t</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">sizes</span><span class="p">))</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">sizes</span><span class="p">))</span>
            <span class="n">interp_points</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">nearest_points</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span>
                                                         <span class="p">{</span><span class="s1">&#39;linear&#39;</span><span class="p">:{</span><span class="s1">&#39;n&#39;</span><span class="p">:</span><span class="s1">&#39;2*2&#39;</span><span class="p">},</span>
                                                          <span class="s1">&#39;linear_spline&#39;</span><span class="p">:{</span><span class="s1">&#39;n&#39;</span><span class="p">:</span><span class="s1">&#39;2*2&#39;</span><span class="p">},</span>
                                                          <span class="s1">&#39;bilinear&#39;</span><span class="p">:{</span><span class="s1">&#39;n&#39;</span><span class="p">:</span><span class="s1">&#39;2*2&#39;</span><span class="p">},</span>
                                                          <span class="s1">&#39;cubic&#39;</span><span class="p">:{</span><span class="s1">&#39;n&#39;</span><span class="p">:</span><span class="s1">&#39;4*4&#39;</span><span class="p">}}[</span><span class="n">interpolation</span><span class="p">],</span>
                                                         <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="c1"># depack</span>
            <span class="n">all_i</span> <span class="o">=</span> <span class="n">interp_points</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">all_j</span> <span class="o">=</span> <span class="n">interp_points</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">all_k</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">k</span><span class="p">[:,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span> <span class="n">interp_points</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">all_t</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">t</span><span class="p">[:,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span> <span class="n">interp_points</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="c1"># get values and lons/lats</span>
            <span class="n">values_at_interp_points</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getvalue_ij</span><span class="p">(</span><span class="n">all_i</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
                                                       <span class="n">all_j</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
                                                       <span class="n">all_k</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
                                                       <span class="n">all_t</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">all_i</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">method</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;linear_spline&#39;</span><span class="p">,</span> <span class="s1">&#39;cubic&#39;</span><span class="p">):</span>
                <span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="k">import</span> <span class="n">interp1d</span><span class="p">,</span> <span class="n">interp2d</span>
                <span class="n">all_lons</span><span class="p">,</span> <span class="n">all_lats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">ij2ll</span><span class="p">(</span><span class="n">all_i</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">all_j</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
                <span class="n">all_lons</span> <span class="o">=</span> <span class="n">all_lons</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">all_i</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                <span class="n">all_lats</span> <span class="o">=</span> <span class="n">all_lats</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">all_i</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">sizes</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;academic&#39;</span> <span class="ow">and</span> \
                       <span class="mi">1</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="s1">&#39;Y&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">f</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">all_lats</span><span class="p">[</span><span class="n">n</span><span class="p">],</span> <span class="n">values_at_interp_points</span><span class="p">[</span><span class="n">n</span><span class="p">],</span> <span class="n">kind</span><span class="o">=</span><span class="n">interpolation</span><span class="p">)</span>
                            <span class="n">value</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">lat</span><span class="p">[</span><span class="n">n</span><span class="p">])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">f</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">all_lons</span><span class="p">[</span><span class="n">n</span><span class="p">],</span> <span class="n">values_at_interp_points</span><span class="p">[</span><span class="n">n</span><span class="p">],</span> <span class="n">kind</span><span class="o">=</span><span class="n">interpolation</span><span class="p">)</span>
                            <span class="n">value</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">lon</span><span class="p">[</span><span class="n">n</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">f</span> <span class="o">=</span> <span class="n">interp2d</span><span class="p">(</span><span class="n">all_lons</span><span class="p">[</span><span class="n">n</span><span class="p">],</span> <span class="n">all_lats</span><span class="p">[</span><span class="n">n</span><span class="p">],</span> <span class="n">values_at_interp_points</span><span class="p">[</span><span class="n">n</span><span class="p">],</span> <span class="n">kind</span><span class="o">=</span><span class="n">interpolation</span><span class="p">)</span>
                        <span class="n">value</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">as_numpy_array</span><span class="p">(</span><span class="n">lon</span><span class="p">)[</span><span class="n">n</span><span class="p">],</span> <span class="n">as_numpy_array</span><span class="p">(</span><span class="n">lat</span><span class="p">)[</span><span class="n">n</span><span class="p">])</span>

            <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;bilinear&#39;</span><span class="p">:</span>
                <span class="k">def</span> <span class="nf">simple_inter</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">q1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">q2</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
                    <span class="sd">&quot;&quot;&quot;Simple linear interpolant&quot;&quot;&quot;</span>
                    <span class="k">return</span> <span class="p">(</span><span class="n">x2</span> <span class="o">-</span> <span class="n">x</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">x2</span> <span class="o">-</span> <span class="n">x1</span><span class="p">)</span> <span class="o">*</span> <span class="n">q1</span> <span class="o">+</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">x1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">x2</span> <span class="o">-</span> <span class="n">x1</span><span class="p">)</span> <span class="o">*</span> <span class="n">q2</span>

                <span class="k">if</span> <span class="s1">&#39;gauss&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                    <span class="n">test</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">all_j</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">all_j</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span> <span class="ow">and</span> <span class="n">numpy</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">all_j</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">all_j</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">])</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">test</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Points are not in the awaited order...&quot;</span><span class="p">)</span>

                    <span class="n">lonrs</span><span class="p">,</span> <span class="n">latrs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">_rotate_stretch</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">)</span> <span class="c1">#waited point</span>
                    <span class="n">lonrs_near</span><span class="p">,</span> <span class="n">latrs_near</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">_rotate_stretch</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">ij2ll</span><span class="p">(</span><span class="n">all_i</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">all_j</span><span class="o">.</span><span class="n">flatten</span><span class="p">()))</span>
                    <span class="n">lonrs_near</span><span class="p">,</span> <span class="n">latrs_near</span> <span class="o">=</span> <span class="n">lonrs_near</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">all_i</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span> <span class="n">latrs_near</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">all_i</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">simple_inter</span><span class="p">(</span><span class="n">latrs_near</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">simple_inter</span><span class="p">(</span><span class="n">lonrs_near</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">values_at_interp_points</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span>
                                                                        <span class="n">lonrs_near</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">values_at_interp_points</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">lonrs</span><span class="p">),</span>
                                         <span class="n">latrs_near</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">simple_inter</span><span class="p">(</span><span class="n">lonrs_near</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">values_at_interp_points</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span>
                                                                        <span class="n">lonrs_near</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">],</span> <span class="n">values_at_interp_points</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">],</span> <span class="n">lonrs</span><span class="p">),</span>
                                         <span class="n">latrs</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">square</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">all_i</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">all_i</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span> <span class="ow">and</span> <span class="n">numpy</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">all_i</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">all_i</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">])</span> <span class="ow">and</span> \
                             <span class="n">numpy</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">all_j</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">all_j</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">])</span> <span class="ow">and</span> <span class="n">numpy</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">all_j</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">all_j</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">])</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">square</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Bilinear interpolation on non gaussian, irregular grid&quot;</span><span class="p">)</span>
                    
                    <span class="c1"># Position of wanted point</span>
                    <span class="n">wanted_i</span><span class="p">,</span> <span class="n">wanted_j</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">ll2ij</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">)</span>
                    
                    <span class="n">value</span> <span class="o">=</span> <span class="n">simple_inter</span><span class="p">(</span><span class="n">all_j</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">simple_inter</span><span class="p">(</span><span class="n">all_i</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">values_at_interp_points</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span>
                                                                    <span class="n">all_i</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">values_at_interp_points</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">wanted_i</span><span class="p">),</span>
                                         <span class="n">all_j</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">simple_inter</span><span class="p">(</span><span class="n">all_i</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">values_at_interp_points</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span>
                                                                   <span class="n">all_i</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">],</span> <span class="n">values_at_interp_points</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">],</span> <span class="n">wanted_i</span><span class="p">),</span>
                                         <span class="n">wanted_j</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;*interpolation*=&#39;</span> <span class="o">+</span> <span class="n">interpolation</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">one</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
                <span class="k">pass</span>

        <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></div>


<div class="viewcode-block" id="_D3CommonField.as_lists"><a class="viewcode-back" href="../../../library/D3Field.html#epygram.fields.D3Field._D3CommonField.as_lists">[docs]</a>    <span class="k">def</span> <span class="nf">as_lists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="n">subzone</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Export values as a dict of lists (in fact numpy arrays).</span>

<span class="sd">        :param order: whether to flatten arrays in &#39;C&#39; (row-major) or</span>
<span class="sd">                      &#39;F&#39; (Fortran, column-major) order.</span>
<span class="sd">        :param subzone: defines the LAM subzone to be included, in LAM case,</span>
<span class="sd">                        among: &#39;C&#39;, &#39;CI&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectral</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">epygramError</span><span class="p">(</span><span class="s2">&quot;as_lists method needs a grid-point field, not a spectral one.&quot;</span><span class="p">)</span>

        <span class="n">lons4d</span><span class="p">,</span> <span class="n">lats4d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">get_lonlat_grid</span><span class="p">(</span><span class="n">d4</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nb_validities</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">validity</span><span class="p">),</span> <span class="n">subzone</span><span class="o">=</span><span class="n">subzone</span><span class="p">)</span>
        <span class="n">levels4d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">get_levels</span><span class="p">(</span><span class="n">d4</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nb_validities</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">validity</span><span class="p">),</span> <span class="n">subzone</span><span class="o">=</span><span class="n">subzone</span><span class="p">)</span>
        <span class="n">data4d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">d4</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">subzone</span><span class="o">=</span><span class="n">subzone</span><span class="p">)</span>

        <span class="n">dates4d</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">times4d</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">validity</span><span class="p">):</span>
            <span class="n">dates4d</span> <span class="o">+=</span> <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">year</span> <span class="o">*</span> <span class="mi">10000</span> <span class="o">+</span> <span class="n">t</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">month</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">+</span> <span class="n">t</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">day</span><span class="p">]</span> <span class="o">*</span> <span class="n">levels4d</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">size</span>
            <span class="n">times4d</span> <span class="o">+=</span> <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">hour</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">+</span> <span class="n">t</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">minute</span><span class="p">]</span> <span class="o">*</span> <span class="n">levels4d</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">size</span>
        <span class="n">dates4d</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dates4d</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">data4d</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">)</span>
        <span class="n">times4d</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">times4d</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">data4d</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">values</span><span class="o">=</span><span class="n">data4d</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">),</span>
                      <span class="n">latitudes</span><span class="o">=</span><span class="n">lats4d</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">),</span>
                      <span class="n">longitudes</span><span class="o">=</span><span class="n">lons4d</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">),</span>
                      <span class="n">levels</span><span class="o">=</span><span class="n">levels4d</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">),</span>
                      <span class="n">dates</span><span class="o">=</span><span class="n">dates4d</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">),</span>
                      <span class="n">times</span><span class="o">=</span><span class="n">times4d</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="_D3CommonField.as_dicts"><a class="viewcode-back" href="../../../library/D3Field.html#epygram.fields.D3Field._D3CommonField.as_dicts">[docs]</a>    <span class="k">def</span> <span class="nf">as_dicts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subzone</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Export values as a list of dicts.</span>

<span class="sd">        :param subzone: defines the LAM subzone to be included, in LAM case,</span>
<span class="sd">                        among: &#39;C&#39;, &#39;CI&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectral</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">epygramError</span><span class="p">(</span><span class="s2">&quot;as_dicts method needs a grid-point field, not a spectral one.&quot;</span><span class="p">)</span>

        <span class="n">lons</span><span class="p">,</span> <span class="n">lats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">get_lonlat_grid</span><span class="p">(</span><span class="n">subzone</span><span class="o">=</span><span class="n">subzone</span><span class="p">)</span>
        <span class="n">data4d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">d4</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">subzone</span><span class="o">=</span><span class="n">subzone</span><span class="p">)</span>
        <span class="n">levels4d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">get_levels</span><span class="p">(</span><span class="n">d4</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nb_validities</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">validity</span><span class="p">),</span> <span class="n">subzone</span><span class="o">=</span><span class="n">subzone</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">data4d</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">validity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validity</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>
            <span class="n">date</span> <span class="o">=</span> <span class="n">validity</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">year</span> <span class="o">*</span> <span class="mi">10000</span> <span class="o">+</span> <span class="n">validity</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">month</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">+</span> <span class="n">validity</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">day</span>
            <span class="n">time</span> <span class="o">=</span> <span class="n">validity</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">hour</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">+</span> <span class="n">validity</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">minute</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">data4d</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">data4d</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">data4d</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
                        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">data4d</span><span class="p">[</span><span class="n">t</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">],</span>
                                           <span class="n">date</span><span class="o">=</span><span class="n">date</span><span class="p">,</span>
                                           <span class="n">time</span><span class="o">=</span><span class="n">time</span><span class="p">,</span>
                                           <span class="n">latitude</span><span class="o">=</span><span class="n">lats</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">],</span>
                                           <span class="n">longitude</span><span class="o">=</span><span class="n">lons</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">],</span>
                                           <span class="n">level</span><span class="o">=</span><span class="n">levels4d</span><span class="p">[</span><span class="n">t</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]))</span>
        <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="_D3CommonField.as_points"><a class="viewcode-back" href="../../../library/D3Field.html#epygram.fields.D3Field._D3CommonField.as_points">[docs]</a>    <span class="k">def</span> <span class="nf">as_points</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subzone</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Export values as a fieldset of points.</span>

<span class="sd">        :param subzone: defines the LAM subzone to be included, in LAM case,</span>
<span class="sd">                     among: &#39;C&#39;, &#39;CI&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectral</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">epygramError</span><span class="p">(</span><span class="s2">&quot;as_points method needs a grid-point field, not a spectral one.&quot;</span><span class="p">)</span>

        <span class="n">field_builder</span> <span class="o">=</span> <span class="n">fpx</span><span class="o">.</span><span class="n">field</span>
        <span class="n">geom_builder</span> <span class="o">=</span> <span class="n">fpx</span><span class="o">.</span><span class="n">geometry</span>
        <span class="n">vcoord_builer</span> <span class="o">=</span> <span class="n">fpx</span><span class="o">.</span><span class="n">geometry</span>

        <span class="n">lons</span><span class="p">,</span> <span class="n">lats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">get_lonlat_grid</span><span class="p">(</span><span class="n">subzone</span><span class="o">=</span><span class="n">subzone</span><span class="p">)</span>
        <span class="n">data4d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">d4</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">subzone</span><span class="o">=</span><span class="n">subzone</span><span class="p">)</span>
        <span class="n">levels4d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">get_levels</span><span class="p">(</span><span class="n">d4</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nb_validities</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">validity</span><span class="p">),</span> <span class="n">subzone</span><span class="o">=</span><span class="n">subzone</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">FieldSet</span><span class="p">()</span>
        <span class="n">kwargs_vcoord</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">vcoordinate</span><span class="o">.</span><span class="n">footprint_as_dict</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">data4d</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">validity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validity</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">data4d</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">data4d</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">data4d</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
                        <span class="n">kwargs_vcoord</span><span class="p">[</span><span class="s1">&#39;levels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">levels4d</span><span class="p">[</span><span class="n">t</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]]</span>
                        <span class="n">vcoordinate</span> <span class="o">=</span> <span class="n">vcoord_builer</span><span class="p">(</span><span class="o">**</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">kwargs_vcoord</span><span class="p">))</span>
                        <span class="n">geometry</span> <span class="o">=</span> <span class="n">geom_builder</span><span class="p">(</span><span class="n">structure</span><span class="o">=</span><span class="s1">&#39;Point&#39;</span><span class="p">,</span>
                                                <span class="n">dimensions</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;X&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">},</span>
                                                <span class="n">vcoordinate</span><span class="o">=</span><span class="n">vcoordinate</span><span class="p">,</span>
                                                <span class="n">grid</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;longitudes&#39;</span><span class="p">:[</span><span class="n">lons</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]],</span>
                                                      <span class="s1">&#39;latitudes&#39;</span><span class="p">:[</span><span class="n">lats</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]]},</span>
                                                <span class="n">position_on_horizontal_grid</span><span class="o">=</span><span class="s1">&#39;center&#39;</span>
                                                <span class="p">)</span>
                        <span class="n">pointfield</span> <span class="o">=</span> <span class="n">field_builder</span><span class="p">(</span><span class="n">structure</span><span class="o">=</span><span class="s1">&#39;Point&#39;</span><span class="p">,</span>
                                                   <span class="n">fid</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fid</span><span class="p">)),</span>
                                                   <span class="n">geometry</span><span class="o">=</span><span class="n">geometry</span><span class="p">,</span>
                                                   <span class="n">validity</span><span class="o">=</span><span class="n">validity</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
                        <span class="n">pointfield</span><span class="o">.</span><span class="n">setdata</span><span class="p">(</span><span class="n">data4d</span><span class="p">[</span><span class="n">t</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">])</span>
                        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pointfield</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="_D3CommonField.as_profiles"><a class="viewcode-back" href="../../../library/D3Field.html#epygram.fields.D3Field._D3CommonField.as_profiles">[docs]</a>    <span class="k">def</span> <span class="nf">as_profiles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subzone</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Export values as a fieldset of profiles.</span>

<span class="sd">        :param subzone: defines the LAM subzone to be included, in LAM case,</span>
<span class="sd">                        among: &#39;C&#39;, &#39;CI&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectral</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">epygramError</span><span class="p">(</span><span class="s2">&quot;as_profiles method needs a grid-point field, not a spectral one.&quot;</span><span class="p">)</span>

        <span class="n">field_builder</span> <span class="o">=</span> <span class="n">fpx</span><span class="o">.</span><span class="n">field</span>
        <span class="n">geom_builder</span> <span class="o">=</span> <span class="n">fpx</span><span class="o">.</span><span class="n">geometry</span>
        <span class="n">vcoord_builer</span> <span class="o">=</span> <span class="n">fpx</span><span class="o">.</span><span class="n">geometry</span>

        <span class="n">lons4d</span><span class="p">,</span> <span class="n">lats4d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">get_lonlat_grid</span><span class="p">(</span><span class="n">subzone</span><span class="o">=</span><span class="n">subzone</span><span class="p">,</span> <span class="n">d4</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nb_validities</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">data4d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">d4</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">subzone</span><span class="o">=</span><span class="n">subzone</span><span class="p">)</span>
        <span class="n">levels4d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">get_levels</span><span class="p">(</span><span class="n">d4</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nb_validities</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">validity</span><span class="p">),</span> <span class="n">subzone</span><span class="o">=</span><span class="n">subzone</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">FieldSet</span><span class="p">()</span>
        <span class="n">kwargs_vcoord</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">vcoordinate</span><span class="o">.</span><span class="n">footprint_as_dict</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">data4d</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">data4d</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
                <span class="k">if</span> <span class="nb">all</span><span class="p">([</span><span class="n">numpy</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">levels4d</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">levels4d</span><span class="p">[</span><span class="n">t</span><span class="p">,</span> <span class="p">:,</span> <span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">validity</span><span class="p">))]):</span>
                    <span class="n">kwargs_vcoord</span><span class="p">[</span><span class="s1">&#39;levels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">levels4d</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">kwargs_vcoord</span><span class="p">[</span><span class="s1">&#39;levels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">levels4d</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
                <span class="n">vcoordinate</span> <span class="o">=</span> <span class="n">vcoord_builer</span><span class="p">(</span><span class="o">**</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">kwargs_vcoord</span><span class="p">))</span>
                <span class="n">geometry</span> <span class="o">=</span> <span class="n">geom_builder</span><span class="p">(</span><span class="n">structure</span><span class="o">=</span><span class="s1">&#39;V1D&#39;</span><span class="p">,</span>
                                        <span class="n">dimensions</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;X&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">},</span>
                                        <span class="n">vcoordinate</span><span class="o">=</span><span class="n">vcoordinate</span><span class="p">,</span>
                                        <span class="n">grid</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;longitudes&#39;</span><span class="p">:[</span><span class="n">lons4d</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()],</span>
                                              <span class="s1">&#39;latitudes&#39;</span><span class="p">:[</span><span class="n">lats4d</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()],</span>
                                              <span class="p">},</span>
                                        <span class="n">position_on_horizontal_grid</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
                                        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;unstructured&#39;</span>
                                        <span class="p">)</span>
                <span class="n">profilefield</span> <span class="o">=</span> <span class="n">field_builder</span><span class="p">(</span><span class="n">structure</span><span class="o">=</span><span class="s1">&#39;V1D&#39;</span><span class="p">,</span>
                                             <span class="n">fid</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fid</span><span class="p">)),</span>
                                             <span class="n">geometry</span><span class="o">=</span><span class="n">geometry</span><span class="p">,</span>
                                             <span class="n">validity</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">validity</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
                <span class="n">profilefield</span><span class="o">.</span><span class="n">setdata</span><span class="p">(</span><span class="n">data4d</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">])</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">profilefield</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="_D3CommonField.extract_physicallevels"><a class="viewcode-back" href="../../../library/D3Field.html#epygram.fields.D3Field._D3CommonField.extract_physicallevels">[docs]</a>    <span class="k">def</span> <span class="nf">extract_physicallevels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">getdata</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a new field excluding levels with no physical meaning.</span>

<span class="sd">        :param getdata: if False returns a field without data</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">vcoordinate</span><span class="o">.</span><span class="n">typeoffirstfixedsurface</span> <span class="o">==</span> <span class="mi">118</span><span class="p">:</span>
            <span class="c1"># build fid</span>
            <span class="n">fid</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:(</span><span class="n">FPDict</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
                        <span class="k">else</span> <span class="n">value</span><span class="p">)</span>
                   <span class="k">for</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fid</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
            <span class="c1">#build geometry</span>
            <span class="n">geometry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">make_physicallevels_geometry</span><span class="p">()</span>
            <span class="c1"># Field</span>
            <span class="n">newfield</span> <span class="o">=</span> <span class="n">fpx</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">fid</span><span class="o">=</span><span class="n">FPDict</span><span class="p">(</span><span class="n">fid</span><span class="p">),</span>
                                 <span class="n">structure</span><span class="o">=</span><span class="n">geometry</span><span class="o">.</span><span class="n">structure</span><span class="p">,</span>
                                 <span class="n">geometry</span><span class="o">=</span><span class="n">geometry</span><span class="p">,</span>
                                 <span class="n">validity</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">validity</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(),</span>
                                 <span class="n">processtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">processtype</span><span class="p">,</span>
                                 <span class="n">comment</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">comment</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">getdata</span><span class="p">:</span>
                <span class="n">shp</span> <span class="o">=</span> <span class="n">geometry</span><span class="o">.</span><span class="n">get_datashape</span><span class="p">(</span><span class="n">dimT</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">validity</span><span class="p">),</span> <span class="n">d4</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">(</span><span class="n">shp</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">validity</span><span class="p">)):</span>
                    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">geometry</span><span class="o">.</span><span class="n">vcoordinate</span><span class="o">.</span><span class="n">levels</span><span class="p">)):</span>
                        <span class="n">k_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">vcoordinate</span><span class="o">.</span><span class="n">levels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">geometry</span><span class="o">.</span><span class="n">vcoordinate</span><span class="o">.</span><span class="n">levels</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                        <span class="n">data</span><span class="p">[</span><span class="n">t</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">d4</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="n">t</span><span class="p">,</span> <span class="n">k_index</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
                <span class="n">newfield</span><span class="o">.</span><span class="n">setdata</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    
            <span class="k">return</span> <span class="n">newfield</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span></div>


<div class="viewcode-block" id="_D3CommonField.extractprofile"><a class="viewcode-back" href="../../../library/D3Field.html#epygram.fields.D3Field._D3CommonField.extractprofile">[docs]</a>    <span class="k">def</span> <span class="nf">extractprofile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span>
                       <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">,</span>
                       <span class="n">external_distance</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">exclude_extralevels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                       <span class="n">getdata</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extracts a vertical profile from the field, given</span>
<span class="sd">        the geographic location (*lon*/*lat*) of the profile.</span>

<span class="sd">        :param lon: the longitude of the desired point.</span>
<span class="sd">        :param lat: the latitude of the desired point.</span>
<span class="sd">          If both None, extract a horizontally-averaged profile.</span>
<span class="sd">        :param interpolation: defines the interpolation function used to compute</span>
<span class="sd">          the profile at requested lon/lat from the fields grid:\n</span>
<span class="sd">          - if &#39;nearest&#39; (default), extracts profile at the horizontal nearest neighboring gridpoint;</span>
<span class="sd">          - if &#39;linear&#39;, computes profile with horizontal linear spline interpolation;</span>
<span class="sd">          - if &#39;cubic&#39;, computes profile with horizontal cubic spline interpolation.</span>
<span class="sd">        :param external_distance: can be a dict containing the target point value</span>
<span class="sd">          and an external field on the same grid as self, to which the distance</span>
<span class="sd">          is computed within the 4 horizontally nearest points; e.g.</span>
<span class="sd">          {&#39;target_value&#39;:4810, &#39;external_field&#39;:an_H2DField_with_same_geometry}.</span>
<span class="sd">          If so, the nearest point is selected with</span>
<span class="sd">          distance = abs(target_value - external_field.data)</span>
<span class="sd">        :param exclude_extralevels: if True levels with no physical meaning are</span>
<span class="sd">                                    suppressed.</span>
<span class="sd">        :param getdata: if False returns a field without data</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pointG</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">make_profile_geometry</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">)</span>
        <span class="n">profile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_subdomain</span><span class="p">(</span><span class="n">pointG</span><span class="p">,</span>
                                         <span class="n">interpolation</span><span class="o">=</span><span class="n">interpolation</span><span class="p">,</span>
                                         <span class="n">external_distance</span><span class="o">=</span><span class="n">external_distance</span><span class="p">,</span>
                                         <span class="n">getdata</span><span class="o">=</span><span class="n">getdata</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">exclude_extralevels</span><span class="p">:</span>
            <span class="n">profile</span> <span class="o">=</span> <span class="n">profile</span><span class="o">.</span><span class="n">extract_physicallevels</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">profile</span></div>

<div class="viewcode-block" id="_D3CommonField.extractsection"><a class="viewcode-back" href="../../../library/D3Field.html#epygram.fields.D3Field._D3CommonField.extractsection">[docs]</a>    <span class="k">def</span> <span class="nf">extractsection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">end1</span><span class="p">,</span> <span class="n">end2</span><span class="p">,</span>
                       <span class="n">points_number</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">resolution</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span>
                       <span class="n">exclude_extralevels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                       <span class="n">getdata</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extracts a vertical section from the field, given</span>
<span class="sd">        the geographic (lon/lat) coordinates of its ends.</span>
<span class="sd">        The section is returned as a V2DField.</span>

<span class="sd">        :param end1: must be a tuple (lon, lat).</span>
<span class="sd">        :param end2: must be a tuple (lon, lat).</span>
<span class="sd">        :param points_number: defines the total number of horizontal points of the</span>
<span class="sd">          section (including ends). If None, defaults to a number computed from</span>
<span class="sd">          the *ends* and the *resolution*.</span>
<span class="sd">        :param resolution: defines the horizontal resolution to be given to the</span>
<span class="sd">          field. If None, defaults to the horizontal resolution of the field.</span>
<span class="sd">        :param interpolation: defines the interpolation function used to compute</span>
<span class="sd">          the profile points locations from the fields grid: \n</span>
<span class="sd">          - if &#39;nearest&#39;, each horizontal point of the section is</span>
<span class="sd">            taken as the horizontal nearest neighboring gridpoint;</span>
<span class="sd">          - if &#39;linear&#39; (default), each horizontal point of the section is</span>
<span class="sd">            computed with linear spline interpolation;</span>
<span class="sd">          - if &#39;cubic&#39;, each horizontal point of the section is</span>
<span class="sd">            computed with linear spline interpolation.</span>
<span class="sd">        :param exclude_extralevels: if True levels with no physical meaning are</span>
<span class="sd">                                    suppressed.</span>
<span class="sd">        :param getdata: if False returns a field without data</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sectionG</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">make_section_geometry</span><span class="p">(</span><span class="n">end1</span><span class="p">,</span> <span class="n">end2</span><span class="p">,</span>
                                                       <span class="n">points_number</span><span class="o">=</span><span class="n">points_number</span><span class="p">,</span>
                                                       <span class="n">resolution</span><span class="o">=</span><span class="n">resolution</span><span class="p">)</span>
        <span class="n">section</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_subdomain</span><span class="p">(</span><span class="n">sectionG</span><span class="p">,</span>
                                         <span class="n">interpolation</span><span class="o">=</span><span class="n">interpolation</span><span class="p">,</span>
                                         <span class="n">getdata</span><span class="o">=</span><span class="n">getdata</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">exclude_extralevels</span><span class="p">:</span>
            <span class="n">section</span> <span class="o">=</span> <span class="n">section</span><span class="o">.</span><span class="n">extract_physicallevels</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">section</span></div>

<div class="viewcode-block" id="_D3CommonField.extract_subdomain"><a class="viewcode-back" href="../../../library/D3Field.html#epygram.fields.D3Field._D3CommonField.extract_subdomain">[docs]</a>    <span class="k">def</span> <span class="nf">extract_subdomain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">geometry</span><span class="p">,</span>
                          <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">,</span>
                          <span class="n">external_distance</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                          <span class="n">getdata</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extracts a subdomain from a field, given a new geometry.</span>

<span class="sd">        :param geometry: defines the geometry on which extract data</span>
<span class="sd">        :param interpolation: defines the interpolation function used to compute</span>
<span class="sd">                              the profile at requested lon/lat from the fields</span>
<span class="sd">                              grid:\n</span>
<span class="sd">          - if &#39;nearest&#39; (default), extracts profile at the horizontal nearest</span>
<span class="sd">            neighboring gridpoint;</span>
<span class="sd">          - if &#39;linear&#39;, computes profile with horizontal linear interpolation;</span>
<span class="sd">          - if &#39;cubic&#39;, computes profile with horizontal cubic interpolation.</span>
<span class="sd">        :param external_distance: can be a dict containing the target point value</span>
<span class="sd">          and an external field on the same grid as self, to which the distance</span>
<span class="sd">          is computed within the 4 horizontally nearest points; e.g.</span>
<span class="sd">          {&#39;target_value&#39;:4810, &#39;external_field&#39;:an_H2DField_with_same_geometry}.</span>
<span class="sd">          If so, the nearest point is selected with</span>
<span class="sd">          distance = abs(target_value - external_field.data)</span>
<span class="sd">        :param getdata: if False returns a field without data</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># build subdomain fid</span>
        <span class="n">subdomainfid</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:(</span><span class="n">FPDict</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                             <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
                             <span class="k">else</span> <span class="n">value</span><span class="p">)</span>
                        <span class="k">for</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fid</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

        <span class="c1"># build vertical geometry</span>
        <span class="c1"># k_index: ordered list of the level indexes of self used to build the new field</span>
        <span class="n">kwargs_vcoord</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;structure&#39;</span><span class="p">:</span><span class="s1">&#39;V&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;typeoffirstfixedsurface&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">vcoordinate</span><span class="o">.</span><span class="n">typeoffirstfixedsurface</span><span class="p">,</span>
                         <span class="s1">&#39;position_on_grid&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">vcoordinate</span><span class="o">.</span><span class="n">position_on_grid</span><span class="p">}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">vcoordinate</span><span class="o">.</span><span class="n">typeoffirstfixedsurface</span> <span class="o">==</span> <span class="mi">119</span><span class="p">:</span>
            <span class="n">kwargs_vcoord</span><span class="p">[</span><span class="s1">&#39;grid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">vcoordinate</span><span class="o">.</span><span class="n">grid</span><span class="p">)</span>
            <span class="n">kwargs_vcoord</span><span class="p">[</span><span class="s1">&#39;levels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">vcoordinate</span><span class="o">.</span><span class="n">levels</span><span class="p">)</span>
            <span class="n">k_index</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">kwargs_vcoord</span><span class="p">[</span><span class="s1">&#39;levels&#39;</span><span class="p">]))</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">vcoordinate</span><span class="o">.</span><span class="n">typeoffirstfixedsurface</span> <span class="o">==</span> <span class="mi">118</span><span class="p">:</span>
            <span class="n">kwargs_vcoord</span><span class="p">[</span><span class="s1">&#39;grid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">vcoordinate</span><span class="o">.</span><span class="n">grid</span><span class="p">)</span>
            <span class="n">kwargs_vcoord</span><span class="p">[</span><span class="s1">&#39;levels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">vcoordinate</span><span class="o">.</span><span class="n">levels</span><span class="p">)</span>
            <span class="n">k_index</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">kwargs_vcoord</span><span class="p">[</span><span class="s1">&#39;levels&#39;</span><span class="p">])))</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">vcoordinate</span><span class="o">.</span><span class="n">typeoffirstfixedsurface</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">102</span><span class="p">,</span> <span class="mi">103</span><span class="p">,</span> <span class="mi">109</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">106</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">160</span><span class="p">,</span> <span class="mi">200</span><span class="p">]:</span>
            <span class="n">kwargs_vcoord</span><span class="p">[</span><span class="s1">&#39;levels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">vcoordinate</span><span class="o">.</span><span class="n">levels</span><span class="p">))</span>
            <span class="n">k_index</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">kwargs_vcoord</span><span class="p">[</span><span class="s1">&#39;levels&#39;</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;type of first surface level: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">vcoordinate</span><span class="o">.</span><span class="n">typeoffirstfixedsurface</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">geometry</span><span class="o">.</span><span class="n">vcoordinate</span><span class="o">.</span><span class="n">typeoffirstfixedsurface</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">255</span><span class="p">,</span> <span class="n">kwargs_vcoord</span><span class="p">[</span><span class="s1">&#39;typeoffirstfixedsurface&#39;</span><span class="p">]]:</span>
            <span class="k">raise</span> <span class="n">epygramError</span><span class="p">(</span><span class="s2">&quot;extract_subdomain cannot change vertical coordinate.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">geometry</span><span class="o">.</span><span class="n">vcoordinate</span><span class="o">.</span><span class="n">position_on_grid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;__unknown__&#39;</span><span class="p">,</span> <span class="n">kwargs_vcoord</span><span class="p">[</span><span class="s1">&#39;position_on_grid&#39;</span><span class="p">]]:</span>
            <span class="k">raise</span> <span class="n">epygramError</span><span class="p">(</span><span class="s2">&quot;extract_subdomain cannot change position on vertical grid.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">geometry</span><span class="o">.</span><span class="n">vcoordinate</span><span class="o">.</span><span class="n">grid</span> <span class="o">!=</span> <span class="p">{}</span> <span class="ow">and</span> <span class="n">geometry</span><span class="o">.</span><span class="n">vcoordinate</span><span class="o">.</span><span class="n">grid</span> <span class="o">!=</span> <span class="n">kwargs_vcoord</span><span class="p">[</span><span class="s1">&#39;grid&#39;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="n">epygramError</span><span class="p">(</span><span class="s2">&quot;extract_subdomain cannot change vertical grid&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">geometry</span><span class="o">.</span><span class="n">vcoordinate</span><span class="o">.</span><span class="n">levels</span> <span class="o">!=</span> <span class="p">[]:</span>
            <span class="n">k_index</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">level</span> <span class="ow">in</span> <span class="n">geometry</span><span class="o">.</span><span class="n">vcoordinate</span><span class="o">.</span><span class="n">levels</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">level</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs_vcoord</span><span class="p">[</span><span class="s1">&#39;levels&#39;</span><span class="p">]:</span>
                    <span class="k">raise</span> <span class="n">epygramError</span><span class="p">(</span><span class="s2">&quot;extract_subdomain cannot do vertical interpolations.&quot;</span><span class="p">)</span>
                <span class="n">k_index</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">vcoordinate</span><span class="o">.</span><span class="n">levels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">level</span><span class="p">))</span>
            <span class="n">kwargs_vcoord</span><span class="p">[</span><span class="s1">&#39;levels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">geometry</span><span class="o">.</span><span class="n">vcoordinate</span><span class="o">.</span><span class="n">levels</span>
        <span class="n">vcoordinate</span> <span class="o">=</span> <span class="n">fpx</span><span class="o">.</span><span class="n">geometry</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs_vcoord</span><span class="p">)</span>
        <span class="c1"># build geometry</span>
        <span class="n">structure</span> <span class="o">=</span> <span class="n">geometry</span><span class="o">.</span><span class="n">structure</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">kwargs_vcoord</span><span class="p">[</span><span class="s1">&#39;levels&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># We suppress the vertical dimension</span>
            <span class="n">structure</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;3D&#39;</span><span class="p">:</span><span class="s1">&#39;H2D&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;V1D&#39;</span><span class="p">:</span><span class="s1">&#39;Point&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;V2D&#39;</span><span class="p">:</span><span class="s1">&#39;H1D&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;H1D&#39;</span><span class="p">:</span><span class="s1">&#39;H1D&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;H2D&#39;</span><span class="p">:</span><span class="s1">&#39;H2D&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;Point&#39;</span><span class="p">:</span><span class="s1">&#39;Point&#39;</span><span class="p">}[</span><span class="n">structure</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># We add the vertical dimension</span>
            <span class="n">structure</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;H2D&#39;</span><span class="p">:</span><span class="s1">&#39;3D&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;Point&#39;</span><span class="p">:</span><span class="s1">&#39;V1D&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;H1D&#39;</span><span class="p">:</span><span class="s1">&#39;V2D&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;3D&#39;</span><span class="p">:</span><span class="s1">&#39;3D&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;V2D&#39;</span><span class="p">:</span><span class="s1">&#39;V2D&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;V1D&#39;</span><span class="p">:</span><span class="s1">&#39;V1D&#39;</span><span class="p">}[</span><span class="n">structure</span><span class="p">]</span>
        <span class="n">kwargs_geom</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;structure&#39;</span><span class="p">:</span> <span class="n">structure</span><span class="p">,</span>
                       <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">geometry</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                       <span class="s1">&#39;grid&#39;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">geometry</span><span class="o">.</span><span class="n">grid</span><span class="p">),</span>  <span class="c1"># do not remove dict(), it is usefull for unstructured grid</span>
                       <span class="s1">&#39;dimensions&#39;</span><span class="p">:</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">geometry</span><span class="o">.</span><span class="n">dimensions</span><span class="p">),</span>
                       <span class="s1">&#39;vcoordinate&#39;</span><span class="p">:</span> <span class="n">vcoordinate</span><span class="p">,</span>
                       <span class="s1">&#39;position_on_horizontal_grid&#39;</span><span class="p">:</span> <span class="s1">&#39;center&#39;</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">geometry</span><span class="o">.</span><span class="n">projected_geometry</span> <span class="ow">or</span> <span class="n">geometry</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;academic&#39;</span><span class="p">:</span>
            <span class="n">kwargs_geom</span><span class="p">[</span><span class="s1">&#39;projection&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">geometry</span><span class="o">.</span><span class="n">projection</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">geometry</span><span class="o">.</span><span class="n">geoid</span><span class="p">:</span>
            <span class="n">kwargs_geom</span><span class="p">[</span><span class="s1">&#39;geoid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">geometry</span><span class="o">.</span><span class="n">geoid</span>
        <span class="k">if</span> <span class="n">geometry</span><span class="o">.</span><span class="n">position_on_horizontal_grid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;__unknown__&#39;</span><span class="p">,</span> <span class="n">kwargs_geom</span><span class="p">[</span><span class="s1">&#39;position_on_horizontal_grid&#39;</span><span class="p">]]:</span>
            <span class="k">raise</span> <span class="n">epygramError</span><span class="p">(</span><span class="s2">&quot;extract_subdomain cannot deal with position_on_horizontal_grid other than &#39;center&#39;&quot;</span><span class="p">)</span>
        <span class="n">newgeometry</span> <span class="o">=</span> <span class="n">fpx</span><span class="o">.</span><span class="n">geometry</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs_geom</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">level</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="k">for</span> <span class="n">level</span> <span class="ow">in</span> <span class="n">newgeometry</span><span class="o">.</span><span class="n">vcoordinate</span><span class="o">.</span><span class="n">levels</span><span class="p">]):</span>
            <span class="c1"># level value is not constant on the domain, we must extract a subdomain.</span>
            <span class="c1"># We build a new field with same structure/geometry/validity as self</span>
            <span class="c1"># and we fill its data with the level values. We replace levels by index</span>
            <span class="c1"># in the geometry to stop recursion and use the extract_subdomain method</span>
            <span class="c1"># to get the level values on the new geometry levels.</span>
            <span class="n">temp_field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">vcoord_as_field</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">vcoordinate</span><span class="o">.</span><span class="n">typeoffirstfixedsurface</span><span class="p">,</span>
                                                       <span class="bp">self</span><span class="o">.</span><span class="n">validity</span><span class="p">)</span>
            <span class="n">temp_geom</span> <span class="o">=</span> <span class="n">geometry</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">()</span>
            <span class="k">del</span> <span class="n">temp_geom</span><span class="o">.</span><span class="n">vcoordinate</span><span class="o">.</span><span class="n">levels</span><span class="p">[:]</span>
            <span class="n">temp_geom</span><span class="o">.</span><span class="n">vcoordinate</span><span class="o">.</span><span class="n">levels</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">k_index</span><span class="p">)</span>  <span class="c1"># We extract only the requested levels</span>
            <span class="n">extracted</span> <span class="o">=</span> <span class="n">temp_field</span><span class="o">.</span><span class="n">extract_subdomain</span><span class="p">(</span><span class="n">temp_geom</span><span class="p">,</span>
                                                     <span class="n">interpolation</span><span class="o">=</span><span class="n">interpolation</span><span class="p">,</span>
                                                     <span class="n">external_distance</span><span class="o">=</span><span class="n">external_distance</span><span class="p">,</span>
                                                     <span class="n">getdata</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">d4</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">extracted</span> <span class="o">=</span> <span class="n">extracted</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># z first, then validity for levels (opposite of fields)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">validity</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># We keep all dims when validity is not unique</span>
                <span class="n">extracted</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">extracted</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># We suppress the validity dimension</span>
                <span class="n">extracted</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">extracted</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">])</span>
            <span class="k">del</span> <span class="n">newgeometry</span><span class="o">.</span><span class="n">vcoordinate</span><span class="o">.</span><span class="n">levels</span><span class="p">[:]</span>
            <span class="n">newgeometry</span><span class="o">.</span><span class="n">vcoordinate</span><span class="o">.</span><span class="n">levels</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">extracted</span><span class="p">)</span>
            <span class="k">del</span> <span class="n">temp_field</span><span class="p">,</span> <span class="n">temp_geom</span>

        <span class="c1"># location &amp; interpolation</span>
        <span class="n">lons</span><span class="p">,</span> <span class="n">lats</span> <span class="o">=</span> <span class="n">newgeometry</span><span class="o">.</span><span class="n">get_lonlat_grid</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lons</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">lons</span> <span class="o">=</span> <span class="n">stretch_array</span><span class="p">(</span><span class="n">lons</span><span class="p">)</span>
            <span class="n">lats</span> <span class="o">=</span> <span class="n">stretch_array</span><span class="p">(</span><span class="n">lats</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">numpy</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">point_is_inside_domain_ll</span><span class="p">(</span><span class="n">lons</span><span class="p">,</span> <span class="n">lats</span><span class="p">)):</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">)</span> <span class="ow">in</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nditer</span><span class="p">([</span><span class="n">lons</span><span class="p">,</span> <span class="n">lats</span><span class="p">]):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">point_is_inside_domain_ll</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;point (&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">lon</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;, &quot;</span> <span class="o">+</span>
                                     <span class="nb">str</span><span class="p">(</span><span class="n">lat</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;) is out of field domain.&quot;</span><span class="p">)</span>
        <span class="n">comment</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">interpolation</span> <span class="o">==</span> <span class="s1">&#39;nearest&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">lons</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">true_loc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">ij2ll</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">nearest_points</span><span class="p">(</span><span class="n">lons</span><span class="p">,</span> <span class="n">lats</span><span class="p">,</span>
                                                                             <span class="p">{</span><span class="s1">&#39;n&#39;</span><span class="p">:</span><span class="s1">&#39;1&#39;</span><span class="p">},</span>
                                                                             <span class="n">external_distance</span><span class="o">=</span><span class="n">external_distance</span><span class="p">))</span>
                <span class="n">distance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">distance</span><span class="p">((</span><span class="nb">float</span><span class="p">(</span><span class="n">lons</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">lats</span><span class="p">)),</span>
                                                  <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">true_loc</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                                                   <span class="nb">float</span><span class="p">(</span><span class="n">true_loc</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>
                <span class="n">az</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">azimuth</span><span class="p">((</span><span class="nb">float</span><span class="p">(</span><span class="n">lons</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">lats</span><span class="p">)),</span>
                                           <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">true_loc</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                                            <span class="nb">float</span><span class="p">(</span><span class="n">true_loc</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>
                <span class="k">if</span> <span class="o">-</span><span class="mf">22.5</span> <span class="o">&lt;</span> <span class="n">az</span> <span class="o">&lt;=</span> <span class="mf">22.5</span><span class="p">:</span>
                    <span class="n">direction</span> <span class="o">=</span> <span class="s1">&#39;N&#39;</span>
                <span class="k">elif</span> <span class="o">-</span><span class="mf">77.5</span> <span class="o">&lt;</span> <span class="n">az</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="mf">22.5</span><span class="p">:</span>
                    <span class="n">direction</span> <span class="o">=</span> <span class="s1">&#39;NW&#39;</span>
                <span class="k">elif</span> <span class="o">-</span><span class="mf">112.5</span> <span class="o">&lt;</span> <span class="n">az</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="mf">77.5</span><span class="p">:</span>
                    <span class="n">direction</span> <span class="o">=</span> <span class="s1">&#39;W&#39;</span>
                <span class="k">elif</span> <span class="o">-</span><span class="mf">157.5</span> <span class="o">&lt;</span> <span class="n">az</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="mf">112.5</span><span class="p">:</span>
                    <span class="n">direction</span> <span class="o">=</span> <span class="s1">&#39;SW&#39;</span>
                <span class="k">elif</span> <span class="o">-</span><span class="mf">180.5</span> <span class="o">&lt;=</span> <span class="n">az</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="mf">157.5</span> <span class="ow">or</span> <span class="mf">157.5</span> <span class="o">&lt;</span> <span class="n">az</span> <span class="o">&lt;=</span> <span class="mf">180.</span><span class="p">:</span>
                    <span class="n">direction</span> <span class="o">=</span> <span class="s1">&#39;S&#39;</span>
                <span class="k">elif</span> <span class="mf">22.5</span> <span class="o">&lt;</span> <span class="n">az</span> <span class="o">&lt;=</span> <span class="mf">77.5</span><span class="p">:</span>
                    <span class="n">direction</span> <span class="o">=</span> <span class="s1">&#39;NE&#39;</span>
                <span class="k">elif</span> <span class="mf">77.5</span> <span class="o">&lt;</span> <span class="n">az</span> <span class="o">&lt;=</span> <span class="mf">112.5</span><span class="p">:</span>
                    <span class="n">direction</span> <span class="o">=</span> <span class="s1">&#39;E&#39;</span>
                <span class="k">elif</span> <span class="mf">112.5</span> <span class="o">&lt;</span> <span class="n">az</span> <span class="o">&lt;=</span> <span class="mf">157.5</span><span class="p">:</span>
                    <span class="n">direction</span> <span class="o">=</span> <span class="s1">&#39;SE&#39;</span>
                <span class="n">gridpointstr</span> <span class="o">=</span> <span class="s2">&quot;(&quot;</span> <span class="o">+</span> \
                               <span class="s1">&#39;{:.</span><span class="si">{precision}{type}</span><span class="s1">}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">true_loc</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                                                              <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;F&#39;</span><span class="p">,</span>
                                                              <span class="n">precision</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span> <span class="o">+</span> \
                               <span class="s2">&quot;, &quot;</span> <span class="o">+</span> \
                               <span class="s1">&#39;{:.</span><span class="si">{precision}{type}</span><span class="s1">}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">true_loc</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                                                              <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;F&#39;</span><span class="p">,</span>
                                                              <span class="n">precision</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span> <span class="o">+</span> \
                               <span class="s2">&quot;)&quot;</span>
                <span class="n">comment</span> <span class="o">=</span> <span class="s2">&quot;Profile @ &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">distance</span><span class="p">))</span> <span class="o">+</span> <span class="s2">&quot;m &quot;</span> <span class="o">+</span> \
                          <span class="n">direction</span> <span class="o">+</span> <span class="s2">&quot; from &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">((</span><span class="nb">float</span><span class="p">(</span><span class="n">lons</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">lats</span><span class="p">)))</span> <span class="o">+</span> \
                          <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;( = nearest gridpoint: &quot;</span> <span class="o">+</span> <span class="n">gridpointstr</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span>
        <span class="k">elif</span> <span class="n">interpolation</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="s1">&#39;cubic&#39;</span><span class="p">,</span> <span class="s1">&#39;bilinear&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">interpolation</span> <span class="o">==</span> <span class="s1">&#39;linear&#39;</span><span class="p">:</span>
                <span class="n">interpstr</span> <span class="o">=</span> <span class="s1">&#39;linearly&#39;</span>
            <span class="k">elif</span> <span class="n">interpolation</span> <span class="o">==</span> <span class="s1">&#39;cubic&#39;</span><span class="p">:</span>
                <span class="n">interpstr</span> <span class="o">=</span> <span class="s1">&#39;cubically&#39;</span>
            <span class="k">elif</span> <span class="n">interpolation</span> <span class="o">==</span> <span class="s1">&#39;bilinear&#39;</span><span class="p">:</span>
                <span class="n">interpstr</span> <span class="o">=</span> <span class="s1">&#39;bilinearly&#39;</span>
            <span class="k">if</span> <span class="n">lons</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">comment</span> <span class="o">=</span> <span class="s2">&quot;Profile &quot;</span> <span class="o">+</span> <span class="n">interpstr</span> <span class="o">+</span> <span class="s2">&quot; interpolated @ &quot;</span> <span class="o">+</span> \
                          <span class="nb">str</span><span class="p">((</span><span class="nb">float</span><span class="p">(</span><span class="n">lons</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">lats</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="n">interpolation</span> <span class="o">+</span> <span class="s2">&quot; interpolation.&quot;</span><span class="p">)</span>

        <span class="c1"># Values</span>
        <span class="k">if</span> <span class="n">getdata</span><span class="p">:</span>
            <span class="n">shp</span> <span class="o">=</span> <span class="n">newgeometry</span><span class="o">.</span><span class="n">get_datashape</span><span class="p">(</span><span class="n">dimT</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">validity</span><span class="p">),</span> <span class="n">d4</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">(</span><span class="n">shp</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">validity</span><span class="p">)):</span>
                <span class="c1">#This is the old version, to delete later</span>
                <span class="c1">#for k in range(len(newgeometry.vcoordinate.levels)):</span>
                <span class="c1">#    # level = newgeometry.vcoordinate.levels[k]</span>
                <span class="c1">#    extracted = self.getvalue_ll(lons, lats,</span>
                <span class="c1">#                                 # level=level,  # equivalent to k=k_index[k] except that the k option</span>
                <span class="c1">#                                 k=k_index[k],  # still works when level is an array</span>
                <span class="c1">#                                 validity=self.validity[t],</span>
                <span class="c1">#                                 interpolation=interpolation,</span>
                <span class="c1">#                                 external_distance=external_distance,</span>
                <span class="c1">#                                 one=False)</span>
                <span class="c1">#    data[t, k, :, :] = newgeometry.reshape_data(extracted)</span>
                <span class="n">data</span><span class="p">[</span><span class="n">t</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getvalue_ll</span><span class="p">(</span><span class="n">as_numpy_array</span><span class="p">(</span><span class="n">lons</span><span class="p">)[</span><span class="n">numpy</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">k_index</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
                                                <span class="n">as_numpy_array</span><span class="p">(</span><span class="n">lats</span><span class="p">)[</span><span class="n">numpy</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">k_index</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
                                                <span class="n">k</span><span class="o">=</span><span class="n">as_numpy_array</span><span class="p">(</span><span class="n">k_index</span><span class="p">)</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">lons</span><span class="o">.</span><span class="n">size</span><span class="p">),</span>
                                                <span class="n">validity</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">validity</span><span class="p">[</span><span class="n">t</span><span class="p">],</span>
                                                <span class="n">interpolation</span><span class="o">=</span><span class="n">interpolation</span><span class="p">,</span>
                                                <span class="n">external_distance</span><span class="o">=</span><span class="n">external_distance</span><span class="p">,</span>
                                                <span class="n">one</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shp</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>

        <span class="c1"># Field</span>
        <span class="n">newfield</span> <span class="o">=</span> <span class="n">fpx</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">fid</span><span class="o">=</span><span class="n">FPDict</span><span class="p">(</span><span class="n">subdomainfid</span><span class="p">),</span>
                             <span class="n">structure</span><span class="o">=</span><span class="n">newgeometry</span><span class="o">.</span><span class="n">structure</span><span class="p">,</span>
                             <span class="n">geometry</span><span class="o">=</span><span class="n">newgeometry</span><span class="p">,</span>
                             <span class="n">validity</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">validity</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(),</span>
                             <span class="n">processtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">processtype</span><span class="p">,</span>
                             <span class="n">comment</span><span class="o">=</span><span class="n">comment</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">getdata</span><span class="p">:</span>
            <span class="n">newfield</span><span class="o">.</span><span class="n">setdata</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">newfield</span></div>


<div class="viewcode-block" id="_D3CommonField.extract_zoom"><a class="viewcode-back" href="../../../library/D3Field.html#epygram.fields.D3Field._D3CommonField.extract_zoom">[docs]</a>    <span class="k">def</span> <span class="nf">extract_zoom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zoom</span><span class="p">,</span> <span class="n">extra_10th</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extract an unstructured field with the gridpoints contained in *zoom*.</span>

<span class="sd">        :param zoom: a dict(lonmin=, lonmax=, latmin=, latmax=).</span>
<span class="sd">        :param extra_10th: if True, add 1/10th of the X/Y extension of the zoom</span>
<span class="sd">                           (regular_lonlat grid case only).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectral</span><span class="p">,</span> \
               <span class="s2">&quot;spectral field: convert to gridpoint beforehand&quot;</span>

        <span class="n">kwargs_zoomgeom</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;structure&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">structure</span><span class="p">,</span>
                           <span class="s1">&#39;vcoordinate&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">vcoordinate</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(),</span>
                           <span class="s1">&#39;position_on_horizontal_grid&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">position_on_horizontal_grid</span><span class="p">,</span>
                           <span class="s1">&#39;geoid&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">geoid</span><span class="p">}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;regular_lonlat&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">extra_10th</span><span class="p">:</span>
                <span class="n">dx</span> <span class="o">=</span> <span class="p">(</span><span class="n">degrees_nearest_mod</span><span class="p">(</span><span class="n">zoom</span><span class="p">[</span><span class="s1">&#39;lonmax&#39;</span><span class="p">],</span> <span class="mf">0.</span><span class="p">)</span> <span class="o">-</span>
                      <span class="n">degrees_nearest_mod</span><span class="p">(</span><span class="n">zoom</span><span class="p">[</span><span class="s1">&#39;lonmin&#39;</span><span class="p">],</span> <span class="mf">0.</span><span class="p">))</span> <span class="o">/</span> <span class="mf">10.</span>
                <span class="n">dy</span> <span class="o">=</span> <span class="p">(</span><span class="n">zoom</span><span class="p">[</span><span class="s1">&#39;latmax&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">zoom</span><span class="p">[</span><span class="s1">&#39;latmin&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="mf">10.</span>
                <span class="n">zoom</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;lonmin&#39;</span><span class="p">:</span><span class="n">zoom</span><span class="p">[</span><span class="s1">&#39;lonmin&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">dx</span><span class="p">,</span>
                        <span class="s1">&#39;lonmax&#39;</span><span class="p">:</span><span class="n">zoom</span><span class="p">[</span><span class="s1">&#39;lonmax&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">dx</span><span class="p">,</span>
                        <span class="s1">&#39;latmin&#39;</span><span class="p">:</span><span class="n">zoom</span><span class="p">[</span><span class="s1">&#39;latmin&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">dy</span><span class="p">,</span>
                        <span class="s1">&#39;latmax&#39;</span><span class="p">:</span><span class="n">zoom</span><span class="p">[</span><span class="s1">&#39;latmax&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">dy</span><span class="p">}</span>
            <span class="n">imin</span><span class="p">,</span> <span class="n">jmin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">ll2ij</span><span class="p">(</span><span class="n">zoom</span><span class="p">[</span><span class="s1">&#39;lonmin&#39;</span><span class="p">],</span> <span class="n">zoom</span><span class="p">[</span><span class="s1">&#39;latmin&#39;</span><span class="p">])</span>
            <span class="n">imax</span><span class="p">,</span> <span class="n">jmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">ll2ij</span><span class="p">(</span><span class="n">zoom</span><span class="p">[</span><span class="s1">&#39;lonmax&#39;</span><span class="p">],</span> <span class="n">zoom</span><span class="p">[</span><span class="s1">&#39;latmax&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">imin</span> <span class="o">&gt;</span> <span class="n">imax</span><span class="p">:</span>
                <span class="n">gridmin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">gimme_corners_ll</span><span class="p">()[</span><span class="s1">&#39;ll&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">diff_lonmin</span> <span class="o">=</span> <span class="p">(</span><span class="n">gridmin</span> <span class="o">-</span> <span class="n">degrees_nearest_mod</span><span class="p">(</span><span class="n">zoom</span><span class="p">[</span><span class="s1">&#39;lonmin&#39;</span><span class="p">],</span>
                                                             <span class="n">gridmin</span><span class="p">))</span>
                <span class="n">Xres</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">grid</span><span class="p">[</span><span class="s1">&#39;X_resolution&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;degrees&#39;</span><span class="p">)</span>
                <span class="n">shift</span> <span class="o">=</span> <span class="p">(</span><span class="n">diff_lonmin</span> <span class="o">//</span> <span class="n">Xres</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">Xres</span>
                <span class="n">shifted_self</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">()</span>
                <span class="n">shifted_self</span><span class="o">.</span><span class="n">global_shift_center</span><span class="p">(</span><span class="o">-</span><span class="n">shift</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">shifted_self</span><span class="o">.</span><span class="n">extract_zoom</span><span class="p">(</span><span class="n">zoom</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">imin</span> <span class="o">==</span> <span class="n">imax</span><span class="p">:</span>  <span class="c1"># means 360deg wide</span>
                <span class="n">imin</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">imax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="n">imin</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">imin</span><span class="p">)),</span>
                       <span class="mi">0</span><span class="p">)</span>
            <span class="n">imax</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">imax</span><span class="p">)),</span>
                       <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">jmin</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">jmin</span><span class="p">)),</span>
                       <span class="mi">0</span><span class="p">)</span>
            <span class="n">jmax</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">jmax</span><span class="p">)),</span>
                       <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="s1">&#39;Y&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">kwargs_zoomgeom</span><span class="p">[</span><span class="s1">&#39;dimensions&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;X&#39;</span><span class="p">:</span><span class="n">imax</span> <span class="o">-</span> <span class="n">imin</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                                             <span class="s1">&#39;Y&#39;</span><span class="p">:</span><span class="n">jmax</span> <span class="o">-</span> <span class="n">jmin</span> <span class="o">+</span> <span class="mi">1</span><span class="p">}</span>
            <span class="n">lonmin</span><span class="p">,</span> <span class="n">latmin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">ij2ll</span><span class="p">(</span><span class="n">imin</span><span class="p">,</span> <span class="n">jmin</span><span class="p">)</span>
            <span class="n">kwargs_zoomgeom</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">name</span>
            <span class="n">kwargs_zoomgeom</span><span class="p">[</span><span class="s1">&#39;grid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;input_position&#39;</span><span class="p">:(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                                       <span class="s1">&#39;input_lon&#39;</span><span class="p">:</span><span class="n">Angle</span><span class="p">(</span><span class="n">lonmin</span><span class="p">,</span> <span class="s1">&#39;degrees&#39;</span><span class="p">),</span>
                                       <span class="s1">&#39;input_lat&#39;</span><span class="p">:</span><span class="n">Angle</span><span class="p">(</span><span class="n">latmin</span><span class="p">,</span> <span class="s1">&#39;degrees&#39;</span><span class="p">),</span>
                                       <span class="s1">&#39;X_resolution&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">grid</span><span class="p">[</span><span class="s1">&#39;X_resolution&#39;</span><span class="p">],</span>
                                       <span class="s1">&#39;Y_resolution&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">grid</span><span class="p">[</span><span class="s1">&#39;Y_resolution&#39;</span><span class="p">]}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="p">(</span><span class="n">lons</span><span class="p">,</span> <span class="n">lats</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">get_lonlat_grid</span><span class="p">()</span>
            <span class="n">lons</span> <span class="o">=</span> <span class="n">lons</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="n">lats</span> <span class="o">=</span> <span class="n">lats</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="n">zoomlons</span> <span class="o">=</span> <span class="n">FPList</span><span class="p">([])</span>
            <span class="n">zoomlats</span> <span class="o">=</span> <span class="n">FPList</span><span class="p">([])</span>
            <span class="n">flat_indexes</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lons</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">zoom</span><span class="p">[</span><span class="s1">&#39;lonmin&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">lons</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">zoom</span><span class="p">[</span><span class="s1">&#39;lonmax&#39;</span><span class="p">]</span> <span class="ow">and</span> \
                   <span class="n">zoom</span><span class="p">[</span><span class="s1">&#39;latmin&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">lats</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">zoom</span><span class="p">[</span><span class="s1">&#39;latmax&#39;</span><span class="p">]:</span>
                    <span class="n">zoomlons</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lons</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                    <span class="n">zoomlats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lats</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                    <span class="n">flat_indexes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">zoomlons</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;zoom not in domain.&quot;</span>
            <span class="n">kwargs_zoomgeom</span><span class="p">[</span><span class="s1">&#39;dimensions&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;X&#39;</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">zoomlons</span><span class="p">),</span>
                                             <span class="s1">&#39;Y&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span>
            <span class="n">kwargs_zoomgeom</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;unstructured&#39;</span>
            <span class="n">kwargs_zoomgeom</span><span class="p">[</span><span class="s1">&#39;grid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;longitudes&#39;</span><span class="p">:</span><span class="n">zoomlons</span><span class="p">,</span>
                                       <span class="s1">&#39;latitudes&#39;</span><span class="p">:</span><span class="n">zoomlats</span><span class="p">}</span>
        <span class="n">zoom_geom</span> <span class="o">=</span> <span class="n">fpx</span><span class="o">.</span><span class="n">geometry</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs_zoomgeom</span><span class="p">)</span>
        <span class="c1"># Il serait mieux d&#39;utiliser</span>
        <span class="c1"># zoom_geom = self.geometry.make_zoom_geometry(zoom, extra_10th)</span>
        <span class="c1"># mais il faudrait s&#39;assurer d&#39;appliquer le global_shift_center de</span>
        <span class="c1"># la même manière sur la géométrie et sur le champ.</span>
        <span class="c1"># Le problème ne se poserait plus en utilisant extract_subdomain</span>

        <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">level</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="k">for</span> <span class="n">level</span> <span class="ow">in</span> <span class="n">zoom_geom</span><span class="o">.</span><span class="n">vcoordinate</span><span class="o">.</span><span class="n">levels</span><span class="p">]):</span>
            <span class="c1"># level value is not constant on the domain, we must extract a subdomain.</span>
            <span class="c1"># We build a new field with same structure/geometry/validity as self</span>
            <span class="c1"># and we fill its data with the level values. We replace levels by index</span>
            <span class="c1"># in the geometry to stop recursion and use the extract_subdomain method</span>
            <span class="c1"># to get the level values on the new geometry levels.</span>
            <span class="n">temp_field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">vcoord_as_field</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">vcoordinate</span><span class="o">.</span><span class="n">typeoffirstfixedsurface</span><span class="p">,</span>
                                                       <span class="bp">self</span><span class="o">.</span><span class="n">validity</span><span class="p">)</span>
            <span class="n">extracted</span> <span class="o">=</span> <span class="n">temp_field</span><span class="o">.</span><span class="n">extract_zoom</span><span class="p">(</span><span class="n">zoom</span><span class="p">,</span> <span class="n">extra_10th</span><span class="p">)</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">d4</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">extracted</span> <span class="o">=</span> <span class="n">extracted</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># z first, then validity for levels (opposite of fields)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">validity</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># We keep all dims when validity is not unique</span>
                <span class="n">extracted</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">extracted</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># We suppress the validity dimension</span>
                <span class="n">extracted</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">extracted</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">])</span>
            <span class="k">del</span> <span class="n">zoom_geom</span><span class="o">.</span><span class="n">vcoordinate</span><span class="o">.</span><span class="n">levels</span><span class="p">[:]</span>
            <span class="n">zoom_geom</span><span class="o">.</span><span class="n">vcoordinate</span><span class="o">.</span><span class="n">levels</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">extracted</span><span class="p">)</span>
            <span class="k">del</span> <span class="n">temp_field</span>

        <span class="c1"># Serait plus élégant mais pb d&#39;efficacité (2x plus lent)</span>
        <span class="c1"># car extract_subdomain fait une recherche des plus proches points:</span>
        <span class="c1"># zoom_field = self.extract_subdomain(zoom_geom)</span>
        <span class="c1"># zoom_field.fid = fid</span>
        
        <span class="n">shp</span> <span class="o">=</span> <span class="n">zoom_geom</span><span class="o">.</span><span class="n">get_datashape</span><span class="p">(</span><span class="n">dimT</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">validity</span><span class="p">),</span> <span class="n">d4</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">shp</span><span class="p">)</span>
        <span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">d4</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">validity</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">vcoordinate</span><span class="o">.</span><span class="n">levels</span><span class="p">)):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;regular_lonlat&#39;</span><span class="p">:</span>
                    <span class="n">data</span><span class="p">[</span><span class="n">t</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="n">t</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">jmin</span><span class="p">:</span><span class="n">jmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">imin</span><span class="p">:</span><span class="n">imax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">vals</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="n">t</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                    <span class="n">zoomvals</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">flat_indexes</span><span class="p">:</span>
                        <span class="n">zoomvals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                    <span class="n">data</span><span class="p">[</span><span class="n">t</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">zoomvals</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shp</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>

        <span class="n">fid</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fid</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">fid</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">fid</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">FPDict</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="n">zoom_field</span> <span class="o">=</span> <span class="n">fpx</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">fid</span><span class="o">=</span><span class="n">fid</span><span class="p">,</span>
                               <span class="n">structure</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">,</span>
                               <span class="n">geometry</span><span class="o">=</span><span class="n">zoom_geom</span><span class="p">,</span>
                               <span class="n">validity</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">validity</span><span class="p">,</span>
                               <span class="n">spectral_geometry</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                               <span class="n">processtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">processtype</span><span class="p">)</span>
        <span class="n">zoom_field</span><span class="o">.</span><span class="n">setdata</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">zoom_field</span></div>


    <span class="c1">#This method is intended to replace the extract_zoom one</span>
    <span class="c1">#but is still longer at execution</span>
    <span class="c1">#def _extract_zoom_with_subdo(self, zoom, extra_10th=False):</span>
    <span class="c1">#    &quot;&quot;&quot;</span>
    <span class="c1">#    Extract an unstructured field with the gridpoints contained in *zoom*.</span>
    <span class="c1">#</span>
    <span class="c1">#    :param zoom: a dict(lonmin=, lonmax=, latmin=, latmax=).</span>
    <span class="c1">#    :param extra_10th: if True, add 1/10th of the X/Y extension of the zoom</span>
    <span class="c1">#                       (regular_lonlat grid case only).</span>
    <span class="c1">#    &quot;&quot;&quot;</span>
    <span class="c1">#    assert not self.spectral, \</span>
    <span class="c1">#           &quot;spectral field: convert to gridpoint beforehand&quot;</span>
    <span class="c1">#</span>
    <span class="c1">#    zoom_geom = self.geometry.make_zoom_geometry(zoom, extra_10th)</span>
    <span class="c1">#    if any([isinstance(level, numpy.ndarray) for level in self.geometry.vcoordinate.levels]):</span>
    <span class="c1">#        del zoom_geom.vcoordinate.levels[:]</span>
    <span class="c1">#    zoom_field = self.extract_subdomain(zoom_geom, interpolation=&#39;nearest&#39;)</span>
    <span class="c1">#</span>
    <span class="c1">#    return zoom_field</span>

<div class="viewcode-block" id="_D3CommonField.extract_subarray"><a class="viewcode-back" href="../../../library/D3Field.html#epygram.fields.D3Field._D3CommonField.extract_subarray">[docs]</a>    <span class="k">def</span> <span class="nf">extract_subarray</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                         <span class="n">first_i</span><span class="p">,</span> <span class="n">last_i</span><span class="p">,</span>
                         <span class="n">first_j</span><span class="p">,</span> <span class="n">last_j</span><span class="p">,</span>
                         <span class="n">getdata</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                         <span class="n">deepcopy</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extract a rectangular sub-array from the field, given the i,j index limits</span>
<span class="sd">        of the sub-array, and return the extracted field.</span>
<span class="sd">        If deepcopy is False, current field and returned field will share</span>
<span class="sd">        some attributes (like validity).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">newgeom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">make_subarray_geometry</span><span class="p">(</span><span class="n">first_i</span><span class="p">,</span> <span class="n">last_i</span><span class="p">,</span>
                                                       <span class="n">first_j</span><span class="p">,</span> <span class="n">last_j</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">level</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="k">for</span> <span class="n">level</span> <span class="ow">in</span> <span class="n">newgeom</span><span class="o">.</span><span class="n">vcoordinate</span><span class="o">.</span><span class="n">levels</span><span class="p">]):</span>
            <span class="c1"># level value is not constant on the domain, we must extract a subdomain.</span>
            <span class="c1"># We build a new field with same structure/geometry/validity as self</span>
            <span class="c1"># and we fill its data with the level values. We replace levels by index</span>
            <span class="c1"># in the geometry to stop recursion and use the extract_subdomain method</span>
            <span class="c1"># to get the level values on the new geometry levels.</span>
            <span class="n">temp_field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">vcoord_as_field</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">vcoordinate</span><span class="o">.</span><span class="n">typeoffirstfixedsurface</span><span class="p">,</span>
                                                       <span class="bp">self</span><span class="o">.</span><span class="n">validity</span><span class="p">)</span>
            <span class="n">extracted</span> <span class="o">=</span> <span class="n">temp_field</span><span class="o">.</span><span class="n">extract_subarray</span><span class="p">(</span><span class="n">first_i</span><span class="p">,</span> <span class="n">last_i</span><span class="p">,</span>
                                                    <span class="n">first_j</span><span class="p">,</span> <span class="n">last_j</span><span class="p">,</span>
                                                    <span class="n">getdata</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                    <span class="n">deepcopy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">d4</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">extracted</span> <span class="o">=</span> <span class="n">extracted</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># z first, then validity for levels (opposite of fields)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">validity</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># We keep all dims when validity is not unique</span>
                <span class="n">extracted</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">extracted</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># We suppress null dims</span>
                <span class="n">extracted</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">extracted</span><span class="o">.</span><span class="n">squeeze</span><span class="p">())</span>
            <span class="k">del</span> <span class="n">newgeom</span><span class="o">.</span><span class="n">vcoordinate</span><span class="o">.</span><span class="n">levels</span><span class="p">[:]</span>
            <span class="n">newgeom</span><span class="o">.</span><span class="n">vcoordinate</span><span class="o">.</span><span class="n">levels</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">extracted</span><span class="p">)</span>
            <span class="k">del</span> <span class="n">temp_field</span>

        <span class="c1"># copy the field object and set the new geometry, then data</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;as_real_field&#39;</span><span class="p">):</span>
            <span class="n">field_kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">as_real_field</span><span class="p">()</span><span class="o">.</span><span class="n">_attributes</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">field_kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_attributes</span>
        <span class="k">if</span> <span class="n">deepcopy</span><span class="p">:</span>
            <span class="n">field_kwargs</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">field_kwargs</span><span class="p">)</span>
        <span class="n">field_kwargs</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">newgeom</span>
        <span class="n">newfield</span> <span class="o">=</span> <span class="n">fpx</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="o">**</span><span class="n">field_kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">getdata</span><span class="p">:</span>
            <span class="k">assert</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectral</span>
            <span class="c1"># select data</span>
            <span class="n">subdata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">d4</span><span class="o">=</span><span class="kc">True</span><span class="p">)[:,</span> <span class="p">:,</span> <span class="n">first_j</span><span class="p">:</span><span class="n">last_j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">first_i</span><span class="p">:</span><span class="n">last_i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">newfield</span><span class="o">.</span><span class="n">setdata</span><span class="p">(</span><span class="n">subdata</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">newfield</span></div>

<div class="viewcode-block" id="_D3CommonField.extract_subsample"><a class="viewcode-back" href="../../../library/D3Field.html#epygram.fields.D3Field._D3CommonField.extract_subsample">[docs]</a>    <span class="k">def</span> <span class="nf">extract_subsample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                          <span class="n">sample_x</span><span class="p">,</span> <span class="n">sample_y</span><span class="p">,</span> <span class="n">sample_z</span><span class="p">,</span>
                          <span class="n">getdata</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                          <span class="n">deepcopy</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extract a subsample from field by decreasing resolution.</span>
<span class="sd">        </span>
<span class="sd">        :param sample_x: take one over &lt;sample_x&gt; points in the x direction</span>
<span class="sd">        :param sample_y: same for the y direction</span>
<span class="sd">        :param sample_z: same for the z direction</span>
<span class="sd">        If deepcopy is False, current field and returned field will share</span>
<span class="sd">        some attributes (like validity).</span>

<span class="sd">        The extension zone of the original field is kept in the new field.</span>
<span class="sd">        Hence, it&#39;s recommended to call this method on field without extension zone.</span>

<span class="sd">        Because the resolution change during this operation, field must be</span>
<span class="sd">        localize on the grid center (use center method before if not).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">position_on_horizontal_grid</span> <span class="o">==</span> <span class="s1">&#39;center&#39;</span><span class="p">,</span> \
               <span class="s2">&quot;Field must be centered on the grid&quot;</span>

        <span class="n">newgeom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">make_subsample_geometry</span><span class="p">(</span><span class="n">sample_x</span><span class="p">,</span>
                                                        <span class="n">sample_y</span><span class="p">,</span>
                                                        <span class="n">sample_z</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">level</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="k">for</span> <span class="n">level</span> <span class="ow">in</span> <span class="n">newgeom</span><span class="o">.</span><span class="n">vcoordinate</span><span class="o">.</span><span class="n">levels</span><span class="p">]):</span>
            <span class="c1"># level value is not constant on the domain, we must extract a subdomain.</span>
            <span class="c1"># We build a new field with same structure/geometry/validity as self</span>
            <span class="c1"># and we fill its data with the level values. We replace levels by index</span>
            <span class="c1"># in the geometry to stop recursion and use the extract_subdomain method</span>
            <span class="c1"># to get the level values on the new geometry levels.</span>
            <span class="n">temp_field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">vcoord_as_field</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">vcoordinate</span><span class="o">.</span><span class="n">typeoffirstfixedsurface</span><span class="p">,</span>
                                                       <span class="bp">self</span><span class="o">.</span><span class="n">validity</span><span class="p">)</span>
            <span class="n">extracted</span> <span class="o">=</span> <span class="n">temp_field</span><span class="o">.</span><span class="n">extract_subsample</span><span class="p">(</span><span class="n">sample_x</span><span class="p">,</span> <span class="n">sample_y</span><span class="p">,</span> <span class="n">sample_z</span><span class="p">,</span>
                                                     <span class="n">getdata</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                     <span class="n">deepcopy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">d4</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">extracted</span> <span class="o">=</span> <span class="n">extracted</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># z first, then validity for levels (opposite of fields)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">validity</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># We keep all dims when validity is not unique</span>
                <span class="n">extracted</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">extracted</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># We suppress null dims</span>
                <span class="n">extracted</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">extracted</span><span class="o">.</span><span class="n">squeeze</span><span class="p">())</span>
            <span class="k">del</span> <span class="n">newgeom</span><span class="o">.</span><span class="n">vcoordinate</span><span class="o">.</span><span class="n">levels</span><span class="p">[:]</span>
            <span class="n">newgeom</span><span class="o">.</span><span class="n">vcoordinate</span><span class="o">.</span><span class="n">levels</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">extracted</span><span class="p">)</span>
            <span class="k">del</span> <span class="n">temp_field</span>
        
        <span class="c1"># copy the field object and set the new geometry, then data</span>
        <span class="n">field_kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_attributes</span>
        <span class="k">if</span> <span class="n">deepcopy</span><span class="p">:</span>
            <span class="n">field_kwargs</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">field_kwargs</span><span class="p">)</span>
        <span class="n">field_kwargs</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">newgeom</span>
        <span class="n">newfield</span> <span class="o">=</span> <span class="n">fpx</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="o">**</span><span class="n">field_kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">getdata</span><span class="p">:</span>
            <span class="k">assert</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectral</span>
            <span class="c1"># select data</span>
            <span class="n">subdata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">d4</span><span class="o">=</span><span class="kc">True</span><span class="p">)[:,</span> <span class="p">::</span><span class="n">sample_z</span><span class="p">,</span>
                                               <span class="p">::</span><span class="n">sample_y</span><span class="p">,</span>
                                               <span class="p">::</span><span class="n">sample_x</span><span class="p">]</span>
            <span class="n">newfield</span><span class="o">.</span><span class="n">setdata</span><span class="p">(</span><span class="n">subdata</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">newfield</span></div>

<div class="viewcode-block" id="_D3CommonField.shave"><a class="viewcode-back" href="../../../library/D3Field.html#epygram.fields.D3Field._D3CommonField.shave">[docs]</a>    <span class="k">def</span> <span class="nf">shave</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">minval</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">maxval</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Shave data: cut values greater (resp. lower) than **maxval** to</span>
<span class="sd">        **maxval** (resp. **minval**).</span>

<span class="sd">        :param maxval: upper threshold</span>
<span class="sd">        :param minval: lower threshold</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getdata</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">maxval</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">data</span> <span class="o">&gt;</span> <span class="n">maxval</span><span class="p">]</span> <span class="o">=</span> <span class="n">maxval</span>
            <span class="k">if</span> <span class="n">minval</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">data</span> <span class="o">&lt;</span> <span class="n">minval</span><span class="p">]</span> <span class="o">=</span> <span class="n">minval</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">maxval</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">data</span><span class="p">[</span><span class="n">data</span> <span class="o">&gt;</span> <span class="n">maxval</span><span class="p">]</span> <span class="o">=</span> <span class="n">maxval</span>
            <span class="k">if</span> <span class="n">minval</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">data</span><span class="p">[</span><span class="n">data</span> <span class="o">&lt;</span> <span class="n">minval</span><span class="p">]</span> <span class="o">=</span> <span class="n">minval</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span></div>

<div class="viewcode-block" id="_D3CommonField.resample"><a class="viewcode-back" href="../../../library/D3Field.html#epygram.fields.D3Field._D3CommonField.resample">[docs]</a>    <span class="k">def</span> <span class="nf">resample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_geometry</span><span class="p">,</span>
                 <span class="n">weighting</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">,</span>
                 <span class="n">subzone</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">neighbour_info</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="c1"># neighbouring options</span>
                 <span class="n">radius_of_influence</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">neighbours</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
                 <span class="n">epsilon</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                 <span class="n">reduce_data</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">nprocs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                 <span class="n">segments</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="c1"># resampling options</span>
                 <span class="n">fill_value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">sigma</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">with_uncert</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Resample data (interpolate) on a **target geometry**, using pyresample.</span>

<span class="sd">        :param weighting: among [&#39;nearest&#39;,</span>
<span class="sd">                                 &#39;gauss&#39; (in which case sigma can be specified,</span>
<span class="sd">                                          cf. sigma option below),</span>
<span class="sd">                                 lambda r:1/r**2 (or other function, r in m)]</span>
<span class="sd">        :param subzone: restrain source field to LAMzone in LAM geometry case</span>
<span class="sd">        :param neighbour_info: - if True: skips the resampling, only compute</span>
<span class="sd">                                          neighbours and return this</span>
<span class="sd">                                          information as a tuple;</span>
<span class="sd">                               - if given as a tuple, skips the computation of</span>
<span class="sd">                                 neighbours, taking those information</span>
<span class="sd">                                 given in argument (from a former call with</span>
<span class="sd">                                 neighbour_info=True)</span>

<span class="sd">        Options from pyresample, neighbouring:</span>

<span class="sd">        :param radius_of_influence: Cut off distance in meters, default value</span>
<span class="sd">                                    computed from geometry</span>
<span class="sd">        :param neighbours: The number of neigbours to consider for each grid</span>
<span class="sd">                           point</span>
<span class="sd">        :param epsilon: Allowed uncertainty in meters. Increasing uncertainty</span>
<span class="sd">                        reduces execution time</span>
<span class="sd">        :param reduce_data: Perform initial coarse reduction of source dataset</span>
<span class="sd">                            in order to reduce execution time</span>
<span class="sd">        :param nprocs: Number of processor cores to be used</span>
<span class="sd">        :param segments: Number of segments to use when resampling.</span>
<span class="sd">                         If set to None an estimate will be calculated</span>

<span class="sd">        Options from pyresample, resampling:</span>

<span class="sd">        :param fill_value: Set undetermined pixels to this value.</span>
<span class="sd">                           If fill_value is None a masked array is returned</span>
<span class="sd">                           with undetermined pixels masked</span>
<span class="sd">        :param sigma: sigma (in m) to use for the gauss weighting</span>
<span class="sd">                      w = exp(-dist^2/sigma^2)</span>
<span class="sd">                      Default is twice the resolution.</span>
<span class="sd">        :param with_uncert: Calculate uncertainty estimates (returned as side</span>
<span class="sd">                            fields)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectral</span><span class="p">,</span> <span class="s2">&quot;field must be gridpoint&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">pyresample.geometry</span> <span class="k">import</span> <span class="n">GridDefinition</span><span class="p">,</span> <span class="n">SwathDefinition</span>
            <span class="kn">from</span> <span class="nn">pyresample.kd_tree</span> <span class="k">import</span> <span class="p">(</span><span class="n">get_neighbour_info</span><span class="p">,</span>
                                            <span class="n">get_sample_from_neighbour_info</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;pyresample is not installed.</span>
<span class="s2">                                 You can install it locally using:</span><span class="se">\n</span><span class="s2"></span>
<span class="s2">                                 &#39;pip install --user pyresample&#39;&quot;&quot;&quot;</span><span class="p">)</span>
        <span class="c1"># PART 0: computation of parameters for PARTS 1 &amp; 2</span>
        <span class="n">lons</span><span class="p">,</span> <span class="n">lats</span> <span class="o">=</span> <span class="n">target_geometry</span><span class="o">.</span><span class="n">get_lonlat_grid</span><span class="p">(</span><span class="n">subzone</span><span class="o">=</span><span class="n">subzone</span><span class="p">,</span> <span class="n">d4</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nb_validities</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                                     <span class="n">force_longitudes</span><span class="o">=</span><span class="s1">&#39;]-180,180]&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;gauss&#39;</span> <span class="ow">in</span> <span class="n">target_geometry</span><span class="o">.</span><span class="n">name</span> <span class="ow">and</span> <span class="n">six</span><span class="o">.</span><span class="n">PY3</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Python3 issue: pyresample Gauss grid masked array&quot;</span><span class="p">)</span>  <span class="c1"># FIXME:</span>
            <span class="n">lons</span> <span class="o">=</span> <span class="n">target_geometry</span><span class="o">.</span><span class="n">horizontally_flattened</span><span class="p">(</span><span class="n">lons</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,:]</span>
            <span class="n">lons</span> <span class="o">=</span> <span class="n">lons</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">lons</span><span class="p">)))</span>
            <span class="n">lats</span> <span class="o">=</span> <span class="n">target_geometry</span><span class="o">.</span><span class="n">horizontally_flattened</span><span class="p">(</span><span class="n">lats</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,:]</span>
            <span class="n">lats</span> <span class="o">=</span> <span class="n">lons</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">lats</span><span class="p">)))</span>
            <span class="n">target_geo</span> <span class="o">=</span> <span class="n">SwathDefinition</span><span class="p">(</span><span class="n">lons</span><span class="p">,</span> <span class="n">lats</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lons</span> <span class="o">=</span> <span class="n">lons</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
            <span class="n">lats</span> <span class="o">=</span> <span class="n">lats</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
            <span class="n">target_geo</span> <span class="o">=</span> <span class="n">GridDefinition</span><span class="p">(</span><span class="n">lons</span><span class="p">,</span> <span class="n">lats</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">_resolution</span><span class="p">():</span>
            <span class="k">if</span> <span class="s1">&#39;gauss&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                <span class="c1"># gauss grid case</span>
                <span class="n">resolution</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">resolution_j</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="s1">&#39;lat_number&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;regular_lonlat&#39;</span><span class="p">,</span> <span class="s1">&#39;unstructured&#39;</span><span class="p">):</span>
                <span class="n">resolution</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">resolution_ij</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
                                                         <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="s1">&#39;Y&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">resolution</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;X_resolution&#39;</span><span class="p">)</span> <span class="o">+</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Y_resolution&#39;</span><span class="p">))</span> <span class="o">/</span> <span class="mf">2.</span>
            <span class="k">return</span> <span class="n">resolution</span>

        <span class="c1"># PART 1: computation of neighbours</span>
        <span class="k">if</span> <span class="n">neighbour_info</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="n">lons</span><span class="p">,</span> <span class="n">lats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">get_lonlat_grid</span><span class="p">(</span><span class="n">subzone</span><span class="o">=</span><span class="n">subzone</span><span class="p">,</span> <span class="n">d4</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nb_validities</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                                       <span class="n">force_longitudes</span><span class="o">=</span><span class="s1">&#39;]-180,180]&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;gauss&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">name</span> <span class="ow">and</span> <span class="n">six</span><span class="o">.</span><span class="n">PY3</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Python3 issue: pyresample Gauss grid masked array&quot;</span><span class="p">)</span>  <span class="c1"># FIXME:</span>
                <span class="n">lons</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">horizontally_flattened</span><span class="p">(</span><span class="n">lons</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,:]</span>
                <span class="n">lons</span> <span class="o">=</span> <span class="n">lons</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">lons</span><span class="p">)))</span>
                <span class="n">lats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">horizontally_flattened</span><span class="p">(</span><span class="n">lats</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,:]</span>
                <span class="n">lats</span> <span class="o">=</span> <span class="n">lons</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">lats</span><span class="p">)))</span>
                <span class="n">source_geo</span> <span class="o">=</span> <span class="n">SwathDefinition</span><span class="p">(</span><span class="n">lons</span><span class="p">,</span> <span class="n">lats</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lons</span> <span class="o">=</span> <span class="n">lons</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,:,:]</span>
                <span class="n">lats</span> <span class="o">=</span> <span class="n">lats</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,:,:]</span>
                <span class="n">source_geo</span> <span class="o">=</span> <span class="n">GridDefinition</span><span class="p">(</span><span class="n">lons</span><span class="p">,</span> <span class="n">lats</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">radius_of_influence</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">radius_of_influence</span> <span class="o">=</span> <span class="mf">4.</span> <span class="o">*</span> <span class="n">_resolution</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">weighting</span> <span class="o">==</span> <span class="s1">&#39;nearest&#39;</span><span class="p">:</span>
                <span class="n">neighbours</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="p">(</span><span class="n">valid_input_index</span><span class="p">,</span>
             <span class="n">valid_output_index</span><span class="p">,</span>
             <span class="n">index_array</span><span class="p">,</span>
             <span class="n">distance_array</span><span class="p">)</span> <span class="o">=</span> <span class="n">get_neighbour_info</span><span class="p">(</span><span class="n">source_geo</span><span class="p">,</span>
                                                  <span class="n">target_geo</span><span class="p">,</span>
                                                  <span class="n">radius_of_influence</span><span class="o">=</span><span class="n">radius_of_influence</span><span class="p">,</span>
                                                  <span class="n">neighbours</span><span class="o">=</span><span class="n">neighbours</span><span class="p">,</span>
                                                  <span class="n">epsilon</span><span class="o">=</span><span class="n">epsilon</span><span class="p">,</span>
                                                  <span class="n">reduce_data</span><span class="o">=</span><span class="n">reduce_data</span><span class="p">,</span>
                                                  <span class="n">nprocs</span><span class="o">=</span><span class="n">nprocs</span><span class="p">,</span>
                                                  <span class="n">segments</span><span class="o">=</span><span class="n">segments</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">neighbour_info</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">valid_input_index</span><span class="p">,</span>
                        <span class="n">valid_output_index</span><span class="p">,</span>
                        <span class="n">index_array</span><span class="p">,</span>
                        <span class="n">distance_array</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># neighbour_info is given: tuple of information about neighbours</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">neighbour_info</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span>
            <span class="p">(</span><span class="n">valid_input_index</span><span class="p">,</span>
             <span class="n">valid_output_index</span><span class="p">,</span>
             <span class="n">index_array</span><span class="p">,</span>
             <span class="n">distance_array</span><span class="p">)</span> <span class="o">=</span> <span class="n">neighbour_info</span>
        <span class="c1"># PART 2: computation of resampling</span>
        <span class="k">if</span> <span class="s1">&#39;gauss&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">name</span> <span class="ow">and</span> <span class="n">six</span><span class="o">.</span><span class="n">PY3</span><span class="p">:</span>
            <span class="n">source_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">horizontally_flattened</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">d4</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
            <span class="n">shp</span> <span class="o">=</span> <span class="p">(</span><span class="n">source_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">source_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="n">source_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">source_data</span> <span class="o">=</span> <span class="n">source_data</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shp</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">source_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">d4</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">subzone</span><span class="o">=</span><span class="n">subzone</span><span class="p">)</span>
        <span class="n">resampled_data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">source_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>  <span class="c1"># t</span>
                                         <span class="n">source_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>  <span class="c1"># z</span>
                                         <span class="n">target_geo</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>  <span class="c1"># y</span>
                                         <span class="n">target_geo</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>  <span class="c1"># x</span>
        <span class="k">if</span> <span class="n">with_uncert</span><span class="p">:</span>
            <span class="n">stddev</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">source_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>  <span class="c1"># t</span>
                                     <span class="n">source_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>  <span class="c1"># z</span>
                                     <span class="n">target_geo</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>  <span class="c1"># y</span>
                                     <span class="n">target_geo</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>  <span class="c1"># x</span>
            <span class="n">counts</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">source_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>  <span class="c1"># t</span>
                                     <span class="n">source_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>  <span class="c1"># z</span>
                                     <span class="n">target_geo</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>  <span class="c1"># y</span>
                                     <span class="n">target_geo</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>  <span class="c1"># x</span>
        <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">weighting</span><span class="p">):</span>  <span class="c1"># custom: weighting function</span>
            <span class="n">weight_funcs</span> <span class="o">=</span> <span class="n">weighting</span>
            <span class="n">weighting</span> <span class="o">=</span> <span class="s1">&#39;custom&#39;</span>
        <span class="k">elif</span> <span class="n">weighting</span> <span class="o">==</span> <span class="s1">&#39;nearest&#39;</span><span class="p">:</span>
            <span class="n">weighting</span> <span class="o">=</span> <span class="s1">&#39;nn&#39;</span>
            <span class="n">weight_funcs</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="n">weighting</span> <span class="o">==</span> <span class="s1">&#39;gauss&#39;</span><span class="p">:</span>

            <span class="k">def</span> <span class="nf">gauss</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
                <span class="k">return</span> <span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">r</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">s</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

            <span class="n">weighting</span> <span class="o">=</span> <span class="s1">&#39;custom&#39;</span>
            <span class="k">if</span> <span class="n">sigma</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">sigma</span> <span class="o">=</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">_resolution</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sigma</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span>
            <span class="n">weight_funcs</span> <span class="o">=</span> <span class="n">gauss</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">epygramError</span><span class="p">(</span><span class="s2">&quot;unknown weighting=&#39;&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">weighting</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">source_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">source_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">rdata</span> <span class="o">=</span> <span class="n">get_sample_from_neighbour_info</span><span class="p">(</span><span class="n">weighting</span><span class="p">,</span>
                                                       <span class="n">target_geo</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
                                                       <span class="n">source_data</span><span class="p">[</span><span class="n">t</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span>
                                                       <span class="n">valid_input_index</span><span class="p">,</span>
                                                       <span class="n">valid_output_index</span><span class="p">,</span>
                                                       <span class="n">index_array</span><span class="p">,</span>
                                                       <span class="n">distance_array</span><span class="p">,</span>
                                                       <span class="n">weight_funcs</span><span class="o">=</span><span class="n">weight_funcs</span><span class="p">,</span>
                                                       <span class="n">fill_value</span><span class="o">=</span><span class="n">fill_value</span><span class="p">,</span>
                                                       <span class="n">with_uncert</span><span class="o">=</span><span class="n">with_uncert</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">with_uncert</span><span class="p">:</span>
                    <span class="n">resampled_data</span><span class="p">[</span><span class="n">t</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">rdata</span><span class="p">[</span><span class="mi">0</span><span class="p">][:,</span> <span class="p">:]</span>
                    <span class="n">stddev</span><span class="p">[</span><span class="n">t</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">rdata</span><span class="p">[</span><span class="mi">1</span><span class="p">][:,</span> <span class="p">:]</span>
                    <span class="n">counts</span><span class="p">[</span><span class="n">t</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">rdata</span><span class="p">[</span><span class="mi">2</span><span class="p">][:,</span> <span class="p">:]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">resampled_data</span><span class="p">[</span><span class="n">t</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">rdata</span><span class="p">[:,</span> <span class="p">:]</span>

        <span class="c1"># build final field</span>
        <span class="n">field_kwargs</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_attributes</span><span class="p">)</span>
        <span class="n">field_kwargs</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">target_geometry</span>
        <span class="n">newfield</span> <span class="o">=</span> <span class="n">fpx</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="o">**</span><span class="n">field_kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">resampled_data</span><span class="o">.</span><span class="n">mask</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="n">resampled_data</span> <span class="o">=</span> <span class="n">resampled_data</span><span class="o">.</span><span class="n">data</span>
        <span class="k">if</span> <span class="s1">&#39;gauss&#39;</span> <span class="ow">in</span> <span class="n">target_geometry</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
            <span class="n">resampled_data</span> <span class="o">=</span> <span class="n">target_geometry</span><span class="o">.</span><span class="n">reshape_data</span><span class="p">(</span><span class="n">resampled_data</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">,:])</span>
        <span class="n">newfield</span><span class="o">.</span><span class="n">setdata</span><span class="p">(</span><span class="n">resampled_data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">with_uncert</span><span class="p">:</span>
            <span class="n">stddev_field</span> <span class="o">=</span> <span class="n">newfield</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">()</span>
            <span class="n">stddev_field</span><span class="o">.</span><span class="n">setdata</span><span class="p">(</span><span class="n">stddev</span><span class="p">)</span>
            <span class="n">stddev_field</span><span class="o">.</span><span class="n">comment</span> <span class="o">+=</span> <span class="s1">&#39;:stddev_from_resampling&#39;</span>
            <span class="n">counts_field</span> <span class="o">=</span> <span class="n">newfield</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">()</span>
            <span class="n">counts_field</span><span class="o">.</span><span class="n">setdata</span><span class="p">(</span><span class="n">counts</span><span class="p">)</span>
            <span class="n">stddev_field</span><span class="o">.</span><span class="n">comment</span> <span class="o">+=</span> <span class="s1">&#39;:number_of_points_from_resampling&#39;</span>
            <span class="k">return</span> <span class="n">newfield</span><span class="p">,</span> <span class="n">stddev_field</span><span class="p">,</span> <span class="n">counts_field</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">newfield</span></div>

<div class="viewcode-block" id="_D3CommonField.resample_on_regularll"><a class="viewcode-back" href="../../../library/D3Field.html#epygram.fields.D3Field._D3CommonField.resample_on_regularll">[docs]</a>    <span class="k">def</span> <span class="nf">resample_on_regularll</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">borders</span><span class="p">,</span> <span class="n">resolution_in_degrees</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Resample data (interpolate) on a target geometry defined as a</span>
<span class="sd">        regular lonlat grid of given resolution.</span>
<span class="sd">        Wrapper to resample() method, building target geometry.</span>

<span class="sd">        :param dict borders: dict(lonmin=, latmin=, lonmax=, latmax=)</span>
<span class="sd">        :param resolution_in_degrees: resolution of the lonlat grid in degrees.</span>
<span class="sd">                                      Supposed to be a divisor of lonmax-lonmin</span>
<span class="sd">                                      and latmax-latmin.</span>

<span class="sd">        Other kwargs to be passed to resample() method.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">DX</span> <span class="o">=</span> <span class="n">borders</span><span class="p">[</span><span class="s1">&#39;lonmax&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">borders</span><span class="p">[</span><span class="s1">&#39;lonmin&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">DX</span> <span class="o">&lt;</span> <span class="mf">0.</span><span class="p">:</span>
            <span class="n">DX</span> <span class="o">+=</span> <span class="mf">360.</span> 
        <span class="n">DY</span> <span class="o">=</span> <span class="n">borders</span><span class="p">[</span><span class="s1">&#39;latmax&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">borders</span><span class="p">[</span><span class="s1">&#39;latmin&#39;</span><span class="p">]</span>
        <span class="n">X</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">DX</span> <span class="o">/</span> <span class="n">resolution_in_degrees</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">Y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">DY</span> <span class="o">/</span> <span class="n">resolution_in_degrees</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">grid</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;input_position&#39;</span><span class="p">:(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                <span class="s1">&#39;input_lon&#39;</span><span class="p">:</span><span class="n">Angle</span><span class="p">(</span><span class="n">borders</span><span class="p">[</span><span class="s1">&#39;lonmin&#39;</span><span class="p">],</span> <span class="s1">&#39;degrees&#39;</span><span class="p">),</span>
                <span class="s1">&#39;input_lat&#39;</span><span class="p">:</span><span class="n">Angle</span><span class="p">(</span><span class="n">borders</span><span class="p">[</span><span class="s1">&#39;latmin&#39;</span><span class="p">],</span> <span class="s1">&#39;degrees&#39;</span><span class="p">),</span>
                <span class="s1">&#39;X_resolution&#39;</span><span class="p">:</span><span class="n">Angle</span><span class="p">(</span><span class="n">resolution_in_degrees</span><span class="p">,</span> <span class="s1">&#39;degrees&#39;</span><span class="p">),</span>
                <span class="s1">&#39;Y_resolution&#39;</span><span class="p">:</span><span class="n">Angle</span><span class="p">(</span><span class="n">resolution_in_degrees</span><span class="p">,</span> <span class="s1">&#39;degrees&#39;</span><span class="p">)}</span>
        <span class="n">target_geometry</span> <span class="o">=</span> <span class="n">fpx</span><span class="o">.</span><span class="n">geometry</span><span class="p">(</span><span class="n">structure</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">structure</span><span class="p">,</span>
                                       <span class="n">name</span><span class="o">=</span><span class="s1">&#39;regular_lonlat&#39;</span><span class="p">,</span>
                                       <span class="n">vcoordinate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">vcoordinate</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(),</span>
                                       <span class="n">dimensions</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;X&#39;</span><span class="p">:</span><span class="n">X</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">:</span><span class="n">Y</span><span class="p">},</span>
                                       <span class="n">grid</span><span class="o">=</span><span class="n">grid</span><span class="p">,</span>
                                       <span class="n">position_on_horizontal_grid</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
                                       <span class="n">geoid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">geoid</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">target_geometry</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="_D3CommonField.extend"><a class="viewcode-back" href="../../../library/D3Field.html#epygram.fields.D3Field._D3CommonField.extend">[docs]</a>    <span class="k">def</span> <span class="nf">extend</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">another_field_with_time_dimension</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extend the field with regard to time dimension with the field given as</span>
<span class="sd">        argument.</span>

<span class="sd">        Be careful no check is done for consistency between the two fields</span>
<span class="sd">        geometry (except that dimensions match) nor their validities.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">another</span> <span class="o">=</span> <span class="n">another_field_with_time_dimension</span>
        <span class="n">d1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">d4</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">d2</span> <span class="o">=</span> <span class="n">another</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">d4</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">d1</span><span class="p">,</span> <span class="n">d2</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validity</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">another</span><span class="o">.</span><span class="n">validity</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setdata</span><span class="p">(</span><span class="n">d</span><span class="p">)</span></div>

<div class="viewcode-block" id="_D3CommonField.remove_level"><a class="viewcode-back" href="../../../library/D3Field.html#epygram.fields.D3Field._D3CommonField.remove_level">[docs]</a>    <span class="k">def</span> <span class="nf">remove_level</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove one level from the current field</span>
<span class="sd">        :param k: index of the level to remove</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">vcoordinate</span><span class="o">.</span><span class="n">levels</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setdata</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">d4</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">k</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span></div>

<div class="viewcode-block" id="_D3CommonField.decumulate"><a class="viewcode-back" href="../../../library/D3Field.html#epygram.fields.D3Field._D3CommonField.decumulate">[docs]</a>    <span class="k">def</span> <span class="nf">decumulate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Decumulate cumulated fields (for a field with temporal dimension !).</span>

<span class="sd">        :param center: - if False, values at t are mean values between t-1 and t,</span>
<span class="sd">                         except at t=0 where it remains untouched.</span>
<span class="sd">                       - if True, values at t are then (v[t-1, t] + v[t,t+1])/2.,</span>
<span class="sd">                         except for t=0 where it becomes v[0, 1]</span>
<span class="sd">                         and t=last where it remains the same.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">validity</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">d4</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="o">...</span><span class="p">]</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">center</span><span class="p">:</span>
                <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>  <span class="c1"># the actual mean between 0 and 1</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">validity</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">+</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">:,</span> <span class="o">...</span><span class="p">])</span> <span class="o">/</span> <span class="mf">2.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setdata</span><span class="p">(</span><span class="n">data</span><span class="p">)</span></div>

<div class="viewcode-block" id="_D3CommonField.time_smooth"><a class="viewcode-back" href="../../../library/D3Field.html#epygram.fields.D3Field._D3CommonField.time_smooth">[docs]</a>    <span class="k">def</span> <span class="nf">time_smooth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Smooth data in time.</span>

<span class="sd">        :param length: time span to average on</span>
<span class="sd">        :param window: replace data[t] by:\n</span>
<span class="sd">          - data[t-length/2:t+length/2].mean() if &#39;center&#39;;</span>
<span class="sd">          - data[t-length:t].mean() if &#39;left&#39;;</span>
<span class="sd">          - data[t:t+length/2].mean() if &#39;right&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">validity</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">d4</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">window</span> <span class="o">==</span> <span class="s1">&#39;center&#39;</span><span class="p">:</span>
            <span class="n">tinf</span> <span class="o">=</span> <span class="n">length</span> <span class="o">//</span> <span class="mi">2</span>
            <span class="n">tsup</span> <span class="o">=</span> <span class="n">length</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="k">elif</span> <span class="n">window</span> <span class="o">==</span> <span class="s1">&#39;left&#39;</span><span class="p">:</span>
            <span class="n">tinf</span> <span class="o">=</span> <span class="n">length</span>
            <span class="n">tsup</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">elif</span> <span class="n">window</span> <span class="o">==</span> <span class="s1">&#39;right&#39;</span><span class="p">:</span>
            <span class="n">tinf</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">tsup</span> <span class="o">=</span> <span class="n">length</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">validity</span><span class="p">)):</span>
            <span class="n">t9</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">t</span> <span class="o">-</span> <span class="n">tinf</span><span class="p">)</span>
            <span class="n">t1</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">validity</span><span class="p">),</span> <span class="n">t</span> <span class="o">+</span> <span class="n">tsup</span><span class="p">)</span>
            <span class="n">data</span><span class="p">[</span><span class="n">t</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">d4</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="n">t9</span><span class="p">:</span><span class="n">t1</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setdata</span><span class="p">(</span><span class="n">data</span><span class="p">)</span></div>

<div class="viewcode-block" id="_D3CommonField.time_reduce"><a class="viewcode-back" href="../../../library/D3Field.html#epygram.fields.D3Field._D3CommonField.time_reduce">[docs]</a>    <span class="k">def</span> <span class="nf">time_reduce</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reduce_function</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make a time reduction of field,</span>
<span class="sd">        i.e. apply the requested **reduce_function** on the time dimension of</span>
<span class="sd">        the field. Replace data (and validity) in place.</span>

<span class="sd">        :param reduce_function: must be a numpy.ndarray method,</span>
<span class="sd">                                e.g. &#39;mean&#39;, &#39;sum&#39;, &#39;min&#39;, &#39;max&#39;, ...</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">d4</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">reduce_function</span><span class="p">),</span> <span class="s1">&#39;unknown method:</span><span class="si">{}</span><span class="s1"> for numpy arrays&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">reduce_function</span><span class="p">)</span>
        <span class="n">reduced</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">reduce_function</span><span class="p">)(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">validity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validity</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">()</span>
        <span class="n">validity</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">cumulativeduration</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">validity</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">-</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">validity</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span>
                     <span class="n">statistical_process_on_duration</span><span class="o">=</span><span class="n">reduce_function</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validity</span> <span class="o">=</span> <span class="n">validity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setdata</span><span class="p">(</span><span class="n">reduced</span><span class="o">.</span><span class="n">squeeze</span><span class="p">())</span></div>

<span class="c1">###################</span>
<span class="c1"># PRE-APPLICATIVE #</span>
<span class="c1">###################</span>
<span class="c1"># (but useful and rather standard) !</span>
<span class="c1"># [so that, subject to continuation through updated versions,</span>
<span class="c1">#  including suggestions/developments by users...]</span>

<div class="viewcode-block" id="_D3CommonField.stats"><a class="viewcode-back" href="../../../library/D3Field.html#epygram.fields.D3Field._D3CommonField.stats">[docs]</a>    <span class="k">def</span> <span class="nf">stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subzone</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes some basic statistics on the field, as a dict containing:</span>
<span class="sd">        {&#39;min&#39;, &#39;max&#39;, &#39;mean&#39;, &#39;std&#39;, &#39;quadmean&#39;, &#39;nonzero&#39;}.</span>
<span class="sd">        See each of these methods for details.</span>

<span class="sd">        :param subzone: optional, among (&#39;C&#39;, &#39;CI&#39;), for LAM fields only, plots</span>
<span class="sd">                        the data resp. on the C or C+I zone.</span>
<span class="sd">                        Default is no subzone, i.e. the whole field.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;min&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">subzone</span><span class="o">=</span><span class="n">subzone</span><span class="p">),</span>
                <span class="s1">&#39;max&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">subzone</span><span class="o">=</span><span class="n">subzone</span><span class="p">),</span>
                <span class="s1">&#39;mean&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">subzone</span><span class="o">=</span><span class="n">subzone</span><span class="p">),</span>
                <span class="s1">&#39;std&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">subzone</span><span class="o">=</span><span class="n">subzone</span><span class="p">),</span>
                <span class="s1">&#39;quadmean&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">quadmean</span><span class="p">(</span><span class="n">subzone</span><span class="o">=</span><span class="n">subzone</span><span class="p">),</span>
                <span class="s1">&#39;nonzero&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">subzone</span><span class="o">=</span><span class="n">subzone</span><span class="p">)}</span></div>

<div class="viewcode-block" id="_D3CommonField.min"><a class="viewcode-back" href="../../../library/D3Field.html#epygram.fields.D3Field._D3CommonField.min">[docs]</a>    <span class="k">def</span> <span class="nf">min</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subzone</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the minimum value of data.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">_D3CommonField</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">subzone</span><span class="o">=</span><span class="n">subzone</span><span class="p">)</span></div>

<div class="viewcode-block" id="_D3CommonField.max"><a class="viewcode-back" href="../../../library/D3Field.html#epygram.fields.D3Field._D3CommonField.max">[docs]</a>    <span class="k">def</span> <span class="nf">max</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subzone</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the maximum value of data.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">_D3CommonField</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">subzone</span><span class="o">=</span><span class="n">subzone</span><span class="p">)</span></div>

<div class="viewcode-block" id="_D3CommonField.mean"><a class="viewcode-back" href="../../../library/D3Field.html#epygram.fields.D3Field._D3CommonField.mean">[docs]</a>    <span class="k">def</span> <span class="nf">mean</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subzone</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the mean value of data.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">_D3CommonField</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">subzone</span><span class="o">=</span><span class="n">subzone</span><span class="p">)</span></div>

<div class="viewcode-block" id="_D3CommonField.std"><a class="viewcode-back" href="../../../library/D3Field.html#epygram.fields.D3Field._D3CommonField.std">[docs]</a>    <span class="k">def</span> <span class="nf">std</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subzone</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the standard deviation of data.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">_D3CommonField</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">subzone</span><span class="o">=</span><span class="n">subzone</span><span class="p">)</span></div>

<div class="viewcode-block" id="_D3CommonField.quadmean"><a class="viewcode-back" href="../../../library/D3Field.html#epygram.fields.D3Field._D3CommonField.quadmean">[docs]</a>    <span class="k">def</span> <span class="nf">quadmean</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subzone</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the quadratic mean of data.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">_D3CommonField</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">quadmean</span><span class="p">(</span><span class="n">subzone</span><span class="o">=</span><span class="n">subzone</span><span class="p">)</span></div>

<div class="viewcode-block" id="_D3CommonField.nonzero"><a class="viewcode-back" href="../../../library/D3Field.html#epygram.fields.D3Field._D3CommonField.nonzero">[docs]</a>    <span class="k">def</span> <span class="nf">nonzero</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subzone</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the number of non-zero values (whose absolute</span>
<span class="sd">        value &gt; config.epsilon).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">_D3CommonField</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">subzone</span><span class="o">=</span><span class="n">subzone</span><span class="p">)</span></div>

<div class="viewcode-block" id="_D3CommonField.dctspectrum"><a class="viewcode-back" href="../../../library/D3Field.html#epygram.fields.D3Field._D3CommonField.dctspectrum">[docs]</a>    <span class="k">def</span> <span class="nf">dctspectrum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subzone</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">level_index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">validity_index</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the DCT spectrum of the field, as a</span>
<span class="sd">        :class:`epygram.spectra.Spectrum` instance.</span>

<span class="sd">        :param subzone: LAM zone on which to compute the DCT,</span>
<span class="sd">                        among (None, &#39;C&#39;, &#39;CI&#39;, &#39;CIE&#39;). Defaults to &#39;C&#39;.</span>
<span class="sd">        :param level_index: the level index on which to compute the DCT</span>
<span class="sd">        :param validity_index: the validity index on which to compute the DCT</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">epygram.spectra</span> <span class="k">as</span> <span class="nn">esp</span>

        <span class="k">if</span> <span class="n">level_index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">datashape</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="n">epygramError</span><span class="p">(</span><span class="s2">&quot;must provide *level_index* for a 3D field.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">level_index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">elif</span> <span class="n">level_index</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">datashape</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="n">epygramError</span><span class="p">(</span><span class="s2">&quot;invalid *level_index* with regard to vertical levels.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">validity_index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">validity</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">epygramError</span><span class="p">(</span><span class="s2">&quot;must provide *validity_index* for a time-dimensioned field.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">validity_index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">elif</span> <span class="n">validity_index</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">validity</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">epygramError</span><span class="p">(</span><span class="s2">&quot;invalid *validity_index* with regard to time dimension.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">datashape</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">]:</span>
            <span class="n">field2d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getlevel</span><span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="n">level_index</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">field2d</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">validity</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">field2dt0</span> <span class="o">=</span> <span class="n">field2d</span><span class="o">.</span><span class="n">getvalidity</span><span class="p">(</span><span class="n">validity_index</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">field2dt0</span> <span class="o">=</span> <span class="n">field2d</span>
        <span class="k">if</span> <span class="n">subzone</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;LAMzone&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">subzone</span> <span class="o">=</span> <span class="s1">&#39;C&#39;</span>
        <span class="n">variances</span> <span class="o">=</span> <span class="n">esp</span><span class="o">.</span><span class="n">dctspectrum</span><span class="p">(</span><span class="n">field2dt0</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">subzone</span><span class="o">=</span><span class="n">subzone</span><span class="p">))</span>
        <span class="n">spectrum</span> <span class="o">=</span> <span class="n">esp</span><span class="o">.</span><span class="n">Spectrum</span><span class="p">(</span><span class="n">variances</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span>
                                <span class="n">name</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fid</span><span class="p">),</span>
                                <span class="n">resolution</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">grid</span><span class="p">[</span><span class="s1">&#39;X_resolution&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mf">1000.</span><span class="p">,</span>
                                <span class="n">mean2</span><span class="o">=</span><span class="n">variances</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">spectrum</span></div>

<div class="viewcode-block" id="_D3CommonField.histogram"><a class="viewcode-back" href="../../../library/D3Field.html#epygram.fields.D3Field._D3CommonField.histogram">[docs]</a>    <span class="k">def</span> <span class="nf">histogram</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                  <span class="n">subzone</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">over</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                  <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">get_n_bins_patches</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                  <span class="n">together_with</span><span class="o">=</span><span class="p">[],</span>
                  <span class="n">mask_threshold</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">center_hist_on_0</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                  <span class="n">minmax_in_title</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                  <span class="n">figsize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="o">**</span><span class="n">hist_kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build an histogram of the field data.</span>

<span class="sd">        :param subzone: LAM zone on which to compute the DCT,</span>
<span class="sd">                        among (None, &#39;C&#39;, &#39;CI&#39;, &#39;CIE&#39;).</span>
<span class="sd">        :param over: any existing figure and/or ax to be used for the</span>
<span class="sd">                     plot, given as a tuple (fig, ax), with None for</span>
<span class="sd">                     missing objects. *fig* is the frame of the</span>
<span class="sd">                     matplotlib figure, containing eventually several</span>
<span class="sd">                     subplots (axes); *ax* is the matplotlib axes on</span>
<span class="sd">                     which the drawing is done. When given (is not None),</span>
<span class="sd">                     these objects must be coherent, i.e. ax being one of</span>
<span class="sd">                     the fig axes.</span>
<span class="sd">        :param title: title for the plot</span>
<span class="sd">        :param get_n_bins_patches: if True, returns n, bins, patches</span>
<span class="sd">                                   (cf. matplotlib hist()) in addition</span>
<span class="sd">        :param together_with: another field or list of fields to plot on the</span>
<span class="sd">                              same histogram</span>
<span class="sd">        :param mask_threshold: dict with min and/or max value(s) to mask outside.</span>
<span class="sd">        :param center_hist_on_0: to center the histogram on 0.</span>
<span class="sd">        :param minmax_in_title: if True and **range** is not None,</span>
<span class="sd">                                adds min and max values in title.</span>
<span class="sd">        :param hist_kwargs: any keyword argument to be passed to</span>
<span class="sd">                            matplotlib&#39;s hist()</span>
<span class="sd">        :param figsize: figure sizes in inches, e.g. (5, 8.5).</span>
<span class="sd">                        Default figsize is config.plotsizes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
        <span class="c1"># initializations</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;font&#39;</span><span class="p">,</span> <span class="n">family</span><span class="o">=</span><span class="s1">&#39;serif&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">figsize</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">figsize</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">plotsizes</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectral</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">epygramError</span><span class="p">(</span><span class="s2">&quot;please convert to gridpoint with sp2gp()&quot;</span> <span class="o">+</span>
                               <span class="s2">&quot; method before plotting.&quot;</span><span class="p">)</span>
        <span class="n">mask_outside</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;min&#39;</span><span class="p">:</span><span class="o">-</span><span class="n">config</span><span class="o">.</span><span class="n">mask_outside</span><span class="p">,</span>
                        <span class="s1">&#39;max&#39;</span><span class="p">:</span><span class="n">config</span><span class="o">.</span><span class="n">mask_outside</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">mask_threshold</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mask_outside</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">mask_threshold</span><span class="p">)</span>

        <span class="c1"># get data</span>
        <span class="n">data1d</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_outside</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">subzone</span><span class="o">=</span><span class="n">subzone</span><span class="p">),</span>
                                         <span class="n">mask_outside</span><span class="p">[</span><span class="s1">&#39;min&#39;</span><span class="p">],</span>
                                         <span class="n">mask_outside</span><span class="p">[</span><span class="s1">&#39;max&#39;</span><span class="p">])</span>
        <span class="n">data1d</span> <span class="o">=</span> <span class="p">[</span><span class="n">stretch_array</span><span class="p">(</span><span class="n">data1d</span><span class="p">)]</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">set_figax</span><span class="p">(</span><span class="o">*</span><span class="n">over</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">together_with</span> <span class="o">!=</span> <span class="p">[]:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">together_with</span><span class="p">,</span> <span class="n">D3Field</span><span class="p">):</span>
                <span class="n">together_with</span> <span class="o">=</span> <span class="p">[</span><span class="n">together_with</span><span class="p">]</span>
            <span class="n">data1d</span> <span class="o">=</span> <span class="n">data1d</span> <span class="o">+</span> <span class="p">[</span><span class="n">stretch_array</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_outside</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">subzone</span><span class="o">=</span><span class="n">subzone</span><span class="p">),</span>
                                                                     <span class="n">mask_outside</span><span class="p">[</span><span class="s1">&#39;min&#39;</span><span class="p">],</span>
                                                                     <span class="n">mask_outside</span><span class="p">[</span><span class="s1">&#39;max&#39;</span><span class="p">]))</span>
                               <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">together_with</span><span class="p">]</span>
        <span class="c1"># plot params</span>
        <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data1d</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fid</span><span class="p">[</span><span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fid</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]]),</span>
                                        <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">validity</span><span class="o">.</span><span class="n">get</span><span class="p">())]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;rwidth&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">hist_kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">hist_kwargs</span><span class="p">[</span><span class="s1">&#39;rwidth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.9</span>
        <span class="k">if</span> <span class="s1">&#39;label&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">hist_kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">data1d</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">hist_kwargs</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">fid</span><span class="p">[</span><span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fid</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]]]</span> <span class="o">+</span> \
                                   <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">fid</span><span class="p">[</span><span class="nb">sorted</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">fid</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]]</span>
                                    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">together_with</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">hist_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;range&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">m</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">hist_kwargs</span><span class="p">[</span><span class="s1">&#39;range&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">m</span> <span class="o">=</span> <span class="nb">min</span><span class="p">([</span><span class="n">d</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data1d</span><span class="p">])</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">M</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">hist_kwargs</span><span class="p">[</span><span class="s1">&#39;range&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">M</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">d</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data1d</span><span class="p">])</span>
            <span class="n">hist_kwargs</span><span class="p">[</span><span class="s1">&#39;range&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">M</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">minmax_in_title</span><span class="p">:</span>
                <span class="n">minmax_in_title</span> <span class="o">=</span> <span class="s1">&#39;(min: &#39;</span> <span class="o">+</span> \
                    <span class="s1">&#39;{: .</span><span class="si">{precision}{type}</span><span class="s1">}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">min</span><span class="p">([</span><span class="n">d</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data1d</span><span class="p">]),</span>
                                                    <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;E&#39;</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> \
                    <span class="s1">&#39; // max: &#39;</span> <span class="o">+</span> \
                    <span class="s1">&#39;{: .</span><span class="si">{precision}{type}</span><span class="s1">}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">max</span><span class="p">([</span><span class="n">d</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data1d</span><span class="p">]),</span>
                                                    <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;E&#39;</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">minmax_in_title</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="n">hist_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;range&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">hist_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;bins&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> \
               <span class="nb">isinstance</span><span class="p">(</span><span class="n">hist_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;bins&#39;</span><span class="p">),</span> <span class="nb">int</span><span class="p">):</span>
                <span class="n">hist_kwargs</span><span class="p">[</span><span class="s1">&#39;range&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nb">min</span><span class="p">([</span><span class="n">d</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data1d</span><span class="p">]),</span>
                                        <span class="nb">max</span><span class="p">([</span><span class="n">d</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data1d</span><span class="p">]))</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hist_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;bins&#39;</span><span class="p">),</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">hist_kwargs</span><span class="p">[</span><span class="s1">&#39;bins&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;min&#39;</span><span class="p">:</span>
                <span class="n">hist_kwargs</span><span class="p">[</span><span class="s1">&#39;bins&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">([</span><span class="n">d</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data1d</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">hist_kwargs</span><span class="p">[</span><span class="s1">&#39;bins&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;min&#39;</span><span class="p">:</span>
                <span class="n">hist_kwargs</span><span class="p">[</span><span class="s1">&#39;bins&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">d</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data1d</span><span class="p">])</span>
        <span class="c1"># build histogram</span>
        <span class="n">n</span><span class="p">,</span> <span class="n">bins</span><span class="p">,</span> <span class="n">patches</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">data1d</span><span class="p">,</span> <span class="o">**</span><span class="n">hist_kwargs</span><span class="p">)</span>
        <span class="c1"># finalize graphical options</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bins</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">:</span>
            <span class="n">step</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">bins</span><span class="p">)</span> <span class="o">//</span> <span class="mi">7</span>
            <span class="n">ticks</span> <span class="o">=</span> <span class="p">[</span><span class="n">b</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">bins</span><span class="p">[::</span><span class="n">step</span><span class="p">]]</span>
            <span class="k">if</span> <span class="n">bins</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">ticks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">ticks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bins</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ticks</span> <span class="o">=</span> <span class="n">bins</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">get_xaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_tick_params</span><span class="p">(</span><span class="n">which</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s1">&#39;out&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">bins</span><span class="p">,</span> <span class="n">minor</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">ticks</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s1">&#39;</span><span class="si">{:.3E}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">ticks</span><span class="p">],</span>
                           <span class="n">rotation</span><span class="o">=</span><span class="mf">27.5</span><span class="p">,</span>
                           <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">center_hist_on_0</span><span class="p">:</span>
            <span class="n">M</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">ticks</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">abs</span><span class="p">(</span><span class="n">ticks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="n">M</span><span class="p">,</span> <span class="n">M</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>  <span class="c1"># vertical lines</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">ticks</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ticks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Number of gridpoints&#39;</span><span class="p">)</span>
        <span class="n">xlabel</span> <span class="o">=</span> <span class="s1">&#39;Gridpoint values&#39;</span>
        <span class="k">if</span> <span class="n">minmax_in_title</span><span class="p">:</span>
            <span class="n">xlabel</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">minmax_in_title</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;label&#39;</span> <span class="ow">in</span> <span class="n">hist_kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">get_n_bins_patches</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">bins</span><span class="p">,</span> <span class="n">patches</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span></div>

<div class="viewcode-block" id="_D3CommonField.scatter_with"><a class="viewcode-back" href="../../../library/D3Field.html#epygram.fields.D3Field._D3CommonField.scatter_with">[docs]</a>    <span class="k">def</span> <span class="nf">scatter_with</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span>
                     <span class="n">fig</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">figsize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">mask_outside</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">mask_outside</span><span class="p">,</span>
                     <span class="n">subzone</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">fidkey</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;__auto__&#39;</span><span class="p">,</span>
                     <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;__auto__&#39;</span><span class="p">,</span>
                     <span class="n">bisect</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                     <span class="o">**</span><span class="n">scatter_kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make a scatter plot of self data against other data.</span>

<span class="sd">        :param fig: a preexisting figure on which to plot</span>
<span class="sd">        :param ax: a preexisting axis on which to plot</span>
<span class="sd">        :param figsize: figure sizes in inches, e.g. (5, 8.5).</span>
<span class="sd">                        Default figsize is config.plotsizes.</span>
<span class="sd">        :param mask_outside: threshold to mask values outside (-mask_outside, +mask_outside)</span>
<span class="sd">        :param subzone: LAM subzone</span>
<span class="sd">        :param fidkey: fid key to be written on axes labels</span>
<span class="sd">        :param xlabel: custom x label</span>
<span class="sd">        :param ylabel: custom y label</span>
<span class="sd">        :param bisect: plot x=y line</span>

<span class="sd">        Other kwargs are passed to scatter() method.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">spectral</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">sp2gp</span><span class="p">()</span>
        <span class="n">data</span><span class="p">,</span> <span class="n">otherdata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_masked_any</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">mask_outside</span><span class="p">,</span> <span class="n">subzone</span><span class="o">=</span><span class="n">subzone</span><span class="p">)</span>
        <span class="n">otherdata</span> <span class="o">=</span> <span class="n">otherdata</span><span class="o">.</span><span class="n">compressed</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">compressed</span><span class="p">()</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">set_figax</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">otherdata</span><span class="p">,</span> <span class="o">**</span><span class="n">scatter_kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">xlabel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">xlabel</span> <span class="o">==</span> <span class="s1">&#39;__auto__&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">fidkey</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">xlabel</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fid</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">xlabel</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fid</span><span class="p">[</span><span class="n">fidkey</span><span class="p">])</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ylabel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ylabel</span> <span class="o">==</span> <span class="s1">&#39;__auto__&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">fidkey</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">ylabel</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">fid</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ylabel</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">fid</span><span class="p">[</span><span class="n">fidkey</span><span class="p">])</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">bisect</span><span class="p">:</span>
            <span class="n">xmin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">otherdata</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
            <span class="n">xmax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">otherdata</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">((</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">),</span> <span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span></div>

<div class="viewcode-block" id="_D3CommonField.global_shift_center"><a class="viewcode-back" href="../../../library/D3Field.html#epygram.fields.D3Field._D3CommonField.global_shift_center">[docs]</a>    <span class="k">def</span> <span class="nf">global_shift_center</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">longitude_shift</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Shifts the center of the geometry (and the data accordingly) by</span>
<span class="sd">        *longitude_shift* (in degrees).</span>

<span class="sd">        :param longitude_shift: has to be a multiple of the grid&#39;s resolution</span>
<span class="sd">                                in longitude.</span>

<span class="sd">        For global RegLLGeometry grids only.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s1">&#39;regular_lonlat&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">epygramError</span><span class="p">(</span><span class="s2">&quot;only for regular lonlat geometries.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">global_shift_center</span><span class="p">(</span><span class="n">longitude_shift</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">longitude_shift</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">grid</span><span class="p">[</span><span class="s1">&#39;X_resolution&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;degrees&#39;</span><span class="p">))</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">d4</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">n</span><span class="p">:],</span> <span class="n">data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">:</span><span class="n">n</span><span class="p">]),</span>
                                             <span class="n">axis</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setdata</span><span class="p">(</span><span class="n">data</span><span class="p">)</span></div>

<div class="viewcode-block" id="_D3CommonField.what"><a class="viewcode-back" href="../../../library/D3Field.html#epygram.fields.D3Field._D3CommonField.what">[docs]</a>    <span class="k">def</span> <span class="nf">what</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span>
             <span class="n">validity</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
             <span class="n">vertical_geometry</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
             <span class="n">cumulativeduration</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
             <span class="n">arpifs_var_names</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
             <span class="n">fid</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Writes in file a summary of the field.</span>

<span class="sd">        :param out: the output open file-like object.</span>
<span class="sd">        :param vertical_geometry: if True, writes the validity of the field.</span>
<span class="sd">        :param vertical_geometry: if True, writes the vertical geometry of the</span>
<span class="sd">                                  field.</span>
<span class="sd">        :param cumulativeduration: if False, not written.</span>
<span class="sd">        :param arpifs_var_names: if True, prints the equivalent &#39;arpifs&#39;</span>
<span class="sd">                                 variable names.</span>
<span class="sd">        :param fid: if True, prints the fid.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectral</span><span class="p">:</span>
            <span class="n">spectral_geometry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectral_geometry</span><span class="o">.</span><span class="n">truncation</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">spectral_geometry</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">write_formatted</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="s2">&quot;Kind of producting process&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">processtype</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">validity</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">validity</span><span class="o">.</span><span class="n">what</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">cumulativeduration</span><span class="o">=</span><span class="n">cumulativeduration</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">what</span><span class="p">(</span><span class="n">out</span><span class="p">,</span>
                           <span class="n">vertical_geometry</span><span class="o">=</span><span class="n">vertical_geometry</span><span class="p">,</span>
                           <span class="n">arpifs_var_names</span><span class="o">=</span><span class="n">arpifs_var_names</span><span class="p">,</span>
                           <span class="n">spectral_geometry</span><span class="o">=</span><span class="n">spectral_geometry</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fid</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fid</span><span class="p">:</span>
                <span class="n">write_formatted</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="s2">&quot;fid &quot;</span> <span class="o">+</span> <span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fid</span><span class="p">[</span><span class="n">key</span><span class="p">])</span></div>

<div class="viewcode-block" id="_D3CommonField.dump_to_nc"><a class="viewcode-back" href="../../../library/D3Field.html#epygram.fields.D3Field._D3CommonField.dump_to_nc">[docs]</a>    <span class="k">def</span> <span class="nf">dump_to_nc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">variablename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fidkey</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Dumps the field in a netCDF file.</span>

<span class="sd">        :param filename: filename to dump in</span>
<span class="sd">        :param variablename: variable name in netCDF</span>
<span class="sd">        :param fidkey: forces *variablename* to self.fid[*fidkey*];</span>
<span class="sd">                       defaults to &#39;netCDF&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">epygram.formats</span> <span class="k">import</span> <span class="n">resource</span>

        <span class="n">_fid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fid</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;netCDF&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="kc">None</span> <span class="ow">in</span> <span class="p">(</span><span class="n">variablename</span><span class="p">,</span> <span class="n">fidkey</span><span class="p">),</span> \
               <span class="s2">&quot;only one of *variablename*, *fidkey* can be provided.&quot;</span>
        <span class="k">if</span> <span class="n">variablename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fid</span><span class="p">[</span><span class="s1">&#39;netCDF&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">variablename</span>
        <span class="k">elif</span> <span class="n">fidkey</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fid</span><span class="p">[</span><span class="s1">&#39;netCDF&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fid</span><span class="p">[</span><span class="n">fidkey</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="s1">&#39;netCDF&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fid</span><span class="p">,</span> \
                   <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&quot;must provide *variablename* or *fidkey* for&quot;</span><span class="p">,</span>
                             <span class="s2">&quot;determining variable name in netCDF.&quot;</span><span class="p">])</span>
        <span class="k">with</span> <span class="n">resource</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;netCDF&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">r</span><span class="p">:</span>
            <span class="n">r</span><span class="o">.</span><span class="n">writefield</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">_fid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fid</span><span class="p">[</span><span class="s1">&#39;netCDF&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_fid</span></div>

<span class="c1">#############</span>
<span class="c1"># OPERATORS #</span>
<span class="c1">#############</span>

    <span class="k">def</span> <span class="nf">_check_operands</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Internal method to check compatibility of terms in operations on fields.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">):</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectral</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">spectral</span><span class="p">,</span> \
                <span class="s2">&quot;cannot operate a spectral field with a non-spectral field.&quot;</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">dimensions</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">dimensions</span><span class="p">,</span> \
                <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&quot;operations on fields cannot be done if fields do&quot;</span><span class="p">,</span>
                          <span class="s2">&quot;not share their gridpoint dimensions.&quot;</span><span class="p">])</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectral_geometry</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">spectral_geometry</span><span class="p">,</span> \
                <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&quot;operations on fields cannot be done if fields do&quot;</span><span class="p">,</span>
                          <span class="s2">&quot;not share their spectral geometry.&quot;</span><span class="p">])</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">validity</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">validity</span><span class="p">),</span> \
                <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&quot;operations on fields cannot be done if fields do&quot;</span><span class="p">,</span>
                          <span class="s2">&quot;not share their time dimension.&quot;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">super</span><span class="p">(</span><span class="n">_D3CommonField</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">_check_operands</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Definition of addition, &#39;other&#39; being:</span>
<span class="sd">        - a scalar (integer/float)</span>
<span class="sd">        - another Field of the same subclass.</span>
<span class="sd">        Returns a new Field whose data is the resulting operation,</span>
<span class="sd">        with &#39;fid&#39; = {&#39;op&#39;:&#39;+&#39;} and null validity in the general case,</span>
<span class="sd">        or conserved fid if shared by both fields, and extended validity if</span>
<span class="sd">        both consistent; to be checked anyway.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">new_attributes</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">structure</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">,</span>
                              <span class="n">geometry</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="p">,</span>
                              <span class="n">spectral_geometry</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">spectral_geometry</span><span class="p">,</span>
                              <span class="n">validity</span><span class="o">=</span><span class="n">FieldValidityList</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">validity</span><span class="p">)))</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">validity</span><span class="o">.</span><span class="n">is_valid</span><span class="p">()</span> <span class="ow">and</span> <span class="n">other</span><span class="o">.</span><span class="n">validity</span><span class="o">.</span><span class="n">is_valid</span><span class="p">()):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">validity</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">validity</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">validity</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="n">new_attributes</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">validity</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">validity</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">())</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="kc">None</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">validity</span><span class="o">.</span><span class="n">cumulativeduration</span><span class="p">(),</span> <span class="n">other</span><span class="o">.</span><span class="n">validity</span><span class="o">.</span><span class="n">cumulativeduration</span><span class="p">()):</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">validity</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">validity</span><span class="o">.</span><span class="n">get</span><span class="p">():</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">validity</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">other</span><span class="o">.</span><span class="n">validity</span><span class="o">.</span><span class="n">get</span><span class="p">():</span>
                                <span class="n">last</span> <span class="o">=</span> <span class="n">other</span>
                                <span class="n">first</span> <span class="o">=</span> <span class="bp">self</span>
                            <span class="k">elif</span> <span class="n">other</span><span class="o">.</span><span class="n">validity</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">validity</span><span class="o">.</span><span class="n">get</span><span class="p">():</span>
                                <span class="n">last</span> <span class="o">=</span> <span class="bp">self</span>
                                <span class="n">first</span> <span class="o">=</span> <span class="n">other</span>
                            <span class="k">if</span> <span class="n">last</span><span class="o">.</span><span class="n">validity</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">-</span> <span class="n">last</span><span class="o">.</span><span class="n">validity</span><span class="o">.</span><span class="n">cumulativeduration</span><span class="p">()</span> <span class="o">==</span> <span class="n">first</span><span class="o">.</span><span class="n">validity</span><span class="o">.</span><span class="n">get</span><span class="p">():</span>
                                <span class="c1"># the beginning of other cumulation is the end of self cumulation</span>
                                <span class="n">validity</span> <span class="o">=</span> <span class="n">last</span><span class="o">.</span><span class="n">validity</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">()</span>
                                <span class="n">validity</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">cumulativeduration</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">validity</span><span class="o">.</span><span class="n">cumulativeduration</span><span class="p">()</span> <span class="o">+</span> <span class="n">other</span><span class="o">.</span><span class="n">validity</span><span class="o">.</span><span class="n">cumulativeduration</span><span class="p">())</span>
                                <span class="n">new_attributes</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">validity</span><span class="o">=</span><span class="n">validity</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fid</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">fid</span><span class="p">:</span>
                <span class="n">new_attributes</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">fid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fid</span><span class="p">)</span>
        <span class="n">newfield</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="o">**</span><span class="n">new_attributes</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">newfield</span>

    <span class="k">def</span> <span class="nf">__mul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Definition of multiplication, &#39;other&#39; being:</span>
<span class="sd">        - a scalar (integer/float)</span>
<span class="sd">        - another Field of the same subclass.</span>
<span class="sd">        Returns a new Field whose data is the resulting operation,</span>
<span class="sd">        with &#39;fid&#39; = {&#39;op&#39;:&#39;*&#39;} and null validity.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">newfield</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mul</span><span class="p">(</span><span class="n">other</span><span class="p">,</span>
                             <span class="n">structure</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">,</span>
                             <span class="n">geometry</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="p">,</span>
                             <span class="n">spectral_geometry</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">spectral_geometry</span><span class="p">,</span>
                             <span class="n">validity</span><span class="o">=</span><span class="n">FieldValidityList</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">validity</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">newfield</span>

    <span class="k">def</span> <span class="nf">__sub__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Definition of substraction, &#39;other&#39; being:</span>
<span class="sd">        - a scalar (integer/float)</span>
<span class="sd">        - another Field of the same subclass.</span>
<span class="sd">        Returns a new Field whose data is the resulting operation,</span>
<span class="sd">        with &#39;fid&#39; = {&#39;op&#39;:&#39;-&#39;} and null validity in the general case,</span>
<span class="sd">        or conserved fid if shared by both fields, and extended validity if</span>
<span class="sd">        both consistent; to be checked anyway.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">new_attributes</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">structure</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">,</span>
                              <span class="n">geometry</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="p">,</span>
                              <span class="n">spectral_geometry</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">spectral_geometry</span><span class="p">,</span>
                              <span class="n">validity</span><span class="o">=</span><span class="n">FieldValidityList</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">validity</span><span class="p">)))</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">validity</span><span class="o">.</span><span class="n">is_valid</span><span class="p">()</span> <span class="ow">and</span> <span class="n">other</span><span class="o">.</span><span class="n">validity</span><span class="o">.</span><span class="n">is_valid</span><span class="p">()):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">validity</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">validity</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">validity</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="n">new_attributes</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">validity</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">validity</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">())</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="kc">None</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">validity</span><span class="o">.</span><span class="n">cumulativeduration</span><span class="p">(),</span> <span class="n">other</span><span class="o">.</span><span class="n">validity</span><span class="o">.</span><span class="n">cumulativeduration</span><span class="p">()):</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">validity</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">validity</span><span class="o">.</span><span class="n">get</span><span class="p">():</span>
                            <span class="k">if</span> <span class="n">other</span><span class="o">.</span><span class="n">validity</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">validity</span><span class="o">.</span><span class="n">get</span><span class="p">():</span>
                                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">validity</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">validity</span><span class="o">.</span><span class="n">cumulativeduration</span><span class="p">()</span> <span class="o">==</span> \
                                   <span class="n">other</span><span class="o">.</span><span class="n">validity</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">-</span> <span class="n">other</span><span class="o">.</span><span class="n">validity</span><span class="o">.</span><span class="n">cumulativeduration</span><span class="p">():</span>
                                    <span class="c1"># same start of cumulation</span>
                                    <span class="n">validity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validity</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">()</span>
                                    <span class="n">validity</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">cumulativeduration</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">validity</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">-</span> <span class="n">other</span><span class="o">.</span><span class="n">validity</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>
                                    <span class="n">new_attributes</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">validity</span><span class="o">=</span><span class="n">validity</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">validity</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">validity</span><span class="o">.</span><span class="n">get</span><span class="p">():</span>
                            <span class="k">if</span> <span class="kc">None</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">validity</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span> <span class="n">other</span><span class="o">.</span><span class="n">validity</span><span class="o">.</span><span class="n">get</span><span class="p">()):</span>
                                <span class="n">validity</span> <span class="o">=</span> <span class="n">FieldValidityList</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">validity</span><span class="p">))</span>
                            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">validity</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">other</span><span class="o">.</span><span class="n">validity</span><span class="o">.</span><span class="n">get</span><span class="p">():</span>
                                <span class="n">validity</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">validity</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">()</span>
                                <span class="n">validity</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">cumulativeduration</span><span class="o">=</span><span class="n">other</span><span class="o">.</span><span class="n">validity</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">validity</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span>
                                             <span class="n">statistical_process_on_duration</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
                            <span class="k">elif</span> <span class="n">other</span><span class="o">.</span><span class="n">validity</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">validity</span><span class="o">.</span><span class="n">get</span><span class="p">():</span>
                                <span class="n">validity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validity</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">()</span>
                                <span class="n">validity</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">cumulativeduration</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">validity</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">-</span> <span class="n">other</span><span class="o">.</span><span class="n">validity</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span>
                                             <span class="n">statistical_process_on_duration</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
                            <span class="n">new_attributes</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">validity</span><span class="o">=</span><span class="n">validity</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fid</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">fid</span><span class="p">:</span>
                <span class="n">new_attributes</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">fid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fid</span><span class="p">)</span>
        <span class="n">newfield</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sub</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="o">**</span><span class="n">new_attributes</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">newfield</span>

    <span class="k">def</span> <span class="nf">__div__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Definition of division, &#39;other&#39; being:</span>
<span class="sd">        - a scalar (integer/float)</span>
<span class="sd">        - another Field of the same subclass.</span>
<span class="sd">        Returns a new Field whose data is the resulting operation,</span>
<span class="sd">        with &#39;fid&#39; = {&#39;op&#39;:&#39;/&#39;} and null validity.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">newfield</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_div</span><span class="p">(</span><span class="n">other</span><span class="p">,</span>
                             <span class="n">structure</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">,</span>
                             <span class="n">geometry</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="p">,</span>
                             <span class="n">spectral_geometry</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">spectral_geometry</span><span class="p">,</span>
                             <span class="n">validity</span><span class="o">=</span><span class="n">FieldValidityList</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">validity</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">newfield</span>

    <span class="fm">__radd__</span> <span class="o">=</span> <span class="fm">__add__</span>
    <span class="fm">__rmul__</span> <span class="o">=</span> <span class="fm">__mul__</span>

    <span class="k">def</span> <span class="nf">__rsub__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Definition of substraction, &#39;other&#39; being:</span>
<span class="sd">        - a scalar (integer/float)</span>
<span class="sd">        - another Field of the same subclass.</span>
<span class="sd">        Returns a new Field whose data is the resulting operation,</span>
<span class="sd">        with &#39;fid&#39; = {&#39;op&#39;:&#39;-&#39;} and null validity.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">newfield</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rsub</span><span class="p">(</span><span class="n">other</span><span class="p">,</span>
                              <span class="n">structure</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">,</span>
                              <span class="n">geometry</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="p">,</span>
                              <span class="n">spectral_geometry</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">spectral_geometry</span><span class="p">,</span>
                              <span class="n">validity</span><span class="o">=</span><span class="n">FieldValidityList</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">validity</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">newfield</span>

    <span class="k">def</span> <span class="nf">__rdiv__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Definition of division, &#39;other&#39; being:</span>
<span class="sd">        - a scalar (integer/float)</span>
<span class="sd">        - another Field of the same subclass.</span>
<span class="sd">        Returns a new Field whose data is the resulting operation,</span>
<span class="sd">        with &#39;fid&#39; = {&#39;op&#39;:&#39;/&#39;} and null validity.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">newfield</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rdiv</span><span class="p">(</span><span class="n">other</span><span class="p">,</span>
                              <span class="n">structure</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">,</span>
                              <span class="n">geometry</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="p">,</span>
                              <span class="n">spectral_geometry</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">spectral_geometry</span><span class="p">,</span>
                              <span class="n">validity</span><span class="o">=</span><span class="n">FieldValidityList</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">validity</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">newfield</span></div>


<div class="viewcode-block" id="D3Field"><a class="viewcode-back" href="../../../library/D3Field.html#epygram.fields.D3Field.D3Field">[docs]</a><span class="k">class</span> <span class="nc">D3Field</span><span class="p">(</span><span class="n">_D3CommonField</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    3-Dimensions field class.</span>
<span class="sd">    A field is defined by its identifier &#39;fid&#39;,</span>
<span class="sd">    its data, its geometry (gridpoint and optionally spectral),</span>
<span class="sd">    and its validity.</span>

<span class="sd">    The natural being of a field is gridpoint, so that:</span>
<span class="sd">    a field always has a gridpoint geometry, but it has a spectral geometry only</span>
<span class="sd">    in case it is spectral.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_collector</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;field&#39;</span><span class="p">,)</span>
    <span class="n">_footprint</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">attr</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
            <span class="n">structure</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">values</span><span class="o">=</span><span class="nb">set</span><span class="p">([</span><span class="s1">&#39;3D&#39;</span><span class="p">])),</span>
            <span class="n">geometry</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="nb">type</span><span class="o">=</span><span class="n">D3Geometry</span><span class="p">,</span>
                <span class="n">info</span><span class="o">=</span><span class="s2">&quot;Geometry defining the position of the field gridpoints.&quot;</span><span class="p">),</span>
            <span class="n">validity</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="nb">type</span><span class="o">=</span><span class="n">FieldValidityList</span><span class="p">,</span>
                <span class="n">info</span><span class="o">=</span><span class="s2">&quot;Validity of the field.&quot;</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">access</span><span class="o">=</span><span class="s1">&#39;rwx&#39;</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="n">FieldValidityList</span><span class="p">()),</span>
            <span class="n">spectral_geometry</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">info</span><span class="o">=</span><span class="s2">&quot;For a spectral field, its spectral geometry handles </span><span class="se">\</span>
<span class="s2">                      spectral transforms and dimensions.&quot;</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="n">SpectralGeometry</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
            <span class="n">processtype</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">access</span><span class="o">=</span><span class="s1">&#39;rwx&#39;</span><span class="p">,</span>
                <span class="n">info</span><span class="o">=</span><span class="s2">&quot;Generating process.&quot;</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="p">)</span>

<span class="c1">##############</span>
<span class="c1"># ABOUT DATA #</span>
<span class="c1">##############</span>

<div class="viewcode-block" id="D3Field.sp2gp"><a class="viewcode-back" href="../../../library/D3Field.html#epygram.fields.D3Field.D3Field.sp2gp">[docs]</a>    <span class="k">def</span> <span class="nf">sp2gp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Transforms the spectral field into gridpoint, according to its spectral</span>
<span class="sd">        geometry. Replaces data in place.</span>

<span class="sd">        The spectral transform subroutine is actually included in the spectral</span>
<span class="sd">        geometry&#39;s *sp2gp()* method.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectral</span><span class="p">:</span>
            <span class="n">gpdims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_gpdims_for_spectral_transforms</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">rectangular_grid</span><span class="p">:</span>
                <span class="c1"># LAM</span>
                <span class="n">gpdata</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">get_datashape</span><span class="p">(</span><span class="n">dimT</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">validity</span><span class="p">),</span> <span class="n">d4</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># global</span>
                <span class="n">gpdata</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">get_datashape</span><span class="p">(</span><span class="n">dimT</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">validity</span><span class="p">),</span> <span class="n">d4</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">validity</span><span class="p">)):</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">vcoordinate</span><span class="o">.</span><span class="n">levels</span><span class="p">)):</span>
                    <span class="n">spdata_i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">d4</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="n">t</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="p">:]</span>
                    <span class="n">gpdata_i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectral_geometry</span><span class="o">.</span><span class="n">sp2gp</span><span class="p">(</span><span class="n">spdata_i</span><span class="p">,</span> <span class="n">gpdims</span><span class="p">)</span>
                    <span class="n">gpdata_i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">reshape_data</span><span class="p">(</span><span class="n">gpdata_i</span><span class="p">)</span>
                    <span class="n">gpdata</span><span class="p">[</span><span class="n">t</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">gpdata_i</span><span class="p">[:,</span> <span class="p">:]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_attributes</span><span class="p">[</span><span class="s1">&#39;spectral_geometry&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setdata</span><span class="p">(</span><span class="n">gpdata</span><span class="p">)</span></div>

<div class="viewcode-block" id="D3Field.gp2sp"><a class="viewcode-back" href="../../../library/D3Field.html#epygram.fields.D3Field.D3Field.gp2sp">[docs]</a>    <span class="k">def</span> <span class="nf">gp2sp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spectral_geometry</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Transforms the gridpoint field into spectral space, according to the</span>
<span class="sd">        *spectral_geometry* mandatorily passed as argument. Replaces data in</span>
<span class="sd">        place.</span>

<span class="sd">        :param spectral_geometry: instance of SpectralGeometry, actually</span>
<span class="sd">                                  containing spectral transform subroutine (in</span>
<span class="sd">                                  in its own *gp2sp()* method).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">spectral_geometry</span><span class="p">,</span> <span class="n">SpectralGeometry</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectral</span><span class="p">:</span>
            <span class="n">gpdims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_gpdims_for_spectral_transforms</span><span class="p">()</span>
            <span class="n">spdata</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">validity</span><span class="p">)):</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">vcoordinate</span><span class="o">.</span><span class="n">levels</span><span class="p">)):</span>
                    <span class="n">gpdata_i</span> <span class="o">=</span> <span class="n">stretch_array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">d4</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="n">t</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:])</span>
                    <span class="n">spdata_i</span> <span class="o">=</span> <span class="n">spectral_geometry</span><span class="o">.</span><span class="n">gp2sp</span><span class="p">(</span><span class="n">gpdata_i</span><span class="p">,</span> <span class="n">gpdims</span><span class="p">)</span>
                    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">spdata_i</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">spdata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">spdata</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">validity</span><span class="p">),</span>
                                              <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">vcoordinate</span><span class="o">.</span><span class="n">levels</span><span class="p">),</span>
                                              <span class="n">n</span><span class="p">))</span>
                    <span class="n">spdata</span><span class="p">[</span><span class="n">t</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">spdata_i</span><span class="p">[:]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_attributes</span><span class="p">[</span><span class="s1">&#39;spectral_geometry&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spectral_geometry</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setdata</span><span class="p">(</span><span class="n">spdata</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_get_gpdims_for_spectral_transforms</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build a dictionary containing gridpoint dimensions for the call to</span>
<span class="sd">        spectral transforms.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">rectangular_grid</span><span class="p">:</span>
            <span class="c1"># LAM</span>
            <span class="n">gpdims</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">,</span> <span class="s1">&#39;X_CIzone&#39;</span><span class="p">,</span> <span class="s1">&#39;Y_CIzone&#39;</span><span class="p">]:</span>
                <span class="n">gpdims</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;X_resolution&#39;</span><span class="p">,</span> <span class="s1">&#39;Y_resolution&#39;</span><span class="p">]:</span>
                <span class="n">gpdims</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">grid</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># global</span>
            <span class="n">gpdims</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;lat_number&#39;</span><span class="p">,</span> <span class="s1">&#39;lon_number_by_lat&#39;</span><span class="p">]:</span>
                <span class="n">gpdims</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">gpdims</span>

<div class="viewcode-block" id="D3Field.compute_xy_spderivatives"><a class="viewcode-back" href="../../../library/D3Field.html#epygram.fields.D3Field.D3Field.compute_xy_spderivatives">[docs]</a>    <span class="k">def</span> <span class="nf">compute_xy_spderivatives</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the derivatives of field in spectral space, then come back in</span>
<span class="sd">        gridpoint space.</span>
<span class="sd">        Returns the two derivative fields.</span>

<span class="sd">        The spectral transform and derivatives subroutines are actually included</span>
<span class="sd">        in the spectral geometry&#39;s *compute_xy_spderivatives()* method.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectral</span><span class="p">:</span>
            <span class="n">gpdims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_gpdims_for_spectral_transforms</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">rectangular_grid</span><span class="p">:</span>
                <span class="c1"># LAM</span>
                <span class="n">gpderivX</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">get_datashape</span><span class="p">(</span><span class="n">dimT</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">validity</span><span class="p">),</span> <span class="n">d4</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
                <span class="n">gpderivY</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">get_datashape</span><span class="p">(</span><span class="n">dimT</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">validity</span><span class="p">),</span> <span class="n">d4</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># global</span>
                <span class="n">gpderivX</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">get_datashape</span><span class="p">(</span><span class="n">dimT</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">validity</span><span class="p">),</span> <span class="n">d4</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
                <span class="n">gpderivY</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">get_datashape</span><span class="p">(</span><span class="n">dimT</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">validity</span><span class="p">),</span> <span class="n">d4</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">validity</span><span class="p">)):</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">vcoordinate</span><span class="o">.</span><span class="n">levels</span><span class="p">)):</span>
                    <span class="n">spdata_i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">d4</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="n">t</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="p">:]</span>
                    <span class="p">(</span><span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectral_geometry</span><span class="o">.</span><span class="n">compute_xy_spderivatives</span><span class="p">(</span><span class="n">spdata_i</span><span class="p">,</span> <span class="n">gpdims</span><span class="p">)</span>
                    <span class="n">dx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">reshape_data</span><span class="p">(</span><span class="n">dx</span><span class="p">)</span>
                    <span class="n">dy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">reshape_data</span><span class="p">(</span><span class="n">dy</span><span class="p">)</span>
                    <span class="n">gpderivX</span><span class="p">[</span><span class="n">t</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">dx</span><span class="p">[:,</span> <span class="p">:]</span>
                    <span class="n">gpderivY</span><span class="p">[</span><span class="n">t</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">dy</span><span class="p">[:,</span> <span class="p">:]</span>

            <span class="n">field_dX</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="n">field_dY</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="p">(</span><span class="n">field_dX</span><span class="p">,</span> <span class="n">field_dY</span><span class="p">):</span>
                <span class="n">field</span><span class="o">.</span><span class="n">_attributes</span><span class="p">[</span><span class="s1">&#39;spectral_geometry&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">field_dX</span><span class="o">.</span><span class="n">fid</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;derivative&#39;</span><span class="p">:</span><span class="s1">&#39;x&#39;</span><span class="p">}</span>
            <span class="n">field_dY</span><span class="o">.</span><span class="n">fid</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;derivative&#39;</span><span class="p">:</span><span class="s1">&#39;y&#39;</span><span class="p">}</span>
            <span class="n">field_dX</span><span class="o">.</span><span class="n">setdata</span><span class="p">(</span><span class="n">gpderivX</span><span class="p">)</span>
            <span class="n">field_dY</span><span class="o">.</span><span class="n">setdata</span><span class="p">(</span><span class="n">gpderivY</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">epygramError</span><span class="p">(</span><span class="s1">&#39;field must be spectral to compute its spectral derivatives.&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">field_dX</span><span class="p">,</span> <span class="n">field_dY</span><span class="p">)</span></div>

<div class="viewcode-block" id="D3Field.getdata"><a class="viewcode-back" href="../../../library/D3Field.html#epygram.fields.D3Field.D3Field.getdata">[docs]</a>    <span class="k">def</span> <span class="nf">getdata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subzone</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">d4</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the field data, with 3D shape if the field is not spectral,</span>
<span class="sd">        2D if spectral.</span>

<span class="sd">        :param subzone: optional, among (&#39;C&#39;, &#39;CI&#39;), for LAM fields only,</span>
<span class="sd">                        returns the data resp. on the C or C+I zone.</span>
<span class="sd">                        Default is no subzone, i.e. the whole field.</span>
<span class="sd">        :param d4: - if True,  returned values are shaped in a 4 dimensions array</span>
<span class="sd">                   - if False, shape of returned values is determined with</span>
<span class="sd">                     respect to geometry.</span>

<span class="sd">        Shape of 4D data: \n</span>
<span class="sd">        - Rectangular grids:\n</span>
<span class="sd">          grid[t,k,0,0] is SW, grid[t,k,-1,-1] is NE \n</span>
<span class="sd">          grid[t,k,0,-1] is SE, grid[t,k,-1,0] is NW \n</span>
<span class="sd">          with k the level, t the temporal dimension</span>
<span class="sd">        - Gauss grids:\n</span>
<span class="sd">          grid[t,k,0,:Nj] is first (Northern) band of latitude, masked after</span>
<span class="sd">          Nj = number of longitudes for latitude j \n</span>
<span class="sd">          grid[t,k,-1,:Nj] is last (Southern) band of latitude (idem). \n</span>
<span class="sd">          with k the level, t the temporal dimension</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectral</span> <span class="ow">and</span> <span class="n">subzone</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;LAMzone&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">extract_subzone</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">subzone</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">epygramError</span><span class="p">(</span><span class="s2">&quot;*subzone* cannot be provided for this field.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">d4</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">data</span></div>

<div class="viewcode-block" id="D3Field.setdata"><a class="viewcode-back" href="../../../library/D3Field.html#epygram.fields.D3Field.D3Field.setdata">[docs]</a>    <span class="k">def</span> <span class="nf">setdata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets field data, checking *data* to have the good shape according to</span>
<span class="sd">        geometry.</span>

<span class="sd">        :param data: dimensions should in any case be ordered in a subset of</span>
<span class="sd">        (t,z,y,x), or (t,z,n) if spectral (2D spectral coefficients must be 1D</span>
<span class="sd">        with ad hoc ordering, n being the total number of spectral</span>
<span class="sd">        coefficients).</span>

<span class="sd">        *data* may be 4D (3D if spectral) even if the field is not, as long as</span>
<span class="sd">        the above dimensions ordering is respected.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># determination of field shape</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectral</span><span class="p">:</span>
            <span class="n">shp</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">validity</span><span class="p">),</span>
                   <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">vcoordinate</span><span class="o">.</span><span class="n">levels</span><span class="p">),</span>
                   <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">elif</span> <span class="s1">&#39;gauss&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
            <span class="n">shp</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">validity</span><span class="p">),</span>
                   <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">vcoordinate</span><span class="o">.</span><span class="n">levels</span><span class="p">),</span>
                   <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="s1">&#39;lat_number&#39;</span><span class="p">],</span>
                   <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="s1">&#39;max_lon_number&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">shp</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">validity</span><span class="p">),</span>
                   <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">vcoordinate</span><span class="o">.</span><span class="n">levels</span><span class="p">),</span>
                   <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="s1">&#39;Y&#39;</span><span class="p">],</span>
                   <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectral</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="c1"># data is given as 4D: check compatibility</span>
            <span class="k">assert</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">shp</span><span class="p">,</span> \
                <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span>
                          <span class="s1">&#39;should have shape&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">shp</span><span class="p">)])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># data is squeezed: reshape</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shp</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&#39;data&#39; shape has to be compatible with field shape: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">shp</span><span class="p">))</span>
                <span class="k">raise</span>
            <span class="sd">&quot;&quot;&quot;# find indexes corresponding to dimensions</span>
<span class="sd">            dimensions = 0</span>
<span class="sd">            indexes = {&#39;t&#39;:0, &#39;z&#39;:1, &#39;y&#39;:2, &#39;x&#39;:3}</span>
<span class="sd">            # t, z</span>
<span class="sd">            if len(self.validity) &gt; 1:</span>
<span class="sd">                dimensions += 1</span>
<span class="sd">            else:</span>
<span class="sd">                indexes[&#39;t&#39;] = None</span>
<span class="sd">                for i in (&#39;z&#39;, &#39;y&#39;, &#39;x&#39;):</span>
<span class="sd">                    indexes[i] = indexes[i] - 1</span>
<span class="sd">            if self.geometry.datashape[&#39;k&#39;]:</span>
<span class="sd">                dimensions += 1</span>
<span class="sd">            else:</span>
<span class="sd">                indexes[&#39;z&#39;] = None</span>
<span class="sd">                for i in (&#39;y&#39;, &#39;x&#39;):</span>
<span class="sd">                    indexes[i] = indexes[i] - 1</span>
<span class="sd">            # y, x or spectral ordering</span>
<span class="sd">            if self.spectral:</span>
<span class="sd">                dimensions += 1</span>
<span class="sd">                dataType = &quot;spectral&quot;</span>
<span class="sd">            else:</span>
<span class="sd">                if self.geometry.datashape[&#39;j&#39;]:</span>
<span class="sd">                    dimensions += 1</span>
<span class="sd">                else:</span>
<span class="sd">                    indexes[&#39;y&#39;] = None</span>
<span class="sd">                    for i in (&#39;x&#39;,):</span>
<span class="sd">                        indexes[i] = indexes[i] - 1</span>
<span class="sd">                if self.geometry.datashape[&#39;i&#39;]:</span>
<span class="sd">                    dimensions += 1</span>
<span class="sd">                else:</span>
<span class="sd">                    indexes[&#39;x&#39;] = None</span>
<span class="sd">                dataType = &quot;gridpoint&quot;</span>
<span class="sd">            # check dimensions</span>
<span class="sd">            assert (len(numpy.shape(data)) == dimensions</span>
<span class="sd">                        or numpy.shape(data) == (1,)), \</span>
<span class="sd">                    dataType + &quot; data should be &quot; + str(dimensions) + &quot;D array.&quot;</span>
<span class="sd">            if indexes[&#39;t&#39;] is not None:</span>
<span class="sd">                assert data.shape[0] == len(self.validity), \</span>
<span class="sd">                    &#39; == &#39;.join([&#39;data.shape[0] should be len(self.validity)&#39;,</span>
<span class="sd">                                 str(len(self.validity))])</span>
<span class="sd">            if self.geometry.datashape[&#39;k&#39;]:</span>
<span class="sd">                assert data.shape[indexes[&#39;z&#39;]] == len(self.geometry.vcoordinate.levels), \</span>
<span class="sd">                    &#39; == &#39;.join([&#39;data.shape[&#39; + str(indexes[&#39;z&#39;]) +</span>
<span class="sd">                                 &#39;] should be len(self.geometry.vcoordinate.levels)&#39;,</span>
<span class="sd">                                 str(len(self.geometry.vcoordinate.levels))])</span>
<span class="sd">            if not self.spectral:</span>
<span class="sd">                if &#39;gauss&#39; in self.geometry.name:</span>
<span class="sd">                    if self.geometry.datashape[&#39;j&#39;]:</span>
<span class="sd">                        assert data.shape[indexes[&#39;y&#39;]] == self.geometry.dimensions[&#39;lat_number&#39;], \</span>
<span class="sd">                            &#39; == &#39;.join([&#39;data.shape[&#39; + str(indexes[&#39;y&#39;]) +</span>
<span class="sd">                                         &quot;] should be self.geometry.dimensions[&#39;lat_number&#39;]&quot;,</span>
<span class="sd">                                         str(self.geometry.dimensions[&#39;lat_number&#39;])])</span>
<span class="sd">                    if self.geometry.datashape[&#39;i&#39;]:</span>
<span class="sd">                        assert data.shape[indexes[&#39;x&#39;]] == self.geometry.dimensions[&#39;max_lon_number&#39;], \</span>
<span class="sd">                            &#39; == &#39;.join([&#39;data.shape[&#39; + str(indexes[&#39;x&#39;]) +</span>
<span class="sd">                                         &quot;] should be self.geometry.dimensions[&#39;max_lon_number&#39;]&quot;,</span>
<span class="sd">                                         str(self.geometry.dimensions[&#39;max_lon_number&#39;])])</span>
<span class="sd">                else:</span>
<span class="sd">                    if self.geometry.datashape[&#39;j&#39;]:</span>
<span class="sd">                        assert data.shape[indexes[&#39;y&#39;]] == self.geometry.dimensions[&#39;Y&#39;], \</span>
<span class="sd">                            &#39; == &#39;.join([&#39;data.shape[&#39; + str(indexes[&#39;y&#39;]) +</span>
<span class="sd">                                         &quot;] should be self.geometry.dimensions[&#39;Y&#39;]&quot;,</span>
<span class="sd">                                         str(self.geometry.dimensions[&#39;Y&#39;])])</span>
<span class="sd">                    if self.geometry.datashape[&#39;i&#39;]:</span>
<span class="sd">                        assert data.shape[indexes[&#39;x&#39;]] == self.geometry.dimensions[&#39;X&#39;], \</span>
<span class="sd">                            &#39; == &#39;.join([&#39;data.shape[&#39; + str(indexes[&#39;x&#39;]) +</span>
<span class="sd">                                         &quot;] should be self.geometry.dimensions[&#39;X&#39;]&quot;,</span>
<span class="sd">                                         str(self.geometry.dimensions[&#39;X&#39;])])</span>
<span class="sd">            # reshape to 4D</span>
<span class="sd">            data = data.reshape(shp)&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">D3Field</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">setdata</span><span class="p">(</span><span class="n">data</span><span class="p">)</span></div>

    <span class="n">data</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">getdata</span><span class="p">,</span> <span class="n">setdata</span><span class="p">,</span> <span class="n">Field</span><span class="o">.</span><span class="n">deldata</span><span class="p">,</span> <span class="s2">&quot;Accessor to the field data.&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="D3Field.select_subzone"><a class="viewcode-back" href="../../../library/D3Field.html#epygram.fields.D3Field.D3Field.select_subzone">[docs]</a>    <span class="k">def</span> <span class="nf">select_subzone</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subzone</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        If a LAMzone defines the field, select only the *subzone* from it.</span>

<span class="sd">        :param subzone: among (&#39;C&#39;, &#39;CI&#39;).</span>

<span class="sd">        Warning: modifies the field and its geometry in place !</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;LAMzone&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">subzone</span><span class="o">=</span><span class="n">subzone</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_attributes</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">select_subzone</span><span class="p">(</span><span class="n">subzone</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setdata</span><span class="p">(</span><span class="n">data</span><span class="p">)</span></div>

<div class="viewcode-block" id="D3Field.getvalue_ij"><a class="viewcode-back" href="../../../library/D3Field.html#epygram.fields.D3Field.D3Field.getvalue_ij">[docs]</a>    <span class="k">def</span> <span class="nf">getvalue_ij</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">j</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">one</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the value of the field on point of indices (*i, j, k, t*).</span>
<span class="sd">        Take care (*i, j, k, t*) is python-indexing, ranging from 0 to</span>
<span class="sd">        dimension-1.</span>

<span class="sd">        :param i: the index in X direction</span>
<span class="sd">        :param j: the index in Y direction</span>
<span class="sd">        :param k: the index of the level (not a value in Pa or m...)</span>
<span class="sd">        :param t: the index of the temporal dimension (not a validity object)</span>

<span class="sd">        *k* and *t* can be scalar even if *i* and *j* are arrays.</span>

<span class="sd">        If *one* is False, returns [value] instead of value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">t</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">validity</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">epygramError</span><span class="p">(</span><span class="s2">&quot;*t* is mandatory when there are several validities&quot;</span><span class="p">)</span>
            <span class="n">t</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">datashape</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="n">epygramError</span><span class="p">(</span><span class="s2">&quot;*k* is mandatory when field has a vertical coordinate&quot;</span><span class="p">)</span>
            <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">j</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">datashape</span><span class="p">[</span><span class="s1">&#39;j&#39;</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="n">epygramError</span><span class="p">(</span><span class="s2">&quot;*j* is mandatory when field has a two horizontal dimensions&quot;</span><span class="p">)</span>
            <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">i</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">datashape</span><span class="p">[</span><span class="s1">&#39;i&#39;</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="n">epygramError</span><span class="p">(</span><span class="s2">&quot;*i* is mandatory when field has one horizontal dimension&quot;</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="n">as_numpy_array</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">as_numpy_array</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">k</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">as_numpy_array</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">as_numpy_array</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">numpy</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">point_is_inside_domain_ij</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;point is out of field domain.&quot;</span><span class="p">)</span>

        <span class="n">sizes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">t</span><span class="p">]])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sizes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sizes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="mi">1</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sizes</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">epygramError</span><span class="p">(</span><span class="s2">&quot;each of i, j, k and t must be scalar or have the same length as the others&quot;</span><span class="p">)</span>

        <span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">d4</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="n">t</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">one</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">value</span></div>

<div class="viewcode-block" id="D3Field.getlevel"><a class="viewcode-back" href="../../../library/D3Field.html#epygram.fields.D3Field.D3Field.getlevel">[docs]</a>    <span class="k">def</span> <span class="nf">getlevel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a level of the field as a new field.</span>

<span class="sd">        :param level: the requested level expressed in coordinate value (Pa, m...)</span>
<span class="sd">        :param k: the index of the requested level</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">level</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">epygramError</span><span class="p">(</span><span class="s2">&quot;You must give k or level.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">level</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">epygramError</span><span class="p">(</span><span class="s2">&quot;You cannot give, at the same time, k and level&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">level</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">level</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">vcoordinate</span><span class="o">.</span><span class="n">levels</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">epygramError</span><span class="p">(</span><span class="s2">&quot;The requested level does not exist.&quot;</span><span class="p">)</span>
            <span class="n">my_level</span> <span class="o">=</span> <span class="n">level</span>
            <span class="n">my_k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">vcoordinate</span><span class="o">.</span><span class="n">levels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">level</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">my_k</span> <span class="o">=</span> <span class="n">k</span>
            <span class="n">my_level</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">vcoordinate</span><span class="o">.</span><span class="n">levels</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span> <span class="o">==</span> <span class="s1">&#39;3D&#39;</span><span class="p">:</span>
            <span class="n">newstructure</span> <span class="o">=</span> <span class="s1">&#39;H2D&#39;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span> <span class="o">==</span> <span class="s1">&#39;V2D&#39;</span><span class="p">:</span>
            <span class="n">newstructure</span> <span class="o">=</span> <span class="s1">&#39;H1D&#39;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span> <span class="o">==</span> <span class="s1">&#39;V1D&#39;</span><span class="p">:</span>
            <span class="n">newstructure</span> <span class="o">=</span> <span class="s1">&#39;Point&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">epygramError</span><span class="p">(</span><span class="s2">&quot;It&#39;s not possible to extract a level from a &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span> <span class="o">+</span> <span class="s2">&quot; field.&quot;</span><span class="p">)</span>

        <span class="n">kwargs_vcoord</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;structure&#39;</span><span class="p">:</span> <span class="s1">&#39;V&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;typeoffirstfixedsurface&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">vcoordinate</span><span class="o">.</span><span class="n">typeoffirstfixedsurface</span><span class="p">,</span>
                         <span class="s1">&#39;position_on_grid&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">vcoordinate</span><span class="o">.</span><span class="n">position_on_grid</span><span class="p">,</span>
                         <span class="s1">&#39;levels&#39;</span><span class="p">:[</span><span class="n">my_level</span><span class="p">]}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">vcoordinate</span><span class="o">.</span><span class="n">typeoffirstfixedsurface</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">118</span><span class="p">,</span> <span class="mi">119</span><span class="p">):</span>
            <span class="n">kwargs_vcoord</span><span class="p">[</span><span class="s1">&#39;grid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">vcoordinate</span><span class="o">.</span><span class="n">grid</span><span class="p">)</span>
        <span class="n">newvcoordinate</span> <span class="o">=</span> <span class="n">fpx</span><span class="o">.</span><span class="n">geometry</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs_vcoord</span><span class="p">)</span>
        <span class="n">kwargs_geom</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;structure&#39;</span><span class="p">:</span><span class="n">newstructure</span><span class="p">,</span>
                       <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                       <span class="s1">&#39;grid&#39;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">grid</span><span class="p">),</span>
                       <span class="s1">&#39;dimensions&#39;</span><span class="p">:</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">dimensions</span><span class="p">),</span>
                       <span class="s1">&#39;vcoordinate&#39;</span><span class="p">:</span> <span class="n">newvcoordinate</span><span class="p">,</span>
                       <span class="s1">&#39;position_on_horizontal_grid&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">position_on_horizontal_grid</span><span class="p">}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">projected_geometry</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;academic&#39;</span><span class="p">:</span>
            <span class="n">kwargs_geom</span><span class="p">[</span><span class="s1">&#39;projection&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">projection</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">geoid</span><span class="p">:</span>
            <span class="n">kwargs_geom</span><span class="p">[</span><span class="s1">&#39;geoid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">geoid</span>
        <span class="n">newgeometry</span> <span class="o">=</span> <span class="n">fpx</span><span class="o">.</span><span class="n">geometry</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs_geom</span><span class="p">)</span>
        <span class="n">generic_fid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fid</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;generic&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">generic_fid</span><span class="p">[</span><span class="s1">&#39;level&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">my_level</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">my_level</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="k">else</span> <span class="n">my_k</span>  <span class="c1"># to avoid arrays in fid</span>
        <span class="n">kwargs_field</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;structure&#39;</span><span class="p">:</span><span class="n">newstructure</span><span class="p">,</span>
                        <span class="s1">&#39;validity&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">validity</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
                        <span class="s1">&#39;processtype&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">processtype</span><span class="p">,</span>
                        <span class="s1">&#39;geometry&#39;</span><span class="p">:</span><span class="n">newgeometry</span><span class="p">,</span>
                        <span class="s1">&#39;fid&#39;</span><span class="p">:{</span><span class="s1">&#39;generic&#39;</span><span class="p">:</span><span class="n">generic_fid</span><span class="p">}}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectral_geometry</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">kwargs_field</span><span class="p">[</span><span class="s1">&#39;spectral_geometry&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectral_geometry</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">newfield</span> <span class="o">=</span> <span class="n">fpx</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs_field</span><span class="p">)</span>
        <span class="n">newfield</span><span class="o">.</span><span class="n">setdata</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">d4</span><span class="o">=</span><span class="kc">True</span><span class="p">)[:,</span> <span class="n">my_k</span><span class="p">:</span><span class="n">my_k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="o">...</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">newfield</span></div>

<div class="viewcode-block" id="D3Field.getvalidity"><a class="viewcode-back" href="../../../library/D3Field.html#epygram.fields.D3Field.D3Field.getvalidity">[docs]</a>    <span class="k">def</span> <span class="nf">getvalidity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index_or_validity</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the field restrained to one of its temporal validity as a new</span>
<span class="sd">        field.</span>

<span class="sd">        :param index_or_validity: can be either a</span>
<span class="sd">                                  :class:`epygram.base.FieldValidity` instance</span>
<span class="sd">                                  or the index of the requested validity in the</span>
<span class="sd">                                  field&#39;s FieldValidityList.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">index_or_validity</span><span class="p">,</span> <span class="n">FieldValidity</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">index_or_validity</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span> \
               <span class="s2">&quot;index_or_validity* should be either a FieldValidity instance or an int.&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">index_or_validity</span><span class="p">,</span> <span class="n">FieldValidity</span><span class="p">):</span>
            <span class="n">validity</span> <span class="o">=</span> <span class="n">index_or_validity</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validity</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">index_or_validity</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;*validity* not in field validity.&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">index_or_validity</span>
            <span class="n">validity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validity</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="n">newfield</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">()</span>
        <span class="n">newfield</span><span class="o">.</span><span class="n">validity</span> <span class="o">=</span> <span class="n">validity</span>
        <span class="n">newfield</span><span class="o">.</span><span class="n">setdata</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">d4</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="n">index</span><span class="p">:</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">newfield</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">vcoordinate</span><span class="o">.</span><span class="n">levels</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># levels are, at least, dependent on position</span>
            <span class="n">levels4d</span> <span class="o">=</span> <span class="n">newfield</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">get_levels</span><span class="p">(</span><span class="n">d4</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nb_validities</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">validity</span><span class="p">))</span>
            <span class="n">kwargs_vcoord</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">newfield</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">vcoordinate</span><span class="o">.</span><span class="n">footprint_as_dict</span><span class="p">())</span>
            <span class="n">kwargs_vcoord</span><span class="p">[</span><span class="s1">&#39;levels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">levels4d</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
            <span class="n">newfield</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">vcoordinate</span> <span class="o">=</span> <span class="n">fpx</span><span class="o">.</span><span class="n">geometry</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs_vcoord</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">newfield</span></div>

<div class="viewcode-block" id="D3Field.center"><a class="viewcode-back" href="../../../library/D3Field.html#epygram.fields.D3Field.D3Field.center">[docs]</a>    <span class="k">def</span> <span class="nf">center</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Performs an averaging on data values to center the field on the grid (aka shuman)</span>
<span class="sd">        and modify geometry.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">posSpl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">position_on_horizontal_grid</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">posSpl</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># not center</span>
            <span class="n">posY</span><span class="p">,</span> <span class="n">posX</span> <span class="o">=</span> <span class="n">posSpl</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">posY</span> <span class="o">==</span> <span class="s1">&#39;lower&#39;</span> <span class="ow">or</span> <span class="n">posX</span> <span class="o">==</span> <span class="s1">&#39;left&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="p">,</span> <span class="n">D3ProjectedGeometry</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Centering is not available with non-projected geometries&quot;</span><span class="p">)</span>
                <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">d4</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># This test is useful if field has been retrieved with getdata=False</span>
                    <span class="k">if</span> <span class="n">posY</span> <span class="o">==</span> <span class="s1">&#39;lower&#39;</span><span class="p">:</span>
                        <span class="n">data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="n">data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">:,</span> <span class="p">:])</span>
                        <span class="n">data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span>
                    <span class="k">if</span> <span class="n">posX</span> <span class="o">==</span> <span class="s1">&#39;left&#39;</span><span class="p">:</span>
                        <span class="n">data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">:])</span>
                        <span class="n">data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="o">-</span><span class="mi">2</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">setdata</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">position_on_horizontal_grid</span> <span class="o">=</span> <span class="s1">&#39;center&#39;</span></div></div>


<div class="viewcode-block" id="D3VirtualField"><a class="viewcode-back" href="../../../library/D3Field.html#epygram.fields.D3Field.D3VirtualField">[docs]</a><span class="k">class</span> <span class="nc">D3VirtualField</span><span class="p">(</span><span class="n">_D3CommonField</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    3-Dimensions Virtual field class.</span>

<span class="sd">    Data is taken from other fields, either:</span>
<span class="sd">    - a given *fieldset*</span>
<span class="sd">    - a *resource* in which are stored fields defined by *resource_fids*.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_collector</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;field&#39;</span><span class="p">,)</span>
    <span class="n">_footprint</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">attr</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
            <span class="n">structure</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">values</span><span class="o">=</span><span class="nb">set</span><span class="p">([</span><span class="s1">&#39;3D&#39;</span><span class="p">])),</span>
            <span class="n">fieldset</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">info</span><span class="o">=</span><span class="s2">&quot;Set of real fields that can compose the Virtual Field.&quot;</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="n">FieldSet</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="n">FieldSet</span><span class="p">()),</span>
            <span class="n">resource</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">info</span><span class="o">=</span><span class="s2">&quot;Resource in which is stored the fields defined by </span><span class="se">\</span>
<span class="s2">                      resource_fids.&quot;</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="n">Resource</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
            <span class="n">resource_fids</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">info</span><span class="o">=</span><span class="s2">&quot;Definition of the fields in resource that compose the </span><span class="se">\</span>
<span class="s2">                      virtual field.&quot;</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="n">FPList</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="n">FPList</span><span class="p">()),</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">D3VirtualField</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fieldset</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">resource</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">resource_fids</span> <span class="o">!=</span> <span class="n">FPList</span><span class="p">():</span>
                <span class="k">raise</span> <span class="n">epygramError</span><span class="p">(</span><span class="s2">&quot;You cannot set fieldset and (resource or resource_fids) at the same time.&quot;</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">fieldGenerator</span><span class="p">(</span><span class="n">getdata</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fieldset</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="n">field</span><span class="o">.</span><span class="n">fid</span><span class="p">,</span> <span class="n">field</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_fieldGenerator</span> <span class="o">=</span> <span class="n">fieldGenerator</span>

            <span class="k">def</span> <span class="nf">getFieldByFid</span><span class="p">(</span><span class="n">fid</span><span class="p">,</span> <span class="n">getdata</span><span class="p">):</span>
                <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="n">field</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fieldset</span> <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">fid</span> <span class="o">==</span> <span class="n">fid</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">epygramError</span><span class="p">(</span><span class="s2">&quot;There is no, or more than one, field(s) matching with this fid.&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_getFieldByFid</span> <span class="o">=</span> <span class="n">getFieldByFid</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span> <span class="o">=</span> <span class="s1">&#39;fieldset&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">resource</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">resource_fids</span> <span class="o">==</span> <span class="n">FPList</span><span class="p">():</span>
                <span class="k">raise</span> <span class="n">epygramError</span><span class="p">(</span><span class="s2">&quot;If you do not set fieldset, you need to provide resource and resource_fids.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">all</span><span class="p">([</span><span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">resource</span><span class="o">.</span><span class="n">listfields</span><span class="p">()</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">resource_fids</span><span class="p">]):</span>
                <span class="n">fidlist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resource_fids</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1">#There could be pattern to search for instead of true fid </span>
                <span class="n">fidlist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resource</span><span class="o">.</span><span class="n">find_fields_in_resource</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">resource_fids</span><span class="p">,</span>
                                                                <span class="n">fieldtype</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Point&#39;</span><span class="p">,</span> <span class="s1">&#39;V1D&#39;</span><span class="p">,</span> <span class="s1">&#39;V2D&#39;</span><span class="p">,</span> <span class="s1">&#39;H2D&#39;</span><span class="p">,</span> <span class="s1">&#39;3D&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fidlist</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">epygramError</span><span class="p">(</span><span class="s2">&quot;There is no field in resource matching with resource_fids&quot;</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">fieldGenerator</span><span class="p">(</span><span class="n">getdata</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">fid</span> <span class="ow">in</span> <span class="n">fidlist</span><span class="p">:</span>
                    <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resource</span><span class="o">.</span><span class="n">readfield</span><span class="p">(</span><span class="n">fid</span><span class="p">,</span> <span class="n">getdata</span><span class="o">=</span><span class="n">getdata</span><span class="p">)</span>
                    <span class="k">yield</span> <span class="n">fid</span><span class="p">,</span> <span class="n">field</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_fieldGenerator</span> <span class="o">=</span> <span class="n">fieldGenerator</span>

            <span class="k">def</span> <span class="nf">getFieldByFid</span><span class="p">(</span><span class="n">fid</span><span class="p">,</span> <span class="n">getdata</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">resource</span><span class="o">.</span><span class="n">readfield</span><span class="p">(</span><span class="n">fid</span><span class="p">,</span> <span class="n">getdata</span><span class="o">=</span><span class="n">getdata</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_getFieldByFid</span> <span class="o">=</span> <span class="n">getFieldByFid</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span> <span class="o">=</span> <span class="s1">&#39;resource&#39;</span>

        <span class="n">first</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fidList</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">levelList</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">levelIsArray</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">for</span> <span class="n">fid</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fieldGenerator</span><span class="p">(</span><span class="n">getdata</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">structure</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Point&#39;</span><span class="p">,</span> <span class="s1">&#39;V1D&#39;</span><span class="p">,</span> <span class="s1">&#39;V2D&#39;</span><span class="p">,</span> <span class="s1">&#39;H1D&#39;</span><span class="p">,</span> <span class="s1">&#39;H2D&#39;</span><span class="p">,</span> <span class="s1">&#39;3D&#39;</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="n">epygramError</span><span class="p">(</span><span class="s2">&quot;3D virtual fields must be build from &#39;physical&#39; fields only&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">first</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_structure</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">structure</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_geometry</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">()</span>  <span class="c1"># We need a deepcopy as we modify it</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_validity</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">validity</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">spectral_geometry</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_spectral_geometry</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">spectral_geometry</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_spectral_geometry</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_processtype</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">processtype</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_structure</span> <span class="o">!=</span> <span class="n">field</span><span class="o">.</span><span class="n">structure</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">epygramError</span><span class="p">(</span><span class="s2">&quot;All fields must share the structure&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_geometry</span><span class="o">.</span><span class="n">structure</span> <span class="o">!=</span> <span class="n">field</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">structure</span> <span class="ow">or</span> \
                   <span class="bp">self</span><span class="o">.</span><span class="n">_geometry</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="n">field</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">name</span> <span class="ow">or</span> \
                   <span class="bp">self</span><span class="o">.</span><span class="n">_geometry</span><span class="o">.</span><span class="n">grid</span> <span class="o">!=</span> <span class="n">field</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">grid</span> <span class="ow">or</span> \
                   <span class="bp">self</span><span class="o">.</span><span class="n">_geometry</span><span class="o">.</span><span class="n">dimensions</span> <span class="o">!=</span> <span class="n">field</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">dimensions</span> <span class="ow">or</span> \
                   <span class="bp">self</span><span class="o">.</span><span class="n">_geometry</span><span class="o">.</span><span class="n">position_on_horizontal_grid</span> <span class="o">!=</span> <span class="n">field</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">position_on_horizontal_grid</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">epygramError</span><span class="p">(</span><span class="s2">&quot;All fields must share the horizontal geometry&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_geometry</span><span class="o">.</span><span class="n">projected_geometry</span> <span class="ow">or</span> <span class="n">field</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">projected_geometry</span> <span class="ow">or</span> \
                   <span class="bp">self</span><span class="o">.</span><span class="n">_geometry</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;academic&#39;</span> <span class="ow">or</span> <span class="n">field</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;academic&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_geometry</span><span class="o">.</span><span class="n">projection</span> <span class="o">!=</span> <span class="n">field</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">projection</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">epygramError</span><span class="p">(</span><span class="s2">&quot;All fields must share the geometry projection&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_geometry</span><span class="o">.</span><span class="n">projected_geometry</span> <span class="ow">or</span> <span class="n">field</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">projected_geometry</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_geometry</span><span class="o">.</span><span class="n">projection</span> <span class="o">!=</span> <span class="n">field</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">projection</span> <span class="ow">or</span> \
                       <span class="bp">self</span><span class="o">.</span><span class="n">_geometry</span><span class="o">.</span><span class="n">geoid</span> <span class="o">!=</span> <span class="n">field</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">geoid</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">epygramError</span><span class="p">(</span><span class="s2">&quot;All fields must share the geometry geoid&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_geometry</span><span class="o">.</span><span class="n">vcoordinate</span><span class="o">.</span><span class="n">typeoffirstfixedsurface</span> <span class="o">!=</span> <span class="n">field</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">vcoordinate</span><span class="o">.</span><span class="n">typeoffirstfixedsurface</span> <span class="ow">or</span> \
                   <span class="bp">self</span><span class="o">.</span><span class="n">_geometry</span><span class="o">.</span><span class="n">vcoordinate</span><span class="o">.</span><span class="n">position_on_grid</span> <span class="o">!=</span> <span class="n">field</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">vcoordinate</span><span class="o">.</span><span class="n">position_on_grid</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">epygramError</span><span class="p">(</span><span class="s2">&quot;All fields must share the vertical geometry&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_geometry</span><span class="o">.</span><span class="n">vcoordinate</span><span class="o">.</span><span class="n">grid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">field</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">vcoordinate</span><span class="o">.</span><span class="n">grid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_geometry</span><span class="o">.</span><span class="n">vcoordinate</span><span class="o">.</span><span class="n">grid</span> <span class="o">!=</span> <span class="n">field</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">vcoordinate</span><span class="o">.</span><span class="n">grid</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">epygramError</span><span class="p">(</span><span class="s2">&quot;All fields must share the vertical grid&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validity</span> <span class="o">!=</span> <span class="n">field</span><span class="o">.</span><span class="n">validity</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">epygramError</span><span class="p">(</span><span class="s2">&quot;All fields must share the validity&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_spectral_geometry</span> <span class="o">!=</span> <span class="n">field</span><span class="o">.</span><span class="n">spectral_geometry</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">epygramError</span><span class="p">(</span><span class="s2">&quot;All fields must share the spectral geometry&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processtype</span> <span class="o">!=</span> <span class="n">field</span><span class="o">.</span><span class="n">processtype</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">epygramError</span><span class="p">(</span><span class="s2">&quot;All fields must share the processtype&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">vcoordinate</span><span class="o">.</span><span class="n">levels</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">epygramError</span><span class="p">(</span><span class="s2">&quot;fields must have only one level&quot;</span><span class="p">)</span>
            <span class="n">levelIsArray</span> <span class="o">=</span> <span class="n">levelIsArray</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">vcoordinate</span><span class="o">.</span><span class="n">levels</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">vcoordinate</span><span class="o">.</span><span class="n">levels</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">))</span> <span class="ow">and</span> <span class="n">field</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">vcoordinate</span><span class="o">.</span><span class="n">levels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">levelList</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">epygramError</span><span class="p">(</span><span class="s2">&quot;This level have already been found&quot;</span><span class="p">)</span>
            <span class="n">levelList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">vcoordinate</span><span class="o">.</span><span class="n">levels</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">fid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fidList</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">epygramError</span><span class="p">(</span><span class="s2">&quot;fields must have different fids&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fidList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fid</span><span class="p">)</span>

        <span class="n">kwargs_vcoord</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">structure</span><span class="o">=</span><span class="s1">&#39;V&#39;</span><span class="p">,</span>
                             <span class="n">typeoffirstfixedsurface</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_geometry</span><span class="o">.</span><span class="n">vcoordinate</span><span class="o">.</span><span class="n">typeoffirstfixedsurface</span><span class="p">,</span>
                             <span class="n">position_on_grid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_geometry</span><span class="o">.</span><span class="n">vcoordinate</span><span class="o">.</span><span class="n">position_on_grid</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_geometry</span><span class="o">.</span><span class="n">vcoordinate</span><span class="o">.</span><span class="n">grid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">kwargs_vcoord</span><span class="p">[</span><span class="s1">&#39;grid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_geometry</span><span class="o">.</span><span class="n">vcoordinate</span><span class="o">.</span><span class="n">grid</span>
        <span class="k">if</span> <span class="n">levelIsArray</span><span class="p">:</span>
            <span class="n">kwargs_vcoord</span><span class="p">[</span><span class="s1">&#39;levels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">levelList</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">kwargs_vcoord</span><span class="p">[</span><span class="s1">&#39;levels&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fidList</span> <span class="o">=</span> <span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">levelList</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fidList</span><span class="p">))))</span>  <span class="c1"># TOBECHECKED</span>
        <span class="n">newvcoordinate</span> <span class="o">=</span> <span class="n">fpx</span><span class="o">.</span><span class="n">geometry</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs_vcoord</span><span class="p">)</span>

        <span class="n">newstructure</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;3D&#39;</span><span class="p">:</span> <span class="s1">&#39;3D&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;H2D&#39;</span><span class="p">:</span> <span class="s1">&#39;3D&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;V1D&#39;</span><span class="p">:</span> <span class="s1">&#39;V1D&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;Point&#39;</span><span class="p">:</span> <span class="s1">&#39;V1D&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;V2D&#39;</span><span class="p">:</span> <span class="s1">&#39;V2D&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;H1D&#39;</span><span class="p">:</span> <span class="s1">&#39;V2D&#39;</span><span class="p">}[</span><span class="n">field</span><span class="o">.</span><span class="n">structure</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">newstructure</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">,</span> \
               <span class="s2">&quot;Individual fields structure do not match the field strucuture&quot;</span>

        <span class="n">kwargs_geom</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;structure&#39;</span><span class="p">:</span><span class="n">newstructure</span><span class="p">,</span>
                       <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                       <span class="s1">&#39;grid&#39;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">grid</span><span class="p">),</span>
                       <span class="s1">&#39;dimensions&#39;</span><span class="p">:</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">dimensions</span><span class="p">),</span>
                       <span class="s1">&#39;vcoordinate&#39;</span><span class="p">:</span> <span class="n">newvcoordinate</span><span class="p">,</span>
                       <span class="s1">&#39;position_on_horizontal_grid&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">position_on_horizontal_grid</span>
                       <span class="p">}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">projected_geometry</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;academic&#39;</span><span class="p">:</span>
            <span class="n">kwargs_geom</span><span class="p">[</span><span class="s1">&#39;projection&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">projection</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">geoid</span><span class="p">:</span>
            <span class="n">kwargs_geom</span><span class="p">[</span><span class="s1">&#39;geoid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">geoid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_geometry</span> <span class="o">=</span> <span class="n">fpx</span><span class="o">.</span><span class="n">geometry</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs_geom</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_spgpOpList</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">as_real_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">getdata</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">field3d</span> <span class="o">=</span> <span class="n">fpx</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">fid</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fid</span><span class="p">),</span>
                            <span class="n">structure</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;H2D&#39;</span><span class="p">:</span><span class="s1">&#39;3D&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;Point&#39;</span><span class="p">:</span><span class="s1">&#39;V1D&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;H1D&#39;</span><span class="p">:</span><span class="s1">&#39;V2D&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;V1D&#39;</span><span class="p">:</span><span class="s1">&#39;V1D&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;V2D&#39;</span><span class="p">:</span><span class="s1">&#39;V2D&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;3D&#39;</span><span class="p">:</span><span class="s1">&#39;3D&#39;</span><span class="p">}[</span><span class="bp">self</span><span class="o">.</span><span class="n">_structure</span><span class="p">],</span>
                            <span class="n">geometry</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="p">,</span>
                            <span class="n">validity</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">validity</span><span class="p">,</span>
                            <span class="n">spectral_geometry</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">spectral_geometry</span><span class="p">,</span>
                            <span class="n">processtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">processtype</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">getdata</span><span class="p">:</span>
            <span class="n">field3d</span><span class="o">.</span><span class="n">setdata</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">d4</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">field3d</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">geometry</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_geometry</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">validity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validity</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">spectral_geometry</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_spectral_geometry</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">processtype</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processtype</span>

<span class="c1">##############</span>
<span class="c1"># ABOUT DATA #</span>
<span class="c1">##############</span>
<div class="viewcode-block" id="D3VirtualField.sp2gp"><a class="viewcode-back" href="../../../library/D3Field.html#epygram.fields.D3Field.D3VirtualField.sp2gp">[docs]</a>    <span class="k">def</span> <span class="nf">sp2gp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Transforms the spectral field into gridpoint, according to its spectral</span>
<span class="sd">        geometry. Replaces data in place.</span>

<span class="sd">        The spectral transform subroutine is actually included in the spectral</span>
<span class="sd">        geometry&#39;s *sp2gp()* method.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_spectral_geometry</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span> <span class="o">==</span> <span class="s1">&#39;resource&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_spgpOpList</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;sp2gp&#39;</span><span class="p">,</span> <span class="p">{}))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fieldset</span><span class="p">:</span>
                <span class="n">field</span><span class="o">.</span><span class="n">sp2gp</span><span class="p">()</span></div>

<div class="viewcode-block" id="D3VirtualField.gp2sp"><a class="viewcode-back" href="../../../library/D3Field.html#epygram.fields.D3Field.D3VirtualField.gp2sp">[docs]</a>    <span class="k">def</span> <span class="nf">gp2sp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spectral_geometry</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Transforms the gridpoint field into spectral space, according to the</span>
<span class="sd">        *spectral_geometry* mandatorily passed as argument. Replaces data in</span>
<span class="sd">        place.</span>

<span class="sd">        :param spectral_geometry: instance of SpectralGeometry, actually</span>
<span class="sd">                                  containing spectral transform subroutine (in</span>
<span class="sd">                                  in its own *gp2sp()* method).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_spectral_geometry</span> <span class="o">=</span> <span class="n">spectral_geometry</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span> <span class="o">==</span> <span class="s1">&#39;resource&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_spgpOpList</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;gp2sp&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;spectral_geometry&#39;</span><span class="p">:</span><span class="n">spectral_geometry</span><span class="p">}))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fieldset</span><span class="p">:</span>
                <span class="n">field</span><span class="o">.</span><span class="n">gp2sp</span><span class="p">(</span><span class="n">spectral_geometry</span><span class="p">)</span></div>

<div class="viewcode-block" id="D3VirtualField.getdata"><a class="viewcode-back" href="../../../library/D3Field.html#epygram.fields.D3Field.D3VirtualField.getdata">[docs]</a>    <span class="k">def</span> <span class="nf">getdata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subzone</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">d4</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the field data, with 3D shape if the field is not spectral,</span>
<span class="sd">        2D if spectral.</span>

<span class="sd">        :param subzone: optional, among (&#39;C&#39;, &#39;CI&#39;), for LAM fields only,</span>
<span class="sd">                        returns the data resp. on the C or C+I zone.</span>
<span class="sd">                        Default is no subzone, i.e. the whole field.</span>
<span class="sd">        :param d4: - if True,  returned values are shaped in a 4 dimensions array</span>
<span class="sd">                   - if False, shape of returned values is determined with</span>
<span class="sd">                     respect to geometry</span>

<span class="sd">        Shape of 3D data: \n</span>
<span class="sd">        - Rectangular grids:\n</span>
<span class="sd">          grid[k,0,0] is SW, grid[k,-1,-1] is NE \n</span>
<span class="sd">          grid[k,0,-1] is SE, grid[k,-1,0] is NW \n</span>
<span class="sd">          with k the level</span>
<span class="sd">        - Gauss grids:\n</span>
<span class="sd">          grid[k,0,:Nj] is first (Northern) band of latitude, masked after</span>
<span class="sd">          Nj = number of longitudes for latitude j \n</span>
<span class="sd">          grid[k,-1,:Nj] is last (Southern) band of latitude (idem). \n</span>
<span class="sd">          with k the level</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dataList</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">concat</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">concatenate</span>
        <span class="n">arr</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span>
        <span class="n">missing</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">vcoordinate</span><span class="o">.</span><span class="n">levels</span><span class="p">)):</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getlevel</span><span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">)</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">subzone</span><span class="o">=</span><span class="n">subzone</span><span class="p">,</span> <span class="n">d4</span><span class="o">=</span><span class="n">d4</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">):</span>
                <span class="n">concat</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">concatenate</span>
                <span class="n">arr</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span>
                <span class="n">missing</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">fill_value</span><span class="p">)</span>
            <span class="n">dataList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">d4</span><span class="p">:</span>
            <span class="c1"># vertical dimension already exists, and is the second one</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">concat</span><span class="p">(</span><span class="n">dataList</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">validity</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># vertical dimension does not exist and</span>
                <span class="c1"># must be the second one of the resulting array</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">dataList</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># vertical dimension does not exist and</span>
                <span class="c1"># must be the first one of the resulting array</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">arr</span><span class="p">(</span><span class="n">dataList</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">missing</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">set_fill_value</span><span class="p">(</span><span class="n">missing</span><span class="o">.</span><span class="n">pop</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="D3VirtualField.setdata"><a class="viewcode-back" href="../../../library/D3Field.html#epygram.fields.D3Field.D3VirtualField.setdata">[docs]</a>    <span class="k">def</span> <span class="nf">setdata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;setdata() not implemented on virtual fields.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="n">epygramError</span><span class="p">(</span><span class="s2">&quot;setdata cannot be implemented on virtual fields&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="D3VirtualField.deldata"><a class="viewcode-back" href="../../../library/D3Field.html#epygram.fields.D3Field.D3VirtualField.deldata">[docs]</a>    <span class="k">def</span> <span class="nf">deldata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;deldata() not implemented on virtual fields.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="n">epygramError</span><span class="p">(</span><span class="s2">&quot;deldata cannot be implemented on virtual fields&quot;</span><span class="p">)</span></div>

    <span class="n">data</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">getdata</span><span class="p">)</span>

<div class="viewcode-block" id="D3VirtualField.getvalue_ij"><a class="viewcode-back" href="../../../library/D3Field.html#epygram.fields.D3Field.D3VirtualField.getvalue_ij">[docs]</a>    <span class="k">def</span> <span class="nf">getvalue_ij</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">j</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">one</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the value of the field on point of indices (*i, j, k, t*).</span>
<span class="sd">        Take care (*i, j, k, t*) is python-indexing, ranging from 0 to</span>
<span class="sd">        dimension-1.</span>

<span class="sd">        :param i: the index in X direction</span>
<span class="sd">        :param j: the index in Y direction</span>
<span class="sd">        :param k: the index of the level (not a value in Pa or m...)</span>
<span class="sd">        :param t: the index of the temporal dimension (not a validity object)</span>

<span class="sd">        *k* and *t* can be scalar even if *i* and *j* are arrays.</span>

<span class="sd">        If *one* is False, returns [value] instead of value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">t</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">validity</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">epygramError</span><span class="p">(</span><span class="s2">&quot;*t* is mandatory when there are several validities&quot;</span><span class="p">)</span>
            <span class="n">t</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">datashape</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="n">epygramError</span><span class="p">(</span><span class="s2">&quot;*k* is mandatory when field has a vertical coordinate&quot;</span><span class="p">)</span>
            <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">j</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">datashape</span><span class="p">[</span><span class="s1">&#39;j&#39;</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="n">epygramError</span><span class="p">(</span><span class="s2">&quot;*j* is mandatory when field has a two horizontal dimensions&quot;</span><span class="p">)</span>
            <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">i</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">datashape</span><span class="p">[</span><span class="s1">&#39;i&#39;</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="n">epygramError</span><span class="p">(</span><span class="s2">&quot;*i* is mandatory when field has one horizontal dimension&quot;</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="n">as_numpy_array</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">as_numpy_array</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">k</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">as_numpy_array</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">as_numpy_array</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">numpy</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">point_is_inside_domain_ij</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;point is out of field domain.&quot;</span><span class="p">)</span>

        <span class="n">sizes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">t</span><span class="p">]])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sizes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sizes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="mi">1</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sizes</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">epygramError</span><span class="p">(</span><span class="s2">&quot;each of i, j, k and t must be scalar or have the same length as the others&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">sizes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">k</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">sizes</span><span class="p">))</span>

        <span class="n">oldk</span> <span class="o">=</span> <span class="n">k</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getlevel</span><span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="n">oldk</span><span class="p">)</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">d4</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">((</span><span class="nb">max</span><span class="p">(</span><span class="n">sizes</span><span class="p">),),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">thisk</span> <span class="ow">in</span> <span class="n">numpy</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">thisk</span> <span class="o">!=</span> <span class="n">oldk</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getlevel</span><span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="n">thisk</span><span class="p">)</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">d4</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">oldk</span> <span class="o">=</span> <span class="n">thisk</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">k</span> <span class="o">==</span> <span class="n">thisk</span>
            <span class="n">value</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">t</span><span class="p">,</span>
                               <span class="mi">0</span><span class="p">,</span>
                               <span class="n">j</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">j</span><span class="p">,</span>
                               <span class="n">i</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">i</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">one</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">value</span></div>

<div class="viewcode-block" id="D3VirtualField.getlevel"><a class="viewcode-back" href="../../../library/D3Field.html#epygram.fields.D3Field.D3VirtualField.getlevel">[docs]</a>    <span class="k">def</span> <span class="nf">getlevel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a level of the field as a new field.</span>

<span class="sd">        :param level: the requested level expressed in coordinate value (Pa, m...)</span>
<span class="sd">        :param k: the index of the requested level</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">level</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">epygramError</span><span class="p">(</span><span class="s2">&quot;You must give k or level.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">level</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">epygramError</span><span class="p">(</span><span class="s2">&quot;You cannot give, at the same time, k and level&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">level</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">level</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">vcoordinate</span><span class="o">.</span><span class="n">levels</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">epygramError</span><span class="p">(</span><span class="s2">&quot;The requested level does not exist.&quot;</span><span class="p">)</span>
            <span class="n">my_k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">vcoordinate</span><span class="o">.</span><span class="n">levels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">level</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">my_k</span> <span class="o">=</span> <span class="n">k</span>

        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getFieldByFid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fidList</span><span class="p">[</span><span class="n">my_k</span><span class="p">],</span> <span class="kc">True</span><span class="p">)</span>
        
        <span class="c1">#update vccordinate in case of this attribute was changed in the geometry</span>
        <span class="n">vcoord</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">vcoordinate</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">()</span>
        <span class="n">levels</span> <span class="o">=</span> <span class="n">vcoord</span><span class="o">.</span><span class="n">levels</span><span class="p">[</span><span class="n">my_k</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">vcoord</span><span class="o">.</span><span class="n">levels</span><span class="p">)):</span>
            <span class="n">vcoord</span><span class="o">.</span><span class="n">levels</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="n">vcoord</span><span class="o">.</span><span class="n">levels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">levels</span><span class="p">)</span>
        <span class="n">result</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">vcoordinate</span> <span class="o">=</span> <span class="n">vcoord</span>

        <span class="k">for</span> <span class="n">op</span><span class="p">,</span> <span class="n">kwargs</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_spgpOpList</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;sp2gp&#39;</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">sp2gp</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;gp2sp&#39;</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">gp2sp</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">epygramError</span><span class="p">(</span><span class="s2">&quot;operation not known&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span></div></div>


<span class="n">footprints</span><span class="o">.</span><span class="n">collectors</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tag</span><span class="o">=</span><span class="s1">&#39;fields&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">fasttrack</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;structure&#39;</span><span class="p">,)</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">epygram 1.4.15 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../../epygram.html" >epygram</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2014 --- 2022, A.Mary, S.Riette.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.8.5.
    </div>
  </body>
</html>