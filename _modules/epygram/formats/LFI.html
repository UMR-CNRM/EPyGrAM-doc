
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>epygram.formats.LFI &#8212; epygram 1.4.14 documentation</title>
    <link rel="stylesheet" href="../../../_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../_static/language_data.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">epygram 1.4.14 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../../epygram.html" >epygram</a> &#187;</li>
          <li class="nav-item nav-item-3"><a href="../formats.html" accesskey="U">epygram.formats</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for epygram.formats.LFI</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1"># Copyright (c) Météo France (2014-)</span>
<span class="c1"># This software is governed by the CeCILL-C license under French law.</span>
<span class="c1"># http://www.cecill.info</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Contains the class to handle LFI format.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span><span class="p">,</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">unicode_literals</span><span class="p">,</span> <span class="n">division</span>

<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">six</span>

<span class="kn">import</span> <span class="nn">footprints</span>
<span class="kn">from</span> <span class="nn">footprints</span> <span class="k">import</span> <span class="n">FPDict</span><span class="p">,</span> <span class="n">proxy</span> <span class="k">as</span> <span class="n">fpx</span>
<span class="kn">from</span> <span class="nn">bronx.datagrip.misc</span> <span class="k">import</span> <span class="n">read_dict_in_CSV</span>

<span class="kn">from</span> <span class="nn">arpifs4py</span> <span class="k">import</span> <span class="n">wlfi</span>

<span class="kn">from</span> <span class="nn">epygram</span> <span class="k">import</span> <span class="n">config</span><span class="p">,</span> <span class="n">epygramError</span><span class="p">,</span> <span class="n">util</span>
<span class="kn">from</span> <span class="nn">epygram.util</span> <span class="k">import</span> <span class="n">Angle</span>
<span class="kn">from</span> <span class="nn">epygram.base</span> <span class="k">import</span> <span class="n">FieldSet</span><span class="p">,</span> <span class="n">FieldValidity</span><span class="p">,</span> <span class="n">Field</span>
<span class="kn">from</span> <span class="nn">epygram.resources</span> <span class="k">import</span> <span class="n">FileResource</span>
<span class="kn">from</span> <span class="nn">epygram.fields</span> <span class="k">import</span> <span class="n">H2DField</span><span class="p">,</span> <span class="n">MiscField</span><span class="p">,</span> <span class="n">D3Field</span>
<span class="kn">from</span> <span class="nn">epygram.geometries.VGeometry</span> <span class="k">import</span> <span class="n">hybridH2altitude</span><span class="p">,</span> <span class="n">hybridH2pressure</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;LFI&#39;</span><span class="p">]</span>

<span class="n">epylog</span> <span class="o">=</span> <span class="n">footprints</span><span class="o">.</span><span class="n">loggers</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="n">gridIndicatorDict</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:(</span><span class="s1">&#39;__unknown__&#39;</span><span class="p">,</span> <span class="s1">&#39;__unknown__&#39;</span><span class="p">),</span>
                     <span class="mi">1</span><span class="p">:(</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="s1">&#39;mass&#39;</span><span class="p">),</span>
                     <span class="mi">2</span><span class="p">:(</span><span class="s1">&#39;center-left&#39;</span><span class="p">,</span> <span class="s1">&#39;mass&#39;</span><span class="p">),</span>
                     <span class="mi">3</span><span class="p">:(</span><span class="s1">&#39;lower-center&#39;</span><span class="p">,</span> <span class="s1">&#39;mass&#39;</span><span class="p">),</span>
                     <span class="mi">4</span><span class="p">:(</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="s1">&#39;flux&#39;</span><span class="p">),</span>
                     <span class="mi">5</span><span class="p">:(</span><span class="s1">&#39;lower-left&#39;</span><span class="p">,</span> <span class="s1">&#39;mass&#39;</span><span class="p">),</span>
                     <span class="mi">6</span><span class="p">:(</span><span class="s1">&#39;center-left&#39;</span><span class="p">,</span> <span class="s1">&#39;flux&#39;</span><span class="p">),</span>
                     <span class="mi">7</span><span class="p">:(</span><span class="s1">&#39;lower-center&#39;</span><span class="p">,</span> <span class="s1">&#39;flux&#39;</span><span class="p">),</span>
                     <span class="mi">8</span><span class="p">:(</span><span class="s1">&#39;lower-left&#39;</span><span class="p">,</span> <span class="s1">&#39;flux&#39;</span><span class="p">)}</span>


<span class="k">def</span> <span class="nf">parse_LFIstr_totuple</span><span class="p">(</span><span class="n">strfid</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Parse and return a tuple LFI fid from a string.&quot;&quot;&quot;</span>
    <span class="n">fid</span> <span class="o">=</span> <span class="n">strfid</span>
    <span class="k">if</span> <span class="n">fid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;(&#39;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">epygramError</span><span class="p">(</span><span class="s2">&quot;LFI fid must begin with &#39;(&#39;&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fid</span> <span class="o">=</span> <span class="n">fid</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="k">if</span> <span class="n">fid</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;)&#39;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">epygramError</span><span class="p">(</span><span class="s2">&quot;LFI fid must begin end &#39;(&#39;&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fid</span> <span class="o">=</span> <span class="n">fid</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">fid</span> <span class="o">=</span> <span class="n">fid</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fid</span><span class="p">)):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">fid</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">fid</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">fid</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;None&#39;</span><span class="p">:</span>
                <span class="n">fid</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">fid</span><span class="p">)</span>


<span class="n">cache_inquire</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">cache_inquire_re</span> <span class="o">=</span> <span class="p">{}</span>


<span class="k">def</span> <span class="nf">inquire_field_dict</span><span class="p">(</span><span class="n">fieldname</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the info contained in the LFI _field_dict for the requested field.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">fieldname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cache_inquire</span><span class="p">:</span>
        <span class="n">matching_field</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">fd</span> <span class="ow">in</span> <span class="n">LFI</span><span class="o">.</span><span class="n">_field_dict</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">fd</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cache_inquire_re</span><span class="p">:</span>
                <span class="n">dictitem</span> <span class="o">=</span> <span class="n">fd</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
                <span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">subn</span><span class="p">(</span><span class="s1">&#39;\.&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;\.&#39;</span><span class="p">,</span> <span class="n">dictitem</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># protect &#39;.&#39;</span>
                <span class="n">pattern</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">)</span>  <span class="c1"># change unix &#39;?&#39; to python &#39;.&#39; (any char)</span>
                <span class="n">pattern</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="s1">&#39;.*&#39;</span><span class="p">)</span>  <span class="c1"># change unix &#39;*&#39; to python &#39;.*&#39; (several any char)</span>
                <span class="n">pattern</span> <span class="o">+=</span> <span class="s1">&#39;(?!.)&#39;</span>
                <span class="n">cache_inquire_re</span><span class="p">[</span><span class="n">fd</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cache_inquire_re</span><span class="p">[</span><span class="n">fd</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">fieldname</span><span class="p">):</span>
                <span class="n">matching_field</span> <span class="o">=</span> <span class="n">fd</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">matching_field</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">epylog</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;field &#39;&quot;</span> <span class="o">+</span> <span class="n">fieldname</span> <span class="o">+</span> <span class="s2">&quot;&#39; is not referenced in Field_Dict_LFI. Assume its type being a MiscField.&quot;</span><span class="p">)</span>
            <span class="n">matching_field</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span><span class="n">fieldname</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">:</span><span class="s1">&#39;Misc&#39;</span><span class="p">,</span> <span class="s1">&#39;nature&#39;</span><span class="p">:</span><span class="s1">&#39;float&#39;</span><span class="p">,</span> <span class="s1">&#39;dimension&#39;</span><span class="p">:</span><span class="s1">&#39;1&#39;</span><span class="p">}</span>

        <span class="n">cache_inquire</span><span class="p">[</span><span class="n">fieldname</span><span class="p">]</span> <span class="o">=</span> <span class="n">matching_field</span>

    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">cache_inquire</span><span class="p">[</span><span class="n">fieldname</span><span class="p">])</span>


<span class="k">def</span> <span class="nf">_complete_generic_fid_from_fid</span><span class="p">(</span><span class="n">generic_fid</span><span class="p">,</span> <span class="n">fieldidentifier</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Complete a generic fid with information of fieldidentifier.&quot;&quot;&quot;</span>
    <span class="c1"># &#39;level&#39;</span>
    <span class="k">if</span> <span class="s1">&#39;level&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">generic_fid</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fieldidentifier</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="n">fieldname</span><span class="p">,</span> <span class="n">level</span> <span class="o">=</span> <span class="n">fieldidentifier</span>
            <span class="n">haslevel</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fieldname</span> <span class="o">=</span> <span class="n">fieldidentifier</span>
            <span class="n">haslevel</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">field_info</span> <span class="o">=</span> <span class="n">inquire_field_dict</span><span class="p">(</span><span class="n">fieldname</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">field_info</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;H2D&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;level&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">field_info</span><span class="p">:</span>
                <span class="n">generic_fid</span><span class="p">[</span><span class="s1">&#39;level&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">elif</span> <span class="n">haslevel</span><span class="p">:</span>
            <span class="n">generic_fid</span><span class="p">[</span><span class="s1">&#39;level&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">level</span>
        <span class="k">elif</span> <span class="n">field_info</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;3D&#39;</span><span class="p">:</span>
            <span class="k">pass</span>  <span class="c1"># multilevel in true3d</span>
        <span class="k">elif</span> <span class="n">field_info</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Misc&#39;</span><span class="p">:</span>
            <span class="k">pass</span>  <span class="c1"># No level to add to the generic_fid</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">epygramError</span><span class="p">(</span><span class="s2">&quot;Must not happen...&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;productDefinitionTemplateNumber&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">generic_fid</span><span class="p">:</span>
        <span class="n">generic_fid</span><span class="p">[</span><span class="s1">&#39;productDefinitionTemplateNumber&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">generic_fid</span>


<div class="viewcode-block" id="LFI"><a class="viewcode-back" href="../../../library/LFI.html#epygram.formats.LFI.LFI">[docs]</a><span class="k">class</span> <span class="nc">LFI</span><span class="p">(</span><span class="n">FileResource</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class implementing all specificities for LFI resource format.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_footprint</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">attr</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
            <span class="nb">format</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">values</span><span class="o">=</span><span class="nb">set</span><span class="p">([</span><span class="s1">&#39;LFI&#39;</span><span class="p">]),</span>
                <span class="n">default</span><span class="o">=</span><span class="s1">&#39;LFI&#39;</span><span class="p">),</span>
            <span class="n">compressed</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="nb">bool</span><span class="p">,</span>
                <span class="n">access</span><span class="o">=</span><span class="s1">&#39;rwx&#39;</span><span class="p">,</span>
                <span class="n">info</span><span class="o">=</span><span class="s2">&quot;Compression flag.&quot;</span><span class="p">),</span>
            <span class="n">true3d</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">info</span><span class="o">=</span><span class="s2">&quot;If False, 3D fields are seen as a collection of H2D fields&quot;</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="nb">bool</span><span class="p">),</span>
            <span class="n">moveOnMass</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">info</span><span class="o">=</span><span class="s2">&quot;If True, 3d fields are put on mass levels&quot;</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># the Field Dictionary gathers info about fields nature</span>
    <span class="n">CSV_field_dictionaries</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">LFI_field_dictionaries_csv</span>
    <span class="c1"># syntax: _field_dict = [{&#39;name&#39;:&#39;fieldname1&#39;, &#39;type&#39;:&#39;...&#39;, ...}, {&#39;name&#39;:&#39;fieldname2&#39;, &#39;type&#39;:&#39;...&#39;, ...}, ...]</span>
    <span class="n">_field_dict</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_LFIsoft_init</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize the LFI software maximum dimensions.&quot;&quot;&quot;</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_LFIsoftware_cst</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;JPXKRK&#39;</span><span class="p">:</span><span class="mi">100</span><span class="p">}</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_read_field_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">fd_abspath</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reads the CSV fields dictionary of the format.&quot;&quot;&quot;</span>
        <span class="n">field_dict</span><span class="p">,</span> <span class="n">file_priority</span> <span class="o">=</span> <span class="n">read_dict_in_CSV</span><span class="p">(</span><span class="n">fd_abspath</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">file_priority</span> <span class="o">==</span> <span class="s1">&#39;main&#39;</span><span class="p">:</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">_field_dict</span> <span class="o">=</span> <span class="n">field_dict</span>
        <span class="k">elif</span> <span class="n">file_priority</span> <span class="o">==</span> <span class="s1">&#39;underwrite&#39;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">fd</span> <span class="ow">in</span> <span class="n">field_dict</span><span class="p">:</span>
                <span class="n">found</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">for</span> <span class="n">cfd</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_field_dict</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">fd</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">cfd</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]:</span>
                        <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">break</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">found</span><span class="p">:</span>
                    <span class="bp">cls</span><span class="o">.</span><span class="n">_field_dict</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">file_priority</span> <span class="o">==</span> <span class="s1">&#39;overwrite&#39;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">cfd</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_field_dict</span><span class="p">:</span>
                <span class="n">found</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">for</span> <span class="n">fd</span> <span class="ow">in</span> <span class="n">field_dict</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">fd</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">cfd</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]:</span>
                        <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">break</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">found</span><span class="p">:</span>
                    <span class="n">field_dict</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cfd</span><span class="p">)</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">_field_dict</span> <span class="o">=</span> <span class="n">field_dict</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">isopen</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validity</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compressed</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># At creation of the first LFI, initialize LFI._field_dict</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_field_dict</span> <span class="o">==</span> <span class="p">[]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_read_field_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CSV_field_dictionaries</span><span class="p">[</span><span class="s1">&#39;default&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CSV_field_dictionaries</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">]):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_read_field_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CSV_field_dictionaries</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">])</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">LFI</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># Initialization of LFI software (if necessary):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_LFIsoftware_cst&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_LFIsoft_init</span><span class="p">()</span>

        <span class="c1"># Compression</span>
        <span class="c1"># In a and r modes, compression is read in file</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">openmode</span> <span class="o">==</span> <span class="s1">&#39;w&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_compressed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compressed</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">fmtdelayedopen</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>

        <span class="c1"># cache for records</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_listLFInamesCache</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="LFI.open"><a class="viewcode-back" href="../../../library/LFI.html#epygram.formats.LFI.LFI.open">[docs]</a>    <span class="k">def</span> <span class="nf">open</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">openmode</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Opens a LFI with ifsaux&#39; LFIOUV, and initializes some attributes.</span>

<span class="sd">        :param openmode: optional, to open with a specific openmode, eventually</span>
<span class="sd">                         different from the one specified at initialization.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">LFI</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">openmode</span><span class="o">=</span><span class="n">openmode</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">openmode</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">):</span>
            <span class="c1"># LFI already exists</span>
            <span class="c1"># open, getting logical unit</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_unit</span> <span class="o">=</span> <span class="n">wlfi</span><span class="o">.</span><span class="n">wlfiouv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">abspath</span><span class="p">,</span> <span class="s1">&#39;OLD&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">RuntimeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">isopen</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">empty</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">openmode</span> <span class="o">==</span> <span class="s1">&#39;w&#39;</span><span class="p">:</span>
            <span class="c1"># new LFI</span>
            <span class="c1"># open, getting logical unit</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">abspath</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">&#39;This file already exist: &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">abspath</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_unit</span> <span class="o">=</span> <span class="n">wlfi</span><span class="o">.</span><span class="n">wlfiouv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">abspath</span><span class="p">,</span> <span class="s1">&#39;NEW&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">isopen</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">empty</span> <span class="o">=</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="LFI.close"><a class="viewcode-back" href="../../../library/LFI.html#epygram.formats.LFI.LFI.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Closes a LFI with ifsaux&#39; LFIFER.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isopen</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">wlfi</span><span class="o">.</span><span class="n">wlfifer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_unit</span><span class="p">,</span> <span class="s1">&#39;KEEP&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;closing &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">abspath</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">isopen</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="c1"># Cleanings</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">openmode</span> <span class="o">==</span> <span class="s1">&#39;w&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">abspath</span><span class="p">)</span></div>

<span class="c1">################</span>
<span class="c1"># ABOUT FIELDS #</span>
<span class="c1">################</span>
    <span class="k">def</span> <span class="nf">_get_generic_fid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fieldidentifier</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a generic fid from fieldidentifier (via Field Dict).&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">true3d</span><span class="p">:</span>
            <span class="n">fieldname</span> <span class="o">=</span> <span class="n">fieldidentifier</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fieldname</span> <span class="o">=</span> <span class="n">fieldidentifier</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">fid</span> <span class="o">=</span> <span class="n">inquire_field_dict</span><span class="p">(</span><span class="n">fieldname</span><span class="p">)</span>
        <span class="n">fid</span> <span class="o">=</span> <span class="n">_complete_generic_fid_from_fid</span><span class="p">(</span><span class="n">fid</span><span class="p">,</span> <span class="n">fieldidentifier</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fid</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;3D&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_read_geometry</span><span class="p">()</span>
            <span class="n">fid</span><span class="p">[</span><span class="s1">&#39;typeOfFirstFixedSurface&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">vcoordinate</span><span class="o">.</span><span class="n">typeoffirstfixedsurface</span>
        <span class="n">fid</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">)</span>
        <span class="n">fid</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fid</span>

<div class="viewcode-block" id="LFI.find_fields_in_resource"><a class="viewcode-back" href="../../../library/LFI.html#epygram.formats.LFI.LFI.find_fields_in_resource">[docs]</a>    <span class="k">def</span> <span class="nf">find_fields_in_resource</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fieldtype</span><span class="o">=</span><span class="p">[],</span> <span class="n">generic</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a list of the fields from resource whose identifier match the given seed.</span>

<span class="sd">        :param seed: might be:\n</span>
<span class="sd">          - a tuple of regular expressions,</span>
<span class="sd">          - a string meant to be converted to a tuple</span>
<span class="sd">          - a list of regular expressions tuples</span>
<span class="sd">          - *None*. If *None* (default), returns the list of all fields in resource.</span>
<span class="sd">          If self.true3d: tuples are replaced by string</span>
<span class="sd">        :param fieldtype: optional, among (&#39;H2D&#39;, &#39;Misc&#39;) or a list of these strings.</span>
<span class="sd">          If provided, filters out the fields not of the given types.</span>
<span class="sd">        :param generic: if True, returns a list of tuples (fieldname, generic fid) of</span>
<span class="sd">          the fields.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fieldtype</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">fieldtypeslist</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">fieldtype</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fieldtypeslist</span> <span class="o">=</span> <span class="p">[</span><span class="n">fieldtype</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">true3d</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;H2D&#39;</span> <span class="ow">in</span> <span class="n">fieldtypeslist</span> <span class="ow">and</span> <span class="s1">&#39;3D&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fieldtypeslist</span><span class="p">:</span>
                <span class="c1"># 3D field will appear as 2D field by readfield method</span>
                <span class="c1"># If you look for 2D fields, you must also take 3D fields</span>
                <span class="n">fieldtypeslist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;3D&#39;</span><span class="p">)</span>
        <span class="n">fieldslist</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">def</span> <span class="nf">fill_fieldslist</span><span class="p">(</span><span class="n">tmplist</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">tmplist</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">fieldtypeslist</span> <span class="o">==</span> <span class="p">[]</span> <span class="ow">or</span> <span class="n">inquire_field_dict</span><span class="p">(</span><span class="n">f</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">true3d</span> <span class="k">else</span> <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">fieldtypeslist</span><span class="p">:</span>
                    <span class="n">fieldslist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">seed</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tmplist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">listfields</span><span class="p">()</span>
            <span class="n">fill_fieldslist</span><span class="p">(</span><span class="n">tmplist</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">seed</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">true3d</span><span class="p">)</span> <span class="ow">or</span> \
             <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">seed</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">true3d</span><span class="p">):</span>
            <span class="n">tmplist</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">find_re_in_list</span><span class="p">(</span><span class="n">seed</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">listfields</span><span class="p">())</span>
            <span class="n">fill_fieldslist</span><span class="p">(</span><span class="n">tmplist</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">seed</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">tmplist</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">seed</span><span class="p">:</span>
                <span class="n">tmplist</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_fields_in_resource</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="n">s</span><span class="p">)</span>
<span class="c1">#                if isinstance(s, six.string_types):</span>
<span class="c1">#                    s = parse_LFIstr_totuple(s)</span>
<span class="c1">#                tmplist += util.find_re_in_list(s, self.listfields())</span>
            <span class="n">fill_fieldslist</span><span class="p">(</span><span class="n">tmplist</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">seed</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
            <span class="n">seed</span> <span class="o">=</span> <span class="n">parse_LFIstr_totuple</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
            <span class="n">tmplist</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">find_re_in_list</span><span class="p">(</span><span class="n">seed</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">listfields</span><span class="p">())</span>
            <span class="n">fill_fieldslist</span><span class="p">(</span><span class="n">tmplist</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">epygramError</span><span class="p">(</span><span class="s2">&quot;seed must be a tuple, a list, None or a string&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fieldslist</span> <span class="o">==</span> <span class="p">[]:</span>
            <span class="k">raise</span> <span class="n">epygramError</span><span class="p">(</span><span class="s2">&quot;no field matching &#39;&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&#39; was found in resource &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">abspath</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">generic</span><span class="p">:</span>
            <span class="n">fieldslist</span> <span class="o">=</span> <span class="p">[(</span><span class="n">f</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_generic_fid</span><span class="p">(</span><span class="n">f</span><span class="p">))</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fieldslist</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">fieldslist</span></div>

<div class="viewcode-block" id="LFI.listfields"><a class="viewcode-back" href="../../../library/LFI.html#epygram.formats.LFI.LFI.listfields">[docs]</a>    <span class="k">def</span> <span class="nf">listfields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a list containing the LFI identifiers of all the fields of the</span>
<span class="sd">        resource.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">LFI</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">listfields</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

    <span class="nd">@FileResource</span><span class="o">.</span><span class="n">_openbeforedelayed</span>
    <span class="k">def</span> <span class="nf">_listfields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">complete</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Actual listfields() method for LFI.</span>

<span class="sd">        :param complete: - if True method returns a list of {&#39;LFI&#39;:LFI_fid,</span>
<span class="sd">                           &#39;generic&#39;:generic_fid}</span>
<span class="sd">                         - if False method return a list of LFI_fid</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fieldslist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">fieldname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_listLFInames</span><span class="p">():</span>
            <span class="n">field_info</span> <span class="o">=</span> <span class="n">inquire_field_dict</span><span class="p">(</span><span class="n">fieldname</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">field_info</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;3D&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">true3d</span><span class="p">:</span>
                    <span class="n">fieldslist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fieldname</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_read_geometry</span><span class="p">()</span>
                    <span class="n">kmax</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">vcoordinate</span><span class="o">.</span><span class="n">grid</span><span class="p">[</span><span class="s1">&#39;gridlevels&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="k">for</span> <span class="n">level</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">kmax</span><span class="p">):</span>
                        <span class="n">fieldslist</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">fieldname</span><span class="p">,</span> <span class="n">level</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">field_info</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;H2D&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">true3d</span><span class="p">:</span>
                    <span class="n">fieldslist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fieldname</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fieldslist</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">fieldname</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">true3d</span><span class="p">:</span>
                    <span class="n">fieldslist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fieldname</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fieldslist</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">fieldname</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">complete</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[{</span><span class="s1">&#39;LFI&#39;</span><span class="p">:</span><span class="n">f</span><span class="p">,</span> <span class="s1">&#39;generic&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_generic_fid</span><span class="p">(</span><span class="n">f</span><span class="p">)}</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fieldslist</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">fieldslist</span>

    <span class="nd">@FileResource</span><span class="o">.</span><span class="n">_openbeforedelayed</span>
    <span class="k">def</span> <span class="nf">_listLFInames</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;List of LFI article names contained in file.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_listLFInamesCache</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">records_number</span> <span class="o">=</span> <span class="n">wlfi</span><span class="o">.</span><span class="n">wlfinaf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_unit</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">wlfi</span><span class="o">.</span><span class="n">wlfipos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_unit</span><span class="p">)</span>  <span class="c1"># rewind</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_listLFInamesCache</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">records_number</span><span class="p">):</span>
                <span class="n">fname</span> <span class="o">=</span> <span class="n">wlfi</span><span class="o">.</span><span class="n">wlficas</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_unit</span><span class="p">,</span> <span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_listLFInamesCache</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_listLFInamesCache</span>

<div class="viewcode-block" id="LFI.sortfields"><a class="viewcode-back" href="../../../library/LFI.html#epygram.formats.LFI.LFI.sortfields">[docs]</a>    <span class="k">def</span> <span class="nf">sortfields</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a sorted list of fields with regards to their name and nature,</span>
<span class="sd">        as a dict of lists.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">listMisc</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">list3D</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">list2D</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">true3d</span><span class="p">:</span>
            <span class="n">fieldlist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">listfields</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fieldlist</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">listfields</span><span class="p">()]</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fieldlist</span><span class="p">:</span>
            <span class="n">info</span> <span class="o">=</span> <span class="n">inquire_field_dict</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;H2D&#39;</span><span class="p">:</span>
                <span class="n">list2D</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;3D&#39;</span><span class="p">:</span>
                <span class="n">list3D</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">listMisc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>

        <span class="c1"># sort</span>
        <span class="n">list2D</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="n">list3D</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="n">listMisc</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

        <span class="n">outlists</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;3D fields&#39;</span><span class="p">:</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">list3D</span><span class="p">)),</span>
                    <span class="s1">&#39;2D fields&#39;</span><span class="p">:</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">list2D</span><span class="p">)),</span>
                    <span class="s1">&#39;Misc-fields&#39;</span><span class="p">:</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">listMisc</span><span class="p">))}</span>

        <span class="k">return</span> <span class="n">outlists</span></div>

    <span class="nd">@FileResource</span><span class="o">.</span><span class="n">_openbeforedelayed</span>
    <span class="k">def</span> <span class="nf">readfield</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fieldidentifier</span><span class="p">,</span> <span class="n">getdata</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reads one field, given its identifier (tuple (LFI name, level)), and returns a Field instance.</span>
<span class="sd">        Interface to Fortran routines from &#39;ifsaux&#39;.</span>

<span class="sd">        :param fieldidentifier: &quot;LFI fieldname&quot; if true3d, else (LFI fieldname, level).</span>
<span class="sd">        :param getdata: optional, if *False*, only metadata are read, the field do not contain data.</span>
<span class="sd">                        Default is *True*.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">true3d</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fieldidentifier</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">epygramError</span><span class="p">(</span><span class="s2">&quot;fieldidentifier of a LFI field is a string (when resource opened in true3d).&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fieldidentifier</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
                <span class="n">fieldidentifier</span> <span class="o">=</span> <span class="n">parse_LFIstr_totuple</span><span class="p">(</span><span class="n">fieldidentifier</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fieldidentifier</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">fieldidentifier</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">epygramError</span><span class="p">(</span><span class="s2">&quot;fieldidentifier of a LFI field is a tuple (name, level) (when resource not opened in true3d).&quot;</span><span class="p">)</span>

        <span class="c1"># Get field info</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">true3d</span><span class="p">:</span>
            <span class="n">fieldname</span> <span class="o">=</span> <span class="n">fieldidentifier</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fieldname</span><span class="p">,</span> <span class="n">level</span> <span class="o">=</span> <span class="n">fieldidentifier</span>
        <span class="n">field_info</span> <span class="o">=</span> <span class="n">inquire_field_dict</span><span class="p">(</span><span class="n">fieldname</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">field_info</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;H2D&#39;</span><span class="p">,</span> <span class="s1">&#39;3D&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_read_geometry</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">validity</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_read_validity</span><span class="p">()</span>

            <span class="c1"># Make geometry object</span>
            <span class="n">kwargs_geom</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">structure</span><span class="o">=</span><span class="n">field_info</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">true3d</span> <span class="k">else</span> <span class="s1">&#39;H2D&#39;</span><span class="p">,</span>
                               <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                               <span class="n">grid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">grid</span><span class="p">,</span>
                               <span class="n">dimensions</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">dimensions</span><span class="p">,</span>
                               <span class="n">geoid</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">LFI_default_geoid</span><span class="p">,</span>
                               <span class="n">position_on_grid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                               <span class="n">projection</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">projection</span>  <span class="c1"># Also used for academic geometries</span>
                               <span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">vcoordinate</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># vertical geometry</span>
                <span class="n">kwargs_vcoord</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;structure&#39;</span><span class="p">:</span> <span class="s1">&#39;V&#39;</span><span class="p">,</span>
                                 <span class="s1">&#39;typeoffirstfixedsurface&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">vcoordinate</span><span class="o">.</span><span class="n">typeoffirstfixedsurface</span><span class="p">,</span>
                                 <span class="s1">&#39;position_on_grid&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">vcoordinate</span><span class="o">.</span><span class="n">position_on_grid</span><span class="p">,</span>
                                 <span class="s1">&#39;grid&#39;</span><span class="p">:</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">vcoordinate</span><span class="o">.</span><span class="n">grid</span><span class="p">),</span>
                                 <span class="s1">&#39;levels&#39;</span><span class="p">:</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">vcoordinate</span><span class="o">.</span><span class="n">levels</span><span class="p">)}</span>
                <span class="n">field_info</span> <span class="o">=</span> <span class="n">_complete_generic_fid_from_fid</span><span class="p">(</span><span class="n">field_info</span><span class="p">,</span> <span class="n">fieldidentifier</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">field_info</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="s1">&#39;typeOfFirstFixedSurface&#39;</span><span class="p">:</span>
                        <span class="n">kwargs_vcoord</span><span class="p">[</span><span class="s1">&#39;typeoffirstfixedsurface&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">field_info</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                    <span class="k">elif</span> <span class="n">k</span> <span class="o">==</span> <span class="s1">&#39;level&#39;</span><span class="p">:</span>
                        <span class="n">kwargs_vcoord</span><span class="p">[</span><span class="s1">&#39;levels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">field_info</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span>
                <span class="k">if</span> <span class="n">field_info</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;3D&#39;</span><span class="p">:</span>
                    <span class="n">kwargs_vcoord</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;grid&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="c1"># Get data if requested or only metadata</span>
        <span class="n">field_length</span> <span class="o">=</span> <span class="n">wlfi</span><span class="o">.</span><span class="n">wlfinfo</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_unit</span><span class="p">,</span> <span class="n">fieldname</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># Record length</span>
        <span class="k">if</span> <span class="n">field_length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">epygramError</span><span class="p">(</span><span class="s2">&quot;This record does not exist.&quot;</span><span class="p">)</span>
        <span class="n">lengthToRead</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">field_length</span><span class="p">,</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">LFI</span><span class="o">.</span><span class="n">_LFIsoftware_cst</span><span class="p">[</span><span class="s1">&#39;JPXKRK&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">getdata</span> <span class="k">else</span> <span class="n">field_length</span>  <span class="c1"># Length needed</span>
        <span class="n">rawData</span> <span class="o">=</span> <span class="n">wlfi</span><span class="o">.</span><span class="n">wlfilec</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_unit</span><span class="p">,</span> <span class="n">fieldname</span><span class="p">,</span> <span class="n">lengthToRead</span><span class="p">,</span> <span class="n">getdata</span><span class="p">)</span>  <span class="c1"># Reading</span>
        <span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="o">=</span> <span class="n">gridIndicatorDict</span><span class="p">[</span><span class="n">rawData</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="n">gridIndicator</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;vertical&#39;</span><span class="p">:</span><span class="n">v</span><span class="p">,</span> <span class="s1">&#39;horizontal&#39;</span><span class="p">:</span><span class="n">h</span><span class="p">}</span>
        <span class="n">comment_length</span> <span class="o">=</span> <span class="n">rawData</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">comment_length</span> <span class="o">&gt;</span> <span class="n">LFI</span><span class="o">.</span><span class="n">_LFIsoftware_cst</span><span class="p">[</span><span class="s1">&#39;JPXKRK&#39;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="n">epygramError</span><span class="p">(</span><span class="s2">&quot;comment length is superior to the limit.&quot;</span><span class="p">)</span>
        <span class="n">comment</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">rawData</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="n">comment_length</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]:</span>
            <span class="n">comment</span> <span class="o">+=</span> <span class="n">six</span><span class="o">.</span><span class="n">unichr</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="c1"># comment = comment.encode(errors=&#39;replace&#39;)  # CLEANME: now fixed with footprints from Vortex &gt; v1.2.3</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">rawData</span><span class="p">[</span><span class="n">comment_length</span> <span class="o">+</span> <span class="mi">2</span><span class="p">:]</span>
        <span class="k">if</span> <span class="n">getdata</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compressed</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">fieldname</span> <span class="o">!=</span> <span class="s1">&#39;LFI_COMPRESSED&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_read_compression</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compressed</span><span class="p">:</span>
                <span class="p">(</span><span class="n">lengthAfter</span><span class="p">,</span> <span class="n">compressionType</span><span class="p">)</span> <span class="o">=</span> <span class="n">wlfi</span><span class="o">.</span><span class="n">wget_compheader</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">data</span><span class="p">,</span> <span class="n">lengthToRead</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">lengthAfter</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">wlfi</span><span class="o">.</span><span class="n">wdecompress_field</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">data</span><span class="p">,</span> <span class="n">compressionType</span><span class="p">,</span> <span class="n">lengthAfter</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">field_info</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Misc&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">field_info</span><span class="p">[</span><span class="s1">&#39;dimension&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">field_info</span><span class="p">[</span><span class="s1">&#39;nature&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;int&#39;</span><span class="p">:</span>
                        <span class="n">dataOut</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">elif</span> <span class="n">field_info</span><span class="p">[</span><span class="s1">&#39;nature&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;str&#39;</span><span class="p">:</span>
                        <span class="n">dataOut</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                        <span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                            <span class="n">dataOut</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">field_info</span><span class="p">[</span><span class="s1">&#39;nature&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;bool&#39;</span><span class="p">:</span>
                        <span class="n">dataOut</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="k">elif</span> <span class="n">field_info</span><span class="p">[</span><span class="s1">&#39;nature&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;float&#39;</span><span class="p">:</span>
                        <span class="n">dataOut</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="s1">&#39;float64&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;reading of datatype &quot;</span> <span class="o">+</span> <span class="n">field_info</span><span class="p">[</span><span class="s1">&#39;nature&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">field_info</span><span class="p">[</span><span class="s1">&#39;nature&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;int&#39;</span><span class="p">:</span>
                        <span class="n">dataOut</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">field_info</span><span class="p">[</span><span class="s1">&#39;nature&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;float&#39;</span><span class="p">:</span>
                        <span class="n">dataOut</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="s1">&#39;float64&#39;</span><span class="p">)[:])</span>
                    <span class="k">elif</span> <span class="n">field_info</span><span class="p">[</span><span class="s1">&#39;nature&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;str&#39;</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;reading of datatype &quot;</span> <span class="o">+</span>
                                                  <span class="n">field_info</span><span class="p">[</span><span class="s1">&#39;nature&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; array.&quot;</span><span class="p">)</span>
                        <span class="c1"># TOBECHECKED: table of int(str) = table of tables ???</span>
                        <span class="n">dataOut</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">field_info</span><span class="p">[</span><span class="s1">&#39;nature&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;bool&#39;</span><span class="p">:</span>
                        <span class="n">dataOut</span> <span class="o">=</span> <span class="n">data</span> <span class="o">!=</span> <span class="mi">0</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;reading of datatype &quot;</span> <span class="o">+</span> <span class="n">field_info</span><span class="p">[</span><span class="s1">&#39;nature&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; array.&quot;</span><span class="p">)</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">dataOut</span>
            <span class="k">elif</span> <span class="n">field_info</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;H2D&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">true3d</span><span class="p">)</span> <span class="ow">and</span> <span class="n">level</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">epygramError</span><span class="p">(</span><span class="s2">&quot;level must be 0 for a one-level field.&quot;</span><span class="p">)</span>
                <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">nature</span> <span class="o">=</span> <span class="n">field_info</span><span class="p">[</span><span class="s1">&#39;nature&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;nature&#39;</span> <span class="ow">in</span> <span class="n">field_info</span> <span class="k">else</span> <span class="s1">&#39;float&#39;</span>
                <span class="k">if</span> <span class="n">nature</span> <span class="o">==</span> <span class="s1">&#39;float&#39;</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="s1">&#39;float64&#39;</span><span class="p">)[</span><span class="n">offset</span><span class="p">:</span><span class="n">offset</span> <span class="o">+</span>
                                                            <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">]</span> <span class="o">*</span>
                                                            <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="s1">&#39;Y&#39;</span><span class="p">]])</span>
                <span class="k">elif</span> <span class="n">nature</span> <span class="o">==</span> <span class="s1">&#39;int&#39;</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">offset</span><span class="p">:</span><span class="n">offset</span> <span class="o">+</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">]</span> <span class="o">*</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="s1">&#39;Y&#39;</span><span class="p">]])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;reading of datatype &quot;</span> <span class="o">+</span> <span class="n">field_info</span><span class="p">[</span><span class="s1">&#39;nature&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; field.&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">field_info</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;3D&#39;</span><span class="p">:</span>
                <span class="n">kmax</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">vcoordinate</span><span class="o">.</span><span class="n">grid</span><span class="p">[</span><span class="s1">&#39;gridlevels&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span>

                <span class="k">if</span> <span class="n">gridIndicator</span><span class="p">[</span><span class="s1">&#39;vertical&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;flux&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">moveOnMass</span><span class="p">:</span>
                    <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">data3d</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="s1">&#39;float64&#39;</span><span class="p">)[</span><span class="n">offset</span><span class="p">:</span><span class="n">offset</span> <span class="o">+</span>
                                                              <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">]</span> <span class="o">*</span>
                                                              <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="s1">&#39;Y&#39;</span><span class="p">]</span> <span class="o">*</span>
                                                              <span class="n">kmax</span><span class="p">])</span>
                    <span class="n">data3d</span> <span class="o">=</span> <span class="n">data3d</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">kmax</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="s1">&#39;Y&#39;</span><span class="p">]))</span>
                    <span class="n">data3d</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">data3d</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="n">data3d</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="p">:])</span>  <span class="c1"># last level kept untouched</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">data3d</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">true3d</span><span class="p">:</span>
                    <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="s1">&#39;float64&#39;</span><span class="p">)[</span><span class="n">offset</span><span class="p">:</span><span class="n">offset</span> <span class="o">+</span>
                                                            <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">]</span> <span class="o">*</span>
                                                            <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="s1">&#39;Y&#39;</span><span class="p">]</span> <span class="o">*</span>
                                                            <span class="n">kmax</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">level</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">kmax</span><span class="p">):</span>
                        <span class="k">raise</span> <span class="n">epygramError</span><span class="p">(</span><span class="s2">&quot;level must be between 0 and kmax for a 3D field (level=&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">level</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;).&quot;</span><span class="p">)</span>
                    <span class="n">offset</span> <span class="o">=</span> <span class="n">level</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="s1">&#39;Y&#39;</span><span class="p">]</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="s1">&#39;float64&#39;</span><span class="p">)[</span><span class="n">offset</span><span class="p">:</span><span class="n">offset</span> <span class="o">+</span>
                                                            <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">]</span> <span class="o">*</span>
                                                            <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="s1">&#39;Y&#39;</span><span class="p">]])</span>

        <span class="k">if</span> <span class="n">field_info</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;3D&#39;</span> <span class="ow">and</span> <span class="n">gridIndicator</span><span class="p">[</span><span class="s1">&#39;vertical&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;flux&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">moveOnMass</span><span class="p">:</span>
            <span class="n">gridIndicator</span><span class="p">[</span><span class="s1">&#39;vertical&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;mass&#39;</span>

        <span class="c1"># Create field</span>
        <span class="k">if</span> <span class="n">field_info</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;H2D&#39;</span><span class="p">,</span> <span class="s1">&#39;3D&#39;</span><span class="p">]:</span>
            <span class="c1"># Create H2D field</span>
            <span class="n">fid</span> <span class="o">=</span> <span class="n">fieldname</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">true3d</span> <span class="k">else</span> <span class="p">(</span><span class="n">fieldname</span><span class="p">,</span> <span class="n">level</span><span class="p">)</span>
            <span class="n">fid</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">format</span><span class="p">:</span> <span class="n">fid</span><span class="p">,</span>
                   <span class="s1">&#39;generic&#39;</span><span class="p">:</span><span class="n">FPDict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_generic_fid</span><span class="p">(</span><span class="n">fid</span><span class="p">))</span>
                   <span class="p">}</span>
            <span class="n">kwargs_geom</span><span class="p">[</span><span class="s1">&#39;position_on_horizontal_grid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gridIndicator</span><span class="p">[</span><span class="s1">&#39;horizontal&#39;</span><span class="p">]</span>
            <span class="n">kwargs_vcoord</span><span class="p">[</span><span class="s1">&#39;position_on_grid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gridIndicator</span><span class="p">[</span><span class="s1">&#39;vertical&#39;</span><span class="p">]</span>
            <span class="n">kwargs_geom</span><span class="p">[</span><span class="s1">&#39;vcoordinate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fpx</span><span class="o">.</span><span class="n">geometry</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs_vcoord</span><span class="p">)</span>
            <span class="n">geometry</span> <span class="o">=</span> <span class="n">fpx</span><span class="o">.</span><span class="n">geometry</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs_geom</span><span class="p">)</span>
            <span class="n">field</span> <span class="o">=</span> <span class="n">fpx</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">fid</span><span class="o">=</span><span class="n">fid</span><span class="p">,</span>
                              <span class="n">structure</span><span class="o">=</span><span class="n">geometry</span><span class="o">.</span><span class="n">structure</span><span class="p">,</span>
                              <span class="n">geometry</span><span class="o">=</span><span class="n">geometry</span><span class="p">,</span> <span class="n">validity</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">validity</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(),</span>
                              <span class="n">processtype</span><span class="o">=</span><span class="s1">&#39;forecast&#39;</span><span class="p">,</span> <span class="n">comment</span><span class="o">=</span><span class="n">comment</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">field_info</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Misc&#39;</span><span class="p">:</span>
            <span class="c1"># Create Misc field</span>
            <span class="n">fid</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">format</span><span class="p">:</span> <span class="n">fieldname</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">true3d</span> <span class="k">else</span> <span class="p">(</span><span class="n">fieldname</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                   <span class="s1">&#39;generic&#39;</span><span class="p">:</span> <span class="n">FPDict</span><span class="p">()</span>
                   <span class="p">}</span>

            <span class="k">class</span> <span class="nc">empty</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
                <span class="k">pass</span>

            <span class="n">geometry</span> <span class="o">=</span> <span class="n">empty</span><span class="p">()</span>
            <span class="n">geometry</span><span class="o">.</span><span class="n">position_on_horizontal_grid</span> <span class="o">=</span> <span class="n">gridIndicator</span><span class="p">[</span><span class="s1">&#39;horizontal&#39;</span><span class="p">]</span>
            <span class="n">geometry</span><span class="o">.</span><span class="n">vcoordinate</span> <span class="o">=</span> <span class="n">empty</span><span class="p">()</span>
            <span class="n">geometry</span><span class="o">.</span><span class="n">vcoordinate</span><span class="o">.</span><span class="n">position_on_grid</span> <span class="o">=</span> <span class="n">gridIndicator</span><span class="p">[</span><span class="s1">&#39;vertical&#39;</span><span class="p">]</span>
            <span class="n">field</span> <span class="o">=</span> <span class="n">MiscField</span><span class="p">(</span><span class="n">fid</span><span class="o">=</span><span class="n">fid</span><span class="p">,</span> <span class="n">comment</span><span class="o">=</span><span class="n">comment</span><span class="p">)</span>
            <span class="n">field</span><span class="o">.</span><span class="n">geometry</span> <span class="o">=</span> <span class="n">geometry</span>
        <span class="k">if</span> <span class="n">getdata</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">field_info</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;H2D&#39;</span> <span class="ow">or</span> <span class="p">(</span><span class="n">field_info</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;3D&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">true3d</span><span class="p">):</span>
                <span class="c1"># Only one horizontal level</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">geometry</span><span class="o">.</span><span class="n">reshape_data</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">field_info</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;3D&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">true3d</span><span class="p">:</span>
                <span class="c1"># 3D data</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">vcoordinate</span><span class="o">.</span><span class="n">grid</span><span class="p">[</span><span class="s1">&#39;gridlevels&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="s1">&#39;Y&#39;</span><span class="p">]))</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">geometry</span><span class="o">.</span><span class="n">reshape_data</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s1">&#39;Z&#39;</span><span class="p">)</span>
            <span class="n">field</span><span class="o">.</span><span class="n">setdata</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">fieldname</span> <span class="o">==</span> <span class="s1">&#39;LFI_COMPRESSED&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_compressed</span> <span class="o">=</span> <span class="n">data</span>

        <span class="k">return</span> <span class="n">field</span>

<div class="viewcode-block" id="LFI.readfields"><a class="viewcode-back" href="../../../library/LFI.html#epygram.formats.LFI.LFI.readfields">[docs]</a>    <span class="k">def</span> <span class="nf">readfields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">requestedfields</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">getdata</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a :class:`epygram.base.FieldSet` containing requested fields read in the resource.</span>

<span class="sd">        :param requestedfields: might be \n</span>
<span class="sd">          - a tuple of regular expressions (e.g. (&#39;RVT&#39;, &#39;?&#39;)) or a regular expression (e.g. &#39;R?T&#39;) if true3d</span>
<span class="sd">          - a list of LFI fields identifiers with regular expressions (e.g. [(&#39;COVER???&#39;, 0), (&#39;RVT&#39;, &#39;*&#39;)])</span>
<span class="sd">          - if not specified, interpretated as all fields that will be found in resource</span>
<span class="sd">        :param getdata: optional, if *False*, only metadata are read, the fields do not contain data.</span>
<span class="sd">                        Default is *True*.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">requestedfields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_fields_in_resource</span><span class="p">(</span><span class="n">requestedfields</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">requestedfields</span> <span class="o">==</span> <span class="p">[]:</span>
            <span class="k">raise</span> <span class="n">epygramError</span><span class="p">(</span><span class="s2">&quot;unable to find requested fields in resource.&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">LFI</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">readfields</span><span class="p">(</span><span class="n">requestedfields</span><span class="p">,</span> <span class="n">getdata</span><span class="p">)</span></div>

<div class="viewcode-block" id="LFI.writefield"><a class="viewcode-back" href="../../../library/LFI.html#epygram.formats.LFI.LFI.writefield">[docs]</a>    <span class="k">def</span> <span class="nf">writefield</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write a field in the resource.</span>

<span class="sd">        :param field: a :class:`epygram.base.Field` instance or :class:`epygram.H2DField`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">Field</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">epygramError</span><span class="p">(</span><span class="s2">&quot;*field* must be a Field instance.&quot;</span><span class="p">)</span>

        <span class="n">fieldset</span> <span class="o">=</span> <span class="n">FieldSet</span><span class="p">()</span>
        <span class="n">fieldset</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writefields</span><span class="p">(</span><span class="n">fieldset</span><span class="p">)</span></div>

<div class="viewcode-block" id="LFI.writefields"><a class="viewcode-back" href="../../../library/LFI.html#epygram.formats.LFI.LFI.writefields">[docs]</a>    <span class="k">def</span> <span class="nf">writefields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fieldset</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write the fields of the *fieldset* in the resource.</span>

<span class="sd">        :param fieldset: must be a :class:`epygram.base.FieldSet` instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_listLFInamesCache</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fieldset</span><span class="p">,</span> <span class="n">FieldSet</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">epygramError</span><span class="p">(</span><span class="s2">&quot;&#39;fieldset&#39; argument must be of kind FieldSet.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">openmode</span> <span class="o">==</span> <span class="s1">&#39;r&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;cannot write field in a LFI with openmode &#39;r&#39;.&quot;</span><span class="p">)</span>

        <span class="n">specialValues</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">specialNames</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;LFI_COMPRESSED&#39;</span><span class="p">,</span> <span class="s1">&#39;CARTESIAN&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;LAT0&#39;</span><span class="p">,</span> <span class="s1">&#39;LON0&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;LATORI&#39;</span><span class="p">,</span> <span class="s1">&#39;LATOR&#39;</span><span class="p">,</span> <span class="s1">&#39;LONORI&#39;</span><span class="p">,</span> <span class="s1">&#39;LONOR&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;RPK&#39;</span><span class="p">,</span> <span class="s1">&#39;BETA&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;IMAX&#39;</span><span class="p">,</span> <span class="s1">&#39;JMAX&#39;</span><span class="p">,</span> <span class="s1">&#39;KMAX&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;XHAT&#39;</span><span class="p">,</span> <span class="s1">&#39;YHAT&#39;</span><span class="p">,</span> <span class="s1">&#39;ZHAT&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;DTEXP%TDATE&#39;</span><span class="p">,</span> <span class="s1">&#39;DTEXP%TIME&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;DTCUR%TDATE&#39;</span><span class="p">,</span> <span class="s1">&#39;DTCUR%TIME&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;SLEVE&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">true3d</span><span class="p">:</span>
            <span class="n">specialFields</span> <span class="o">=</span> <span class="n">specialNames</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">specialFields</span> <span class="o">=</span> <span class="p">[(</span><span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">specialNames</span><span class="p">]</span>
        <span class="n">specialFieldsComments</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;LFI_COMPRESSED&#39;</span><span class="p">:</span><span class="s1">&#39;Compressed articles&#39;</span><span class="p">,</span>
                                 <span class="s1">&#39;CARTESIAN&#39;</span><span class="p">:</span><span class="s1">&#39;Logical for cartesian geometry&#39;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span>
                                 <span class="s1">&#39;LAT0&#39;</span><span class="p">:</span><span class="s1">&#39;reference latitude for conformal projection (DEGREES)&#39;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span>
                                 <span class="s1">&#39;LON0&#39;</span><span class="p">:</span><span class="s1">&#39;reference longitude for conformal projection (DEGREES)&#39;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span>
                                 <span class="s1">&#39;LATORI&#39;</span><span class="p">:</span><span class="s1">&#39;DEGREES&#39;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span>
                                 <span class="s1">&#39;LATOR&#39;</span><span class="p">:</span><span class="s1">&#39;DEGREES&#39;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span>
                                 <span class="s1">&#39;LONORI&#39;</span><span class="p">:</span><span class="s1">&#39;DEGREES&#39;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span>
                                 <span class="s1">&#39;LONOR&#39;</span><span class="p">:</span><span class="s1">&#39;DEGREES&#39;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span>
                                 <span class="s1">&#39;RPK&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span>
                                 <span class="s1">&#39;BETA&#39;</span><span class="p">:</span><span class="s1">&#39;rotation angle (DEGREES)&#39;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span>
                                 <span class="s1">&#39;IMAX&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span>
                                 <span class="s1">&#39;JMAX&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span>
                                 <span class="s1">&#39;KMAX&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span>
                                 <span class="s1">&#39;XHAT&#39;</span><span class="p">:</span><span class="s1">&#39;Position x in the conformal or cartesian plane (METERS)&#39;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span>
                                 <span class="s1">&#39;YHAT&#39;</span><span class="p">:</span><span class="s1">&#39;Position y in the conformal or cartesian plane (METERS)&#39;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span>
                                 <span class="s1">&#39;ZHAT&#39;</span><span class="p">:</span><span class="s1">&#39;height level without orography (METERS)&#39;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span>
                                 <span class="s1">&#39;DTEXP%TDATE&#39;</span><span class="p">:</span><span class="s1">&#39;YYYYMMDD&#39;</span><span class="p">,</span>
                                 <span class="s1">&#39;DTEXP%TIME&#39;</span><span class="p">:</span><span class="s1">&#39;SECONDS&#39;</span><span class="p">,</span>
                                 <span class="s1">&#39;DTCUR%TDATE&#39;</span><span class="p">:</span><span class="s1">&#39;YYYYMMDD&#39;</span><span class="p">,</span>
                                 <span class="s1">&#39;DTCUR%TIME&#39;</span><span class="p">:</span><span class="s1">&#39;SECONDS&#39;</span><span class="p">,</span>
                                 <span class="s1">&#39;SLEVE&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">100</span><span class="p">)}</span>
        <span class="n">specialFieldsGridIndicator</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;LFI_COMPRESSED&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
                                      <span class="s1">&#39;CARTESIAN&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
                                      <span class="s1">&#39;LAT0&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
                                      <span class="s1">&#39;LON0&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
                                      <span class="s1">&#39;LATORI&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
                                      <span class="s1">&#39;LATOR&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
                                      <span class="s1">&#39;LONORI&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
                                      <span class="s1">&#39;LONOR&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
                                      <span class="s1">&#39;RPK&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
                                      <span class="s1">&#39;BETA&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
                                      <span class="s1">&#39;IMAX&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
                                      <span class="s1">&#39;JMAX&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
                                      <span class="s1">&#39;KMAX&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
                                      <span class="s1">&#39;XHAT&#39;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span>
                                      <span class="s1">&#39;YHAT&#39;</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span>
                                      <span class="s1">&#39;ZHAT&#39;</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span>
                                      <span class="s1">&#39;DTEXP%TDATE&#39;</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span>
                                      <span class="s1">&#39;DTEXP%TIME&#39;</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span>
                                      <span class="s1">&#39;DTCUR%TDATE&#39;</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span>
                                      <span class="s1">&#39;DTCUR%TIME&#39;</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span>
                                      <span class="s1">&#39;SLEVE&#39;</span><span class="p">:</span><span class="mi">4</span><span class="p">}</span>
        <span class="n">writtenfields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">listfields</span><span class="p">()</span>
        <span class="n">has2D</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">has3D</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">fid</span> <span class="ow">in</span> <span class="n">writtenfields</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">fid</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">true3d</span> <span class="k">else</span> <span class="n">fid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">field_info</span> <span class="o">=</span> <span class="n">inquire_field_dict</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">field_info</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;3D&#39;</span><span class="p">:</span>
                <span class="n">has3D</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">field_info</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;H2D&#39;</span> <span class="ow">and</span> <span class="n">name</span> <span class="o">!=</span> <span class="s1">&#39;ZS&#39;</span> <span class="ow">and</span> <span class="s1">&#39;.DATIM&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
                <span class="n">has2D</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">has2D</span> <span class="ow">or</span> <span class="n">has3D</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compressed</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_read_compression</span><span class="p">()</span>
            <span class="n">specialValues</span><span class="p">[</span><span class="s1">&#39;LFI_COMPRESSED&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compressed</span>
        <span class="k">if</span> <span class="n">has3D</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;SLEVE&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">in</span> <span class="n">writtenfields</span><span class="p">:</span>
                <span class="n">specialValues</span><span class="p">[</span><span class="s1">&#39;SLEVE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readfield</span><span class="p">((</span><span class="s1">&#39;SLEVE&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">specialValues</span><span class="p">[</span><span class="s1">&#39;SLEVE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">myFieldset</span> <span class="o">=</span> <span class="n">FieldSet</span><span class="p">()</span>
        <span class="n">fieldsMTO</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">appendedfields</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fieldset</span><span class="p">:</span>
            <span class="n">keep</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">fid</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">fid</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">format</span><span class="p">]</span>
            <span class="c1"># This field must not be already written, except if this is a special record</span>
            <span class="c1"># because special records can be written to file automaticaly when the first H2DField is encountered</span>
            <span class="k">if</span> <span class="n">fid</span> <span class="ow">in</span> <span class="n">writtenfields</span> <span class="ow">and</span> <span class="n">fid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">specialFields</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">epygramError</span><span class="p">(</span><span class="s2">&quot;there already is a field with the same name in this LFI.&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">fid</span> <span class="ow">in</span> <span class="n">writtenfields</span><span class="p">:</span>
                <span class="n">keep</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="c1"># In case of a special record already written in file, value must be the same</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">readfield</span><span class="p">(</span><span class="n">fid</span><span class="p">)</span><span class="o">.</span><span class="n">getdata</span><span class="p">()</span> <span class="o">!=</span> <span class="n">field</span><span class="o">.</span><span class="n">getdata</span><span class="p">():</span>
                    <span class="k">raise</span> <span class="n">epygramError</span><span class="p">(</span><span class="s2">&quot;there already is a field with the same name in this LFI with a different value.&quot;</span><span class="p">)</span>
            <span class="c1"># check for level validity</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">H2DField</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">D3Field</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">true3d</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fid</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">int</span><span class="p">)):</span>
                    <span class="k">raise</span> <span class="n">epygramError</span><span class="p">(</span><span class="s2">&quot;the level of a 2D field must be an integer&quot;</span><span class="p">)</span>
                <span class="n">fieldsMTO</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">true3d</span><span class="p">)</span> <span class="ow">and</span> <span class="n">fid</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">epygramError</span><span class="p">(</span><span class="s2">&quot;the level of a non 2D field must be None&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">fid</span> <span class="ow">in</span> <span class="n">appendedfields</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">epygramError</span><span class="p">(</span><span class="s2">&quot;a same field cannot be written twice in a LFI.&quot;</span><span class="p">)</span>
            <span class="n">appendedfields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fid</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">keep</span><span class="p">:</span>
                <span class="n">myFieldset</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">isopen</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>

        <span class="c1"># geometry, validity and compression</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fieldsMTO</span><span class="p">:</span>
            <span class="n">gvff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_geometryValidity_from_field</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">record</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">gvff</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="c1"># Cache value for next field</span>
                <span class="k">if</span> <span class="n">record</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">specialValues</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">record</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">true3d</span> <span class="k">else</span> <span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span> <span class="ow">in</span> <span class="n">appendedfields</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">myFieldset</span><span class="p">:</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">fid</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">format</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">true3d</span> <span class="k">else</span> <span class="n">f</span><span class="o">.</span><span class="n">fid</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">format</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="n">record</span><span class="p">:</span>
                                <span class="n">specialValues</span><span class="p">[</span><span class="n">record</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">getdata</span><span class="p">()</span>
                    <span class="k">elif</span> <span class="p">(</span><span class="n">record</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">true3d</span> <span class="k">else</span> <span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span> <span class="ow">in</span> <span class="n">writtenfields</span><span class="p">:</span>
                        <span class="n">specialValues</span><span class="p">[</span><span class="n">record</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readfield</span><span class="p">(</span><span class="n">record</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">true3d</span> <span class="k">else</span> <span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span><span class="o">.</span><span class="n">getdata</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">specialValues</span><span class="p">[</span><span class="n">record</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                        <span class="k">if</span> <span class="n">record</span> <span class="o">==</span> <span class="s1">&#39;LFI_COMPRESSED&#39;</span><span class="p">:</span>
                            <span class="n">keep</span> <span class="o">=</span> <span class="n">value</span>  <span class="c1"># we keep it only if its value is True</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">keep</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">if</span> <span class="n">keep</span><span class="p">:</span>
                            <span class="n">comment</span> <span class="o">=</span> <span class="n">specialFieldsComments</span><span class="p">[</span><span class="n">record</span><span class="p">]</span>
                            <span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="o">=</span> <span class="n">gridIndicatorDict</span><span class="p">[</span><span class="n">specialFieldsGridIndicator</span><span class="p">[</span><span class="n">record</span><span class="p">]]</span>

                            <span class="k">class</span> <span class="nc">empty</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
                                <span class="k">pass</span>

                            <span class="n">geometry</span> <span class="o">=</span> <span class="n">empty</span><span class="p">()</span>
                            <span class="n">geometry</span><span class="o">.</span><span class="n">position_on_horizontal_grid</span> <span class="o">=</span> <span class="n">h</span>
                            <span class="n">geometry</span><span class="o">.</span><span class="n">vcoordinate</span> <span class="o">=</span> <span class="n">empty</span><span class="p">()</span>
                            <span class="n">geometry</span><span class="o">.</span><span class="n">vcoordinate</span><span class="o">.</span><span class="n">position_on_grid</span> <span class="o">=</span> <span class="n">v</span>
                            <span class="n">f</span> <span class="o">=</span> <span class="n">MiscField</span><span class="p">(</span><span class="n">fid</span><span class="o">=</span><span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">format</span><span class="p">:</span><span class="n">record</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">true3d</span> <span class="k">else</span> <span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="kc">None</span><span class="p">)},</span> <span class="n">comment</span><span class="o">=</span><span class="n">comment</span><span class="p">)</span>
                            <span class="n">f</span><span class="o">.</span><span class="n">setdata</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                            <span class="n">f</span><span class="o">.</span><span class="n">geometry</span> <span class="o">=</span> <span class="n">geometry</span>
                            <span class="n">myFieldset</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">record</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;LAT0&#39;</span><span class="p">,</span> <span class="s1">&#39;LON0&#39;</span><span class="p">,</span> <span class="s1">&#39;LATOR&#39;</span><span class="p">,</span> <span class="s1">&#39;LATORI&#39;</span><span class="p">,</span> <span class="s1">&#39;LONOR&#39;</span><span class="p">,</span> <span class="s1">&#39;LONORI&#39;</span><span class="p">,</span> <span class="s1">&#39;RPK&#39;</span><span class="p">,</span> <span class="s1">&#39;BETA&#39;</span><span class="p">,</span> <span class="s1">&#39;ZHAT&#39;</span><span class="p">]:</span>
                    <span class="c1"># Float comparisons</span>
                    <span class="n">special_rpk</span> <span class="o">=</span> <span class="p">(</span><span class="n">record</span> <span class="o">==</span> <span class="s1">&#39;RPK&#39;</span> <span class="ow">and</span>
                                   <span class="n">field</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">secant_projection</span> <span class="ow">and</span>
                                   <span class="n">field</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;mercator&#39;</span><span class="p">,</span> <span class="s1">&#39;polar_stereographic&#39;</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">special_rpk</span><span class="p">:</span>
                        <span class="c1"># In geometries, when seant, we store latin1 and latin2 which are computed from RPK</span>
                        <span class="c1"># Computation is not exact computing back RPK from latin1 and latin2 does not give exactly the same result</span>
                        <span class="n">latin1_field</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">projection</span><span class="p">[</span><span class="s1">&#39;secant_lat1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;degrees&#39;</span><span class="p">)</span>
                        <span class="n">latin2_field</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">projection</span><span class="p">[</span><span class="s1">&#39;secant_lat2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;degrees&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="s1">&#39;latin1&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">specialValues</span><span class="p">:</span>
                            <span class="n">specialValues</span><span class="p">[</span><span class="s1">&#39;latin1&#39;</span><span class="p">],</span> <span class="n">specialValues</span><span class="p">[</span><span class="s1">&#39;latin2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_latin1_latin2_lambert</span><span class="p">(</span><span class="n">gvff</span><span class="p">[</span><span class="s1">&#39;LAT0&#39;</span><span class="p">],</span> <span class="n">specialValues</span><span class="p">[</span><span class="s1">&#39;RPK&#39;</span><span class="p">])</span>
                        <span class="n">check</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">util</span><span class="o">.</span><span class="n">nearlyEqualArray</span><span class="p">([</span><span class="n">latin1_field</span><span class="p">,</span> <span class="n">latin2_field</span><span class="p">],</span>
                                                                <span class="p">[</span><span class="n">specialValues</span><span class="p">[</span><span class="s1">&#39;latin1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;degrees&#39;</span><span class="p">),</span> <span class="n">specialValues</span><span class="p">[</span><span class="s1">&#39;latin2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;degrees&#39;</span><span class="p">)]))</span> <span class="ow">or</span> \
                                <span class="n">util</span><span class="o">.</span><span class="n">nearlyEqual</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">specialValues</span><span class="p">[</span><span class="n">record</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">check</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">util</span><span class="o">.</span><span class="n">nearlyEqualArray</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">specialValues</span><span class="p">[</span><span class="n">record</span><span class="p">]))</span>
                <span class="k">elif</span> <span class="n">record</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;XHAT&#39;</span><span class="p">,</span> <span class="s1">&#39;YHAT&#39;</span><span class="p">]:</span>
                    <span class="c1"># We check deltaX and deltaY because XHAT and YHAT can be computed in two different ways (prep_ideal or prep_pgd)</span>
                    <span class="n">check</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">nearlyEqualArray</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                  <span class="n">specialValues</span><span class="p">[</span><span class="n">record</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">specialValues</span><span class="p">[</span><span class="n">record</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">check</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">value</span> <span class="o">==</span> <span class="n">specialValues</span><span class="p">[</span><span class="n">record</span><span class="p">])</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">check</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">epygramError</span><span class="p">(</span><span class="s2">&quot;this field is not compatible with the fields already written to the file: &quot;</span> <span class="o">+</span> <span class="n">record</span><span class="p">)</span>
        <span class="c1"># writing</span>
        <span class="n">done</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">iField</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">myFieldset</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">iField</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">done</span><span class="p">:</span>
                <span class="n">field</span> <span class="o">=</span> <span class="n">myFieldset</span><span class="p">[</span><span class="n">iField</span><span class="p">]</span>
                <span class="n">field_info</span> <span class="o">=</span> <span class="n">inquire_field_dict</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">fid</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">format</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">true3d</span> <span class="k">else</span> <span class="n">field</span><span class="o">.</span><span class="n">fid</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">format</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">field_info</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;3D&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">true3d</span><span class="p">:</span>
                    <span class="n">comment</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">gridIndicator</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">dataInt</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">for</span> <span class="n">level</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">vcoordinate</span><span class="o">.</span><span class="n">grid</span><span class="p">[</span><span class="s1">&#39;gridlevels&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                        <span class="n">f</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">myFieldset</span><span class="p">)):</span>
                            <span class="k">if</span> <span class="n">myFieldset</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">fid</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">format</span><span class="p">]</span> <span class="o">==</span> <span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">fid</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">format</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">level</span><span class="p">):</span>
                                <span class="n">f</span> <span class="o">=</span> <span class="n">myFieldset</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                                <span class="n">num</span> <span class="o">=</span> <span class="n">i</span>
                        <span class="k">if</span> <span class="n">f</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="n">epygramError</span><span class="p">(</span><span class="s2">&quot;All levels of a 3D field must be written at once.&quot;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">H2DField</span><span class="p">):</span>
                            <span class="k">raise</span> <span class="n">epygramError</span><span class="p">(</span><span class="s2">&quot;All fields composing a 3D field must be H2DField&quot;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">comment</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">comment</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">comment</span>
                        <span class="k">elif</span> <span class="n">comment</span> <span class="o">!=</span> <span class="n">f</span><span class="o">.</span><span class="n">comment</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="n">epygramError</span><span class="p">(</span><span class="s2">&quot;All fields composing a same 3D field must have the same comment.&quot;</span><span class="p">)</span>
                        <span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">position_on_horizontal_grid</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">vcoordinate</span><span class="o">.</span><span class="n">position_on_grid</span>
                        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">gridIndicatorDict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                            <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
                                <span class="n">mygridIndicator</span> <span class="o">=</span> <span class="n">key</span>
                        <span class="k">if</span> <span class="n">gridIndicator</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">gridIndicator</span> <span class="o">=</span> <span class="n">mygridIndicator</span>
                        <span class="k">elif</span> <span class="n">gridIndicator</span> <span class="o">!=</span> <span class="n">mygridIndicator</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="n">epygramError</span><span class="p">(</span><span class="s2">&quot;All fields composing a same 3D field must have the same position on grid.&quot;</span><span class="p">)</span>
                        <span class="n">done</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">dataInt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">dataInt</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">getdata</span><span class="p">()</span><span class="o">.</span><span class="n">size</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">vcoordinate</span><span class="o">.</span><span class="n">grid</span><span class="p">[</span><span class="s1">&#39;gridlevels&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int64&#39;</span><span class="p">)</span>
                        <span class="n">dataInt</span><span class="p">[</span><span class="n">level</span> <span class="o">*</span> <span class="n">field</span><span class="o">.</span><span class="n">getdata</span><span class="p">()</span><span class="o">.</span><span class="n">size</span><span class="p">:(</span><span class="n">level</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">field</span><span class="o">.</span><span class="n">getdata</span><span class="p">()</span><span class="o">.</span><span class="n">size</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">getdata</span><span class="p">())</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="s1">&#39;int64&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">H2DField</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">true3d</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">D3Field</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">true3d</span><span class="p">):</span>
                        <span class="n">dataInt</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">getdata</span><span class="p">())</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="s1">&#39;int64&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>  <span class="c1"># Misc type</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">getdata</span><span class="p">()</span>
                        <span class="k">if</span> <span class="s1">&#39;int&#39;</span> <span class="ow">in</span> <span class="n">field</span><span class="o">.</span><span class="n">datatype</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                            <span class="n">dataInt</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                        <span class="k">elif</span> <span class="s1">&#39;str&#39;</span> <span class="ow">in</span> <span class="n">field</span><span class="o">.</span><span class="n">datatype</span><span class="o">.</span><span class="n">name</span> <span class="ow">or</span> <span class="s1">&#39;unicode&#39;</span> <span class="ow">in</span> <span class="n">field</span><span class="o">.</span><span class="n">datatype</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">shape</span> <span class="ow">in</span> <span class="p">((</span><span class="mi">1</span><span class="p">,),</span> <span class="p">()):</span>
                                <span class="n">dataInt</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">ord</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">)])</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;writing string arrays is not implemented.&#39;</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="s1">&#39;float&#39;</span> <span class="ow">in</span> <span class="n">field</span><span class="o">.</span><span class="n">datatype</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                            <span class="n">dataInt</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="s1">&#39;int64&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                        <span class="k">elif</span> <span class="s1">&#39;bool&#39;</span> <span class="ow">in</span> <span class="n">field</span><span class="o">.</span><span class="n">datatype</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                            <span class="n">dataInt</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;writing of datatype &quot;</span> <span class="o">+</span> <span class="n">field</span><span class="o">.</span><span class="n">datatype</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot; is not implemented.&quot;</span><span class="p">)</span>
                    <span class="n">comment</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">comment</span>
                    <span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">position_on_horizontal_grid</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">vcoordinate</span><span class="o">.</span><span class="n">position_on_grid</span>
                    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">gridIndicatorDict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
                            <span class="n">gridIndicator</span> <span class="o">=</span> <span class="n">key</span>
                <span class="n">header</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">(</span><span class="mi">2</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">comment</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
                <span class="n">header</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">gridIndicator</span>
                <span class="n">header</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">comment</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">comment</span><span class="p">)):</span>
                    <span class="n">header</span><span class="p">[</span><span class="mi">2</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">ord</span><span class="p">(</span><span class="n">comment</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">fid</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">format</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">true3d</span> <span class="k">else</span> <span class="n">field</span><span class="o">.</span><span class="n">fid</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">format</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;LFI_COMPRESSED&#39;</span> <span class="ow">in</span> <span class="n">specialValues</span> <span class="ow">and</span> <span class="n">specialValues</span><span class="p">[</span><span class="s1">&#39;LFI_COMPRESSED&#39;</span><span class="p">]</span> <span class="ow">and</span>
                   <span class="n">dataInt</span><span class="o">.</span><span class="n">size</span> <span class="o">%</span> <span class="p">((</span><span class="n">specialValues</span><span class="p">[</span><span class="s1">&#39;IMAX&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">specialValues</span><span class="p">[</span><span class="s1">&#39;JMAX&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span>
                   <span class="n">name</span> <span class="o">!=</span> <span class="s1">&#39;ZS&#39;</span> <span class="ow">and</span> <span class="s1">&#39;.DATIM&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">name</span><span class="p">):</span>
                    <span class="p">(</span><span class="n">dataInt</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span> <span class="o">=</span> <span class="n">wlfi</span><span class="o">.</span><span class="n">wcompress_field</span><span class="p">(</span><span class="n">dataInt</span><span class="p">,</span>
                                                           <span class="n">specialValues</span><span class="p">[</span><span class="s1">&#39;IMAX&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span>
                                                           <span class="n">specialValues</span><span class="p">[</span><span class="s1">&#39;JMAX&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span>
                                                           <span class="n">dataInt</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
                    <span class="n">dataInt</span> <span class="o">=</span> <span class="n">dataInt</span><span class="p">[:</span><span class="n">size</span><span class="p">]</span>
                <span class="n">dataToWrite</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">header</span><span class="p">,</span> <span class="n">dataInt</span><span class="p">))</span>
                <span class="n">wlfi</span><span class="o">.</span><span class="n">wlfiecr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_unit</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataToWrite</span><span class="p">),</span> <span class="n">dataToWrite</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">empty</span> <span class="o">=</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="LFI.rename_field"><a class="viewcode-back" href="../../../library/LFI.html#epygram.formats.LFI.LFI.rename_field">[docs]</a>    <span class="k">def</span> <span class="nf">rename_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fid</span><span class="p">,</span> <span class="n">new_fid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Renames a field &quot;in place&quot;.&quot;&quot;&quot;</span>
        <span class="n">wlfi</span><span class="o">.</span><span class="n">wlfiren</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_unit</span><span class="p">,</span> <span class="n">fid</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">true3d</span> <span class="k">else</span> <span class="n">fid</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">new_fid</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">true3d</span> <span class="k">else</span> <span class="n">new_fid</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></div>

<div class="viewcode-block" id="LFI.delfield"><a class="viewcode-back" href="../../../library/LFI.html#epygram.formats.LFI.LFI.delfield">[docs]</a>    <span class="k">def</span> <span class="nf">delfield</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Deletes a field from file &quot;in place&quot;.&quot;&quot;&quot;</span>
        <span class="n">wlfi</span><span class="o">.</span><span class="n">wlfisup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_unit</span><span class="p">,</span> <span class="n">fid</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">true3d</span> <span class="k">else</span> <span class="n">fid</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></div>

    <span class="nd">@FileResource</span><span class="o">.</span><span class="n">_openbeforedelayed</span>
    <span class="k">def</span> <span class="nf">extractprofile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fid</span><span class="p">,</span> <span class="n">lon</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">geometry</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">vertical_coordinate</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">,</span>
                       <span class="n">external_distance</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">cheap_height</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extracts a vertical profile from the LFI resource, given its fid</span>
<span class="sd">        and the geographic location (*lon*/*lat*) of the profile.</span>

<span class="sd">        :param fid: must have syntax: (&#39;PARAMETER&#39;, &#39;\*&#39;) if not true3d, else &#39;PARAMETER&#39;,</span>
<span class="sd">          \* being a true star character,</span>
<span class="sd">          and PARAMETER being the name of the parameter requested, as named in LFI.</span>
<span class="sd">        :param lon: the longitude of the desired point.</span>
<span class="sd">        :param lat: the latitude of the desired point.</span>
<span class="sd">        :param geometry: the geometry on which extract data. If None, it is built from</span>
<span class="sd">          lon/lat.</span>
<span class="sd">        :param vertical_coordinate: defines the requested vertical coordinate of the</span>
<span class="sd">          V1DField (cf. :class:`epygram.geometries.V1DGeometry` coordinate</span>
<span class="sd">          possible values).</span>
<span class="sd">        :param interpolation: defines the interpolation function used to compute</span>
<span class="sd">          the profile at requested lon/lat from the fields grid:\n</span>
<span class="sd">          - if &#39;nearest&#39; (default), extracts profile at the horizontal nearest neighboring gridpoint;</span>
<span class="sd">          - if &#39;linear&#39;, computes profile with horizontal linear spline interpolation;</span>
<span class="sd">          - if &#39;cubic&#39;, computes profile with horizontal cubic spline interpolation.</span>
<span class="sd">        :param external_distance: can be a dict containing the target point value</span>
<span class="sd">          and an external field on the same grid as self, to which the distance</span>
<span class="sd">          is computed within the 4 horizontally nearest points; e.g.</span>
<span class="sd">          {&#39;target_value&#39;:4810, &#39;external_field&#39;:an_H2DField_with_same_geometry}.</span>
<span class="sd">          If so, the nearest point is selected with</span>
<span class="sd">          distance = |target_value - external_field.data|</span>
<span class="sd">        :param cheap_height: has no effect (compatibity with FA format)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">geometry</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="kc">None</span> <span class="ow">in</span> <span class="p">[</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="n">epygramError</span><span class="p">(</span><span class="s2">&quot;You must give a geometry or lon *and* lat&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_read_geometry</span><span class="p">()</span>
            <span class="n">pointG</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">make_profile_geometry</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">lon</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">lat</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">epygramError</span><span class="p">(</span><span class="s2">&quot;You cannot provide lon or lat when geometry is given&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">geometry</span><span class="o">.</span><span class="n">structure</span> <span class="o">!=</span> <span class="s2">&quot;V1D&quot;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">epygramError</span><span class="p">(</span><span class="s2">&quot;geometry must be a V1D&quot;</span><span class="p">)</span>
            <span class="n">pointG</span> <span class="o">=</span> <span class="n">geometry</span>

        <span class="n">profile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_subdomain</span><span class="p">(</span><span class="n">fid</span><span class="p">,</span> <span class="n">pointG</span><span class="p">,</span>
                                         <span class="n">interpolation</span><span class="o">=</span><span class="n">interpolation</span><span class="p">,</span>
                                         <span class="n">vertical_coordinate</span><span class="o">=</span><span class="n">vertical_coordinate</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">profile</span>

    <span class="nd">@FileResource</span><span class="o">.</span><span class="n">_openbeforedelayed</span>
    <span class="k">def</span> <span class="nf">extractsection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fid</span><span class="p">,</span> <span class="n">end1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">end2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">geometry</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">points_number</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">resolution</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">vertical_coordinate</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span>
                       <span class="n">cheap_height</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">global_shift_center</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extracts a vertical section from the LFI resource, given its fid</span>
<span class="sd">        and the geographic (lon/lat) coordinates of its ends.</span>
<span class="sd">        The section is returned as a V2DField.</span>

<span class="sd">        :param fid: must have syntax: (&#39;PARAMETER&#39;, &#39;\*&#39;) if not true3d else &#39;PARAMETER&#39;,</span>
<span class="sd">          \* being a true star character,</span>
<span class="sd">          and PARAMETER being the name of the parameter requested, as named in LFI.</span>
<span class="sd">        :param end1: must be a tuple (lon, lat).</span>
<span class="sd">        :param end2: must be a tuple (lon, lat).</span>
<span class="sd">        :param geometry: the geometry on which extract data. If None, defaults to</span>
<span class="sd">          linearily spaced positions computed from  *points_number*.</span>
<span class="sd">        :param points_number: defines the total number of horizontal points of the</span>
<span class="sd">          section (including ends). If None, defaults to a number computed from</span>
<span class="sd">          the *ends* and the *resolution*.</span>
<span class="sd">        :param resolution: defines the horizontal resolution to be given to the</span>
<span class="sd">          field. If None, defaults to the horizontal resolution of the field.</span>
<span class="sd">        :param vertical_coordinate: defines the requested vertical coordinate of the</span>
<span class="sd">          V2DField (cf. :class:`epygram.geometries.V1DGeometry` coordinate</span>
<span class="sd">          possible values).</span>
<span class="sd">        :param interpolation: defines the interpolation function used to compute</span>
<span class="sd">          the profile points locations from the fields grid: \n</span>
<span class="sd">          - if &#39;nearest&#39;, each horizontal point of the section is</span>
<span class="sd">            taken as the horizontal nearest neighboring gridpoint;</span>
<span class="sd">          - if &#39;linear&#39; (default), each horizontal point of the section is</span>
<span class="sd">            computed with linear spline interpolation;</span>
<span class="sd">          - if &#39;cubic&#39;, each horizontal point of the section is</span>
<span class="sd">            computed with linear spline interpolation.</span>
<span class="sd">        :param cheap_height: has no effect (compatibity with FA format)</span>
<span class="sd">        :param global_shift_center: for global lon/lat grids, shift the center by the</span>
<span class="sd">            requested angle (in degrees). Enables a [0,360] grid</span>
<span class="sd">            to be shifted to a [-180,180] grid, for instance (with -180 argument).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">geometry</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="kc">None</span> <span class="ow">in</span> <span class="p">[</span><span class="n">end1</span><span class="p">,</span> <span class="n">end2</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="n">epygramError</span><span class="p">(</span><span class="s2">&quot;You must give a geometry or end1 *and* end2&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_read_geometry</span><span class="p">()</span>
            <span class="n">sectionG</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">make_section_geometry</span><span class="p">(</span><span class="n">end1</span><span class="p">,</span> <span class="n">end2</span><span class="p">,</span>
                                                           <span class="n">points_number</span><span class="o">=</span><span class="n">points_number</span><span class="p">,</span>
                                                           <span class="n">resolution</span><span class="o">=</span><span class="n">resolution</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">end1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">end2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">epygramError</span><span class="p">(</span><span class="s2">&quot;You cannot provide end1 or end2 when geometry is given&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">geometry</span><span class="o">.</span><span class="n">structure</span> <span class="o">!=</span> <span class="s2">&quot;V2D&quot;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">epygramError</span><span class="p">(</span><span class="s2">&quot;geometry must be a V2D&quot;</span><span class="p">)</span>
            <span class="n">sectionG</span> <span class="o">=</span> <span class="n">geometry</span>

        <span class="n">section</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_subdomain</span><span class="p">(</span><span class="n">fid</span><span class="p">,</span> <span class="n">sectionG</span><span class="p">,</span>
                                         <span class="n">interpolation</span><span class="o">=</span><span class="n">interpolation</span><span class="p">,</span>
                                         <span class="n">vertical_coordinate</span><span class="o">=</span><span class="n">vertical_coordinate</span><span class="p">,</span>
                                         <span class="n">global_shift_center</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">section</span>

    <span class="nd">@FileResource</span><span class="o">.</span><span class="n">_openbeforedelayed</span>
    <span class="k">def</span> <span class="nf">extract_subdomain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fid</span><span class="p">,</span> <span class="n">geometry</span><span class="p">,</span>
                          <span class="n">vertical_coordinate</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                          <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span>
                          <span class="n">exclude_extralevels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                          <span class="n">cheap_height</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                          <span class="n">global_shift_center</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extracts a subdomain from the LFI resource, given its fid</span>
<span class="sd">        and the geometry to use.</span>

<span class="sd">        :param fid: must have syntax: (&#39;PARAMETER&#39;, &#39;\*&#39;) if not true3d else &#39;PARAMETER&#39;,</span>
<span class="sd">          \* being a true star character,</span>
<span class="sd">          and PARAMETER being the name of the parameter requested, as named in LFI.</span>
<span class="sd">        :param geometry: the geometry on which extract data.</span>
<span class="sd">                         None to keep the geometry untouched.</span>
<span class="sd">        :param vertical_coordinate: defines the requested vertical coordinate of the</span>
<span class="sd">          V2DField (cf. :class:`epygram.geometries.V1DGeometry` coordinate</span>
<span class="sd">          possible values).</span>
<span class="sd">        :param interpolation defines the interpolation function used to compute</span>
<span class="sd">          the profile points locations from the fields grid: \n</span>
<span class="sd">          - if &#39;nearest&#39;, each horizontal point of the section is</span>
<span class="sd">            taken as the horizontal nearest neighboring gridpoint;</span>
<span class="sd">          - if &#39;linear&#39; (default), each horizontal point of the section is</span>
<span class="sd">            computed with linear spline interpolation;</span>
<span class="sd">          - if &#39;cubic&#39;, each horizontal point of the section is</span>
<span class="sd">            computed with linear spline interpolation.</span>
<span class="sd">        :param exclude_extralevels: if True, not physical levels are removed</span>
<span class="sd">        :param cheap_height: has no effect (compatibity with FA format)</span>
<span class="sd">        :param global_shift_center: for global lon/lat grids, shift the center by the</span>
<span class="sd">            requested angle (in degrees). Enables a [0,360] grid</span>
<span class="sd">            to be shifted to a [-180,180] grid, for instance (with -180 argument).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">true3d</span><span class="p">:</span>
            <span class="n">field3d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readfield</span><span class="p">(</span><span class="n">fid</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">field3d</span> <span class="o">=</span> <span class="n">fpx</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">fid</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;LFI&#39;</span><span class="p">:</span><span class="n">fid</span><span class="p">},</span>
                                <span class="n">structure</span><span class="o">=</span><span class="s1">&#39;3D&#39;</span><span class="p">,</span>
                                <span class="n">resource</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource_fids</span><span class="o">=</span><span class="p">[</span><span class="n">fid</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">global_shift_center</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">field3d</span><span class="o">.</span><span class="n">global_shift_center</span><span class="p">(</span><span class="n">global_shift_center</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">geometry</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">geometry</span> <span class="o">==</span> <span class="n">field3d</span><span class="o">.</span><span class="n">geometry</span><span class="p">:</span>
            <span class="n">subdomain</span> <span class="o">=</span> <span class="n">field3d</span>
            <span class="k">if</span> <span class="n">exclude_extralevels</span><span class="p">:</span>
                <span class="n">subdomain</span> <span class="o">=</span> <span class="n">subdomain</span><span class="o">.</span><span class="n">extract_physicallevels</span><span class="p">()</span>
            <span class="n">geometry</span> <span class="o">=</span> <span class="n">subdomain</span><span class="o">.</span><span class="n">geometry</span>
        <span class="k">elif</span> <span class="n">geometry</span> <span class="o">==</span> <span class="n">field3d</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">make_physicallevels_geometry</span><span class="p">():</span>
            <span class="n">subdomain</span> <span class="o">=</span> <span class="n">field3d</span><span class="o">.</span><span class="n">extract_physicallevels</span><span class="p">()</span>
            <span class="n">geometry</span> <span class="o">=</span> <span class="n">subdomain</span><span class="o">.</span><span class="n">geometry</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">subdomain</span> <span class="o">=</span> <span class="n">field3d</span><span class="o">.</span><span class="n">extract_subdomain</span><span class="p">(</span><span class="n">geometry</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="n">interpolation</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">exclude_extralevels</span><span class="p">:</span>
                <span class="n">subdomain</span> <span class="o">=</span> <span class="n">subdomain</span><span class="o">.</span><span class="n">extract_physicallevels</span><span class="p">()</span>

        <span class="c1"># vertical coords conversion</span>
        <span class="k">if</span> <span class="n">vertical_coordinate</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">subdomain</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">vcoordinate</span><span class="o">.</span><span class="n">typeoffirstfixedsurface</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">subdomain</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">vcoordinate</span><span class="o">.</span><span class="n">typeoffirstfixedsurface</span> <span class="o">==</span> <span class="mi">118</span> <span class="ow">and</span> \
               <span class="n">vertical_coordinate</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">102</span><span class="p">,</span> <span class="mi">103</span><span class="p">):</span>
                <span class="n">zsfield</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readfield</span><span class="p">(</span><span class="s1">&#39;ZS&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">true3d</span> <span class="k">else</span> <span class="p">(</span><span class="s1">&#39;ZS&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
                <span class="n">zs_values</span> <span class="o">=</span> <span class="n">zsfield</span><span class="o">.</span><span class="n">getvalue_ll</span><span class="p">(</span><span class="o">*</span><span class="n">geometry</span><span class="o">.</span><span class="n">get_lonlat_grid</span><span class="p">(),</span>
                                                <span class="n">interpolation</span><span class="o">=</span><span class="n">interpolation</span><span class="p">,</span> <span class="n">one</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">zs_values</span> <span class="o">=</span> <span class="n">zs_values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">geometry</span><span class="o">.</span><span class="n">get_datashape</span><span class="p">(</span><span class="n">force_dimZ</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
                <span class="n">subdomain</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">vcoordinate</span> <span class="o">=</span> <span class="n">hybridH2altitude</span><span class="p">(</span><span class="n">subdomain</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">vcoordinate</span><span class="p">,</span>
                                                                  <span class="n">zs_values</span><span class="p">,</span>
                                                                  <span class="n">gridposition</span><span class="o">=</span><span class="n">subdomain</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">vcoordinate</span><span class="o">.</span><span class="n">position_on_grid</span><span class="p">,</span>
                                                                  <span class="n">conv2height</span><span class="o">=</span><span class="p">(</span><span class="n">vertical_coordinate</span> <span class="o">==</span> <span class="mi">103</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">subdomain</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">vcoordinate</span><span class="o">.</span><span class="n">typeoffirstfixedsurface</span> <span class="o">==</span> <span class="mi">118</span> <span class="ow">and</span> \
                   <span class="n">vertical_coordinate</span> <span class="o">==</span> <span class="mi">100</span><span class="p">:</span>
                <span class="n">pid</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;PABSM&#39;</span><span class="p">,</span> <span class="s1">&#39;PABST&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">true3d</span> <span class="k">else</span> <span class="p">[(</span><span class="s1">&#39;PABSM&#39;</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;PABST&#39;</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">)]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">P</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_subdomain</span><span class="p">(</span><span class="n">pid</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">geometry</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="n">interpolation</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">P</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_subdomain</span><span class="p">(</span><span class="n">pid</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">geometry</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="n">interpolation</span><span class="p">)</span>
                <span class="n">subdomain</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">vcoordinate</span> <span class="o">=</span> <span class="n">hybridH2pressure</span><span class="p">(</span><span class="n">subdomain</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">vcoordinate</span><span class="p">,</span>
                                                                  <span class="n">P</span><span class="o">.</span><span class="n">getdata</span><span class="p">(),</span>
                                                                  <span class="n">P</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">vcoordinate</span><span class="o">.</span><span class="n">position_on_grid</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;this vertical coordinate conversion.&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">subdomain</span>

<span class="c1">###########</span>
<span class="c1"># pre-app #</span>
<span class="c1">###########</span>
    <span class="nd">@FileResource</span><span class="o">.</span><span class="n">_openbeforedelayed</span>
    <span class="k">def</span> <span class="nf">what</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span>
             <span class="n">details</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
             <span class="n">sortfields</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
             <span class="o">**</span><span class="n">_</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Writes in file a summary of the contents of the LFI.</span>

<span class="sd">        :param out: the output open file-like object</span>
<span class="sd">        :param sortfields: **True** if the fields have to be sorted by type.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">firstcolumn_width</span> <span class="o">=</span> <span class="mi">50</span>
        <span class="n">secondcolumn_width</span> <span class="o">=</span> <span class="mi">16</span>
        <span class="n">sepline</span> <span class="o">=</span> <span class="s1">&#39;{:-^</span><span class="si">{width}</span><span class="s1">}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">firstcolumn_width</span> <span class="o">+</span> <span class="n">secondcolumn_width</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">true3d</span><span class="p">:</span>
            <span class="n">first_H2DField</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">listfields</span><span class="p">()</span> <span class="k">if</span> <span class="n">inquire_field_dict</span><span class="p">(</span><span class="n">f</span><span class="p">)[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;H2D&#39;</span><span class="p">,</span> <span class="s1">&#39;3D&#39;</span><span class="p">]][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">first_H2DField</span> <span class="o">=</span> <span class="p">[(</span><span class="n">f</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">listfields</span><span class="p">()</span> <span class="k">if</span> <span class="n">inquire_field_dict</span><span class="p">(</span><span class="n">f</span><span class="p">)[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;H2D&#39;</span><span class="p">,</span> <span class="s1">&#39;3D&#39;</span><span class="p">]][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">firstfield</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readfield</span><span class="p">(</span><span class="n">first_H2DField</span><span class="p">,</span> <span class="n">getdata</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">listfields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">listfields</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">true3d</span><span class="p">:</span>
            <span class="n">listoffields</span> <span class="o">=</span> <span class="n">listfields</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">onelevel</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span> <span class="ow">in</span> <span class="n">listfields</span><span class="p">:</span>
                <span class="n">onelevel</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="n">l</span>
            <span class="n">listoffields</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span> <span class="ow">in</span> <span class="n">listfields</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">sortfields</span><span class="p">:</span>
            <span class="n">sortedfields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sortfields</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">write_formatted</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
            <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;{:&lt;</span><span class="si">{width}</span><span class="s1">}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">firstcolumn_width</span><span class="p">)</span> <span class="o">+</span>
                       <span class="s1">&#39;:&#39;</span> <span class="o">+</span>
                       <span class="s1">&#39;{:&gt;</span><span class="si">{width}</span><span class="s1">}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="n">width</span><span class="o">=</span><span class="n">secondcolumn_width</span><span class="p">)</span> <span class="o">+</span>
                       <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">write_formatted_col</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
            <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;{:&gt;</span><span class="si">{width}</span><span class="s1">}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">firstcolumn_width</span><span class="p">)</span> <span class="o">+</span>
                       <span class="s1">&#39;:&#39;</span> <span class="o">+</span>
                       <span class="s1">&#39;{:&gt;</span><span class="si">{width}</span><span class="s1">}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="n">width</span><span class="o">=</span><span class="n">secondcolumn_width</span><span class="p">)</span> <span class="o">+</span>
                       <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">write_formatted_fields</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">gridIndicator</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">comment</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">gridIndicator</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">comment</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;{:&lt;</span><span class="si">{width}</span><span class="s1">}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span> <span class="o">+</span>
                           <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;{:&lt;</span><span class="si">{width}</span><span class="s1">}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span> <span class="o">+</span>
                           <span class="s1">&#39;:&#39;</span> <span class="o">+</span>
                           <span class="s1">&#39;{:^</span><span class="si">{width}</span><span class="s1">}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">gridIndicator</span><span class="p">),</span> <span class="n">width</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span> <span class="o">+</span>
                           <span class="s1">&#39;:&#39;</span> <span class="o">+</span>
                           <span class="n">comment</span> <span class="o">+</span>
                           <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;### FORMAT: &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">format</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">firstfield</span><span class="o">.</span><span class="n">what</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">vertical_geometry</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fid</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">vcoordinate</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">vcoordinate</span><span class="o">.</span><span class="n">what</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;######################</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;### LIST OF FIELDS ###</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;######################</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sortfields</span><span class="p">:</span>
            <span class="n">listoffields</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">sortedfields</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="n">listoffields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                <span class="n">listoffields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;--------------------&#39;</span><span class="p">)</span>
                <span class="n">listoffields</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">sortedfields</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                <span class="n">listoffields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;--------------------&#39;</span><span class="p">)</span>
            <span class="n">numfields</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">sortedfields</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">numfields</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">listoffields</span><span class="p">)</span>
        <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Number: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">numfields</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">details</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">write_formatted_fields</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="s2">&quot;Field name&quot;</span><span class="p">,</span> <span class="s2">&quot;Grid ind.&quot;</span><span class="p">,</span> <span class="s2">&quot;Comment&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">write_formatted_fields</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="s2">&quot;Field name&quot;</span><span class="p">)</span>
        <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">sepline</span><span class="p">)</span>
        <span class="n">done</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">listoffields</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">f</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">done</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">details</span><span class="p">:</span>
                    <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readfield</span><span class="p">(</span><span class="n">f</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">true3d</span> <span class="k">else</span> <span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">onelevel</span><span class="p">[</span><span class="n">f</span><span class="p">]))</span>
                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="s1">&#39;geometry&#39;</span><span class="p">):</span>
                        <span class="n">gridIndicator</span> <span class="o">=</span> <span class="p">{(</span><span class="s1">&#39;__unknown__&#39;</span><span class="p">,</span> <span class="s1">&#39;__unknown__&#39;</span><span class="p">):</span><span class="mi">0</span><span class="p">,</span>
                                         <span class="p">(</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="s1">&#39;mass&#39;</span><span class="p">):</span><span class="mi">1</span><span class="p">,</span>
                                         <span class="p">(</span><span class="s1">&#39;center-left&#39;</span><span class="p">,</span> <span class="s1">&#39;mass&#39;</span><span class="p">):</span><span class="mi">2</span><span class="p">,</span>
                                         <span class="p">(</span><span class="s1">&#39;lower-center&#39;</span><span class="p">,</span> <span class="s1">&#39;mass&#39;</span><span class="p">):</span><span class="mi">3</span><span class="p">,</span>
                                         <span class="p">(</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="s1">&#39;flux&#39;</span><span class="p">):</span><span class="mi">4</span><span class="p">,</span>
                                         <span class="p">(</span><span class="s1">&#39;lower-left&#39;</span><span class="p">,</span> <span class="s1">&#39;mass&#39;</span><span class="p">):</span><span class="mi">5</span><span class="p">,</span>
                                         <span class="p">(</span><span class="s1">&#39;center-left&#39;</span><span class="p">,</span> <span class="s1">&#39;flux&#39;</span><span class="p">):</span><span class="mi">6</span><span class="p">,</span>
                                         <span class="p">(</span><span class="s1">&#39;lower-center&#39;</span><span class="p">,</span> <span class="s1">&#39;flux&#39;</span><span class="p">):</span><span class="mi">7</span><span class="p">,</span>
                                         <span class="p">(</span><span class="s1">&#39;lower-left&#39;</span><span class="p">,</span> <span class="s1">&#39;flux&#39;</span><span class="p">):</span><span class="mi">8</span><span class="p">}[</span><span class="n">field</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">position_on_horizontal_grid</span><span class="p">,</span>
                                                                   <span class="n">field</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">vcoordinate</span><span class="o">.</span><span class="n">position_on_grid</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">gridIndicator</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span>
                    <span class="n">write_formatted_fields</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">gridIndicator</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">comment</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">write_formatted_fields</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
                <span class="n">done</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">sepline</span><span class="p">)</span>

<span class="c1"># the LFI WAY #</span>
<span class="c1">###############</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_latin1_latin2_lambert</span><span class="p">(</span><span class="n">lat0</span><span class="p">,</span> <span class="n">rpk</span><span class="p">):</span>

        <span class="k">def</span> <span class="nf">k</span><span class="p">(</span><span class="n">latin2</span><span class="p">):</span>
            <span class="n">latin1</span> <span class="o">=</span> <span class="n">lat0</span>
            <span class="n">m1</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">latin1</span><span class="p">))</span>
            <span class="n">m2</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">latin2</span><span class="p">))</span>
            <span class="n">t1</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">4.</span> <span class="o">-</span> <span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">latin1</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">)</span>
            <span class="n">t2</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">4.</span> <span class="o">-</span> <span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">latin2</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">m1</span><span class="p">)</span> <span class="o">-</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">m2</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">t1</span><span class="p">)</span> <span class="o">-</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">t2</span><span class="p">))</span> <span class="o">-</span> <span class="n">rpk</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">scipy.optimize</span> <span class="k">as</span> <span class="nn">op</span>
            <span class="n">latin2</span> <span class="o">=</span> <span class="n">Angle</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">fsolve</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">math</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">asin</span><span class="p">(</span><span class="n">rpk</span><span class="p">))</span> <span class="o">-</span> <span class="n">lat0</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
                           <span class="s1">&#39;degrees&#39;</span><span class="p">)</span>
            <span class="n">latin1</span> <span class="o">=</span> <span class="n">Angle</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">lat0</span><span class="p">),</span> <span class="s1">&#39;degrees&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>

            <span class="k">def</span> <span class="nf">solve</span><span class="p">(</span><span class="n">function</span><span class="p">,</span> <span class="n">x0</span><span class="p">):</span>
                <span class="sd">&quot;&quot;&quot;A solver adapted to this problem. Do not try to use it elsewhere!&quot;&quot;&quot;</span>
                <span class="n">x1</span> <span class="o">=</span> <span class="n">x0</span> <span class="o">+</span> <span class="mf">1.</span>
                <span class="n">x2</span> <span class="o">=</span> <span class="n">x0</span>
                <span class="n">y1</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">x1</span><span class="p">)</span>
                <span class="n">y2</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">x2</span><span class="p">)</span>
                <span class="k">while</span> <span class="n">math</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">y2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">10.E-20</span> <span class="ow">and</span> <span class="n">math</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">y2</span><span class="p">)</span> <span class="o">!=</span> <span class="n">math</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">y1</span><span class="p">):</span>
                    <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span> <span class="o">=</span> <span class="n">x2</span><span class="p">,</span> <span class="n">x2</span> <span class="o">-</span> <span class="p">(</span><span class="n">x2</span> <span class="o">-</span> <span class="n">x1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">y2</span> <span class="o">-</span> <span class="n">y1</span><span class="p">)</span> <span class="o">*</span> <span class="n">y2</span>
                    <span class="n">y1</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="n">y2</span><span class="p">,</span> <span class="n">function</span><span class="p">(</span><span class="n">x2</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">x2</span>

            <span class="n">latin2</span> <span class="o">=</span> <span class="n">Angle</span><span class="p">(</span><span class="n">solve</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">math</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">asin</span><span class="p">(</span><span class="n">rpk</span><span class="p">))</span> <span class="o">-</span> <span class="n">lat0</span><span class="p">),</span>
                           <span class="s1">&#39;degrees&#39;</span><span class="p">)</span>
            <span class="n">latin1</span> <span class="o">=</span> <span class="n">Angle</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">lat0</span><span class="p">),</span> <span class="s1">&#39;degrees&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">latin1</span><span class="p">,</span> <span class="n">latin2</span><span class="p">)</span>

    <span class="nd">@FileResource</span><span class="o">.</span><span class="n">_openbeforedelayed</span>
    <span class="k">def</span> <span class="nf">_read_geometry</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reads the geometry in the LFI articles.</span>
<span class="sd">        Interface to Fortran routines from &#39;ifsaux&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">s</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">level</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">true3d</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">name</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">level</span><span class="p">)</span>

        <span class="n">listnames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_listLFInames</span><span class="p">()</span>
        <span class="k">if</span> <span class="s1">&#39;CARTESIAN&#39;</span> <span class="ow">in</span> <span class="n">listnames</span><span class="p">:</span>
            <span class="n">cartesian</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readfield</span><span class="p">(</span><span class="n">s</span><span class="p">(</span><span class="s1">&#39;CARTESIAN&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span><span class="o">.</span><span class="n">getdata</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cartesian</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">cartesian</span><span class="p">:</span>
            <span class="n">imax</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">readfield</span><span class="p">(</span><span class="n">s</span><span class="p">(</span><span class="s1">&#39;IMAX&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span><span class="o">.</span><span class="n">getdata</span><span class="p">())</span>
            <span class="n">jmax</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">readfield</span><span class="p">(</span><span class="n">s</span><span class="p">(</span><span class="s1">&#39;JMAX&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span><span class="o">.</span><span class="n">getdata</span><span class="p">())</span>
            <span class="n">xhat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readfield</span><span class="p">(</span><span class="n">s</span><span class="p">(</span><span class="s1">&#39;XHAT&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span><span class="o">.</span><span class="n">getdata</span><span class="p">()</span>
            <span class="n">yhat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readfield</span><span class="p">(</span><span class="n">s</span><span class="p">(</span><span class="s1">&#39;YHAT&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span><span class="o">.</span><span class="n">getdata</span><span class="p">()</span>
            <span class="n">lat0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readfield</span><span class="p">(</span><span class="n">s</span><span class="p">(</span><span class="s1">&#39;LAT0&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span><span class="o">.</span><span class="n">getdata</span><span class="p">()</span>
            <span class="n">lon0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readfield</span><span class="p">(</span><span class="n">s</span><span class="p">(</span><span class="s1">&#39;LON0&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span><span class="o">.</span><span class="n">getdata</span><span class="p">()</span>
            <span class="k">if</span> <span class="s1">&#39;KMAX&#39;</span> <span class="ow">in</span> <span class="n">listnames</span><span class="p">:</span>
                <span class="n">kmax</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">readfield</span><span class="p">(</span><span class="n">s</span><span class="p">(</span><span class="s1">&#39;KMAX&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span><span class="o">.</span><span class="n">getdata</span><span class="p">())</span>
                <span class="k">if</span> <span class="n">kmax</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">zhat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readfield</span><span class="p">(</span><span class="n">s</span><span class="p">(</span><span class="s1">&#39;ZHAT&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span><span class="o">.</span><span class="n">getdata</span><span class="p">()</span>
                    <span class="n">kmax</span> <span class="o">+=</span> <span class="mi">2</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">kmax</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">grid</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;X_resolution&#39;</span><span class="p">:</span><span class="n">xhat</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">xhat</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="s1">&#39;Y_resolution&#39;</span><span class="p">:</span><span class="n">yhat</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">yhat</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="s1">&#39;LAMzone&#39;</span><span class="p">:</span><span class="s1">&#39;CIE&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;latitude&#39;</span><span class="p">:</span><span class="n">Angle</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">lat0</span><span class="p">),</span> <span class="s1">&#39;degrees&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;longitude&#39;</span><span class="p">:</span><span class="n">Angle</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">lon0</span><span class="p">),</span> <span class="s1">&#39;degrees&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;input_lon&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
                    <span class="s1">&#39;input_lat&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
                    <span class="s1">&#39;input_position&#39;</span><span class="p">:(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="p">}</span>
            <span class="n">dimensions</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;X&#39;</span><span class="p">:</span><span class="n">imax</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span>
                          <span class="s1">&#39;Y&#39;</span><span class="p">:</span><span class="mi">1</span> <span class="k">if</span> <span class="p">(</span><span class="n">cartesian</span> <span class="ow">and</span> <span class="n">jmax</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="k">else</span> <span class="n">jmax</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span>
                          <span class="s1">&#39;X_CIzone&#39;</span><span class="p">:</span><span class="n">imax</span><span class="p">,</span>
                          <span class="s1">&#39;Y_CIzone&#39;</span><span class="p">:</span><span class="n">jmax</span><span class="p">,</span>
                          <span class="s1">&#39;X_Iwidth&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
                          <span class="s1">&#39;Y_Iwidth&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
                          <span class="s1">&#39;X_Czone&#39;</span><span class="p">:</span><span class="n">imax</span><span class="p">,</span>
                          <span class="s1">&#39;Y_Czone&#39;</span><span class="p">:</span><span class="n">jmax</span><span class="p">,</span>
                          <span class="s1">&#39;X_CIoffset&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
                          <span class="s1">&#39;Y_CIoffset&#39;</span><span class="p">:</span><span class="mi">1</span>
                          <span class="p">}</span>
            <span class="n">projection</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;rotation&#39;</span><span class="p">:</span><span class="n">Angle</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="s1">&#39;degrees&#39;</span><span class="p">),</span>
                          <span class="s1">&#39;reference_dX&#39;</span><span class="p">:</span><span class="n">grid</span><span class="p">[</span><span class="s1">&#39;X_resolution&#39;</span><span class="p">],</span>
                          <span class="s1">&#39;reference_dY&#39;</span><span class="p">:</span><span class="n">grid</span><span class="p">[</span><span class="s1">&#39;X_resolution&#39;</span><span class="p">]}</span>
            <span class="n">geometryname</span> <span class="o">=</span> <span class="s1">&#39;academic&#39;</span>
            <span class="n">kwargs_geom</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">structure</span><span class="o">=</span><span class="s1">&#39;3D&#39;</span><span class="p">,</span>
                               <span class="n">name</span><span class="o">=</span><span class="n">geometryname</span><span class="p">,</span>
                               <span class="n">grid</span><span class="o">=</span><span class="n">grid</span><span class="p">,</span>
                               <span class="n">dimensions</span><span class="o">=</span><span class="n">dimensions</span><span class="p">,</span>
                               <span class="n">projection</span><span class="o">=</span><span class="n">projection</span><span class="p">,</span>
                               <span class="n">geoid</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">LFI_default_geoid</span><span class="p">,</span>
                               <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lat0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readfield</span><span class="p">(</span><span class="n">s</span><span class="p">(</span><span class="s1">&#39;LAT0&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span><span class="o">.</span><span class="n">getdata</span><span class="p">()</span>
            <span class="n">lon0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readfield</span><span class="p">(</span><span class="n">s</span><span class="p">(</span><span class="s1">&#39;LON0&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span><span class="o">.</span><span class="n">getdata</span><span class="p">()</span>
            <span class="n">lat1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readfield</span><span class="p">(</span><span class="n">s</span><span class="p">(</span><span class="s1">&#39;LATORI&#39;</span> <span class="k">if</span> <span class="s1">&#39;LATORI&#39;</span> <span class="ow">in</span> <span class="n">listnames</span> <span class="k">else</span> <span class="s1">&#39;LATOR&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span><span class="o">.</span><span class="n">getdata</span><span class="p">()</span>
            <span class="n">lon1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readfield</span><span class="p">(</span><span class="n">s</span><span class="p">(</span><span class="s1">&#39;LONORI&#39;</span> <span class="k">if</span> <span class="s1">&#39;LONORI&#39;</span> <span class="ow">in</span> <span class="n">listnames</span> <span class="k">else</span> <span class="s1">&#39;LONOR&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span><span class="o">.</span><span class="n">getdata</span><span class="p">()</span>
            <span class="n">rpk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readfield</span><span class="p">(</span><span class="n">s</span><span class="p">(</span><span class="s1">&#39;RPK&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span><span class="o">.</span><span class="n">getdata</span><span class="p">()</span>
            <span class="n">beta</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">readfield</span><span class="p">(</span><span class="n">s</span><span class="p">(</span><span class="s1">&#39;BETA&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span><span class="o">.</span><span class="n">getdata</span><span class="p">())</span>
            <span class="n">imax</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">readfield</span><span class="p">(</span><span class="n">s</span><span class="p">(</span><span class="s1">&#39;IMAX&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span><span class="o">.</span><span class="n">getdata</span><span class="p">())</span>
            <span class="n">jmax</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">readfield</span><span class="p">(</span><span class="n">s</span><span class="p">(</span><span class="s1">&#39;JMAX&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span><span class="o">.</span><span class="n">getdata</span><span class="p">())</span>
            <span class="n">xhat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readfield</span><span class="p">(</span><span class="n">s</span><span class="p">(</span><span class="s1">&#39;XHAT&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span><span class="o">.</span><span class="n">getdata</span><span class="p">()</span>
            <span class="n">yhat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readfield</span><span class="p">(</span><span class="n">s</span><span class="p">(</span><span class="s1">&#39;YHAT&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span><span class="o">.</span><span class="n">getdata</span><span class="p">()</span>
            <span class="k">if</span> <span class="s1">&#39;KMAX&#39;</span> <span class="ow">in</span> <span class="n">listnames</span><span class="p">:</span>
                <span class="n">kmax</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">readfield</span><span class="p">(</span><span class="n">s</span><span class="p">(</span><span class="s1">&#39;KMAX&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span><span class="o">.</span><span class="n">getdata</span><span class="p">())</span>
                <span class="k">if</span> <span class="n">kmax</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">zhat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readfield</span><span class="p">(</span><span class="n">s</span><span class="p">(</span><span class="s1">&#39;ZHAT&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span><span class="o">.</span><span class="n">getdata</span><span class="p">()</span>
                    <span class="n">kmax</span> <span class="o">+=</span> <span class="mi">2</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">kmax</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="n">projection</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;reference_lon&#39;</span><span class="p">:</span><span class="n">Angle</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">lon0</span><span class="p">),</span> <span class="s1">&#39;degrees&#39;</span><span class="p">),</span>
                          <span class="s1">&#39;rotation&#39;</span><span class="p">:</span> <span class="n">Angle</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">beta</span><span class="p">),</span> <span class="s1">&#39;degrees&#39;</span><span class="p">)</span>
                          <span class="p">}</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">rpk</span> <span class="o">-</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">lat0</span><span class="p">)))</span> <span class="o">&lt;=</span> <span class="n">config</span><span class="o">.</span><span class="n">epsilon</span><span class="p">:</span>
                <span class="c1"># non secant</span>
                <span class="n">projection</span><span class="p">[</span><span class="s1">&#39;reference_lat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Angle</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">lat0</span><span class="p">),</span> <span class="s1">&#39;degrees&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">rpk</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">]:</span>
                    <span class="c1"># mercator or polar stereographic: one secant latitude</span>
                    <span class="n">projection</span><span class="p">[</span><span class="s1">&#39;reference_lat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Angle</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">copysign</span><span class="p">(</span><span class="mi">90</span><span class="p">,</span> <span class="n">lat0</span><span class="p">)),</span> <span class="s1">&#39;degrees&#39;</span><span class="p">)</span>
                    <span class="n">projection</span><span class="p">[</span><span class="s1">&#39;secant_lat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Angle</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">lat0</span><span class="p">),</span> <span class="s1">&#39;degrees&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># lambert: two secant latitudes</span>
                    <span class="n">latin1</span><span class="p">,</span> <span class="n">latin2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_latin1_latin2_lambert</span><span class="p">(</span><span class="n">lat0</span><span class="p">,</span> <span class="n">rpk</span><span class="p">)</span>
                    <span class="n">projection</span><span class="p">[</span><span class="s1">&#39;secant_lat1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">latin1</span>
                    <span class="n">projection</span><span class="p">[</span><span class="s1">&#39;secant_lat2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">latin2</span>
            <span class="n">grid</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;X_resolution&#39;</span><span class="p">:</span><span class="n">xhat</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">xhat</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="s1">&#39;Y_resolution&#39;</span><span class="p">:</span><span class="n">yhat</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">yhat</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="s1">&#39;LAMzone&#39;</span><span class="p">:</span><span class="s1">&#39;CIE&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;input_lon&#39;</span><span class="p">:</span><span class="n">Angle</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">lon1</span><span class="p">),</span> <span class="s1">&#39;degrees&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;input_lat&#39;</span><span class="p">:</span><span class="n">Angle</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">lat1</span><span class="p">),</span> <span class="s1">&#39;degrees&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;input_position&#39;</span><span class="p">:(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                    <span class="p">}</span>
            <span class="n">dimensions</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;X&#39;</span><span class="p">:</span><span class="n">imax</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span>
                          <span class="s1">&#39;Y&#39;</span><span class="p">:</span><span class="n">jmax</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span>
                          <span class="s1">&#39;X_CIzone&#39;</span><span class="p">:</span><span class="n">imax</span><span class="p">,</span>
                          <span class="s1">&#39;Y_CIzone&#39;</span><span class="p">:</span><span class="n">jmax</span><span class="p">,</span>
                          <span class="s1">&#39;X_Iwidth&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
                          <span class="s1">&#39;Y_Iwidth&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
                          <span class="s1">&#39;X_Czone&#39;</span><span class="p">:</span><span class="n">imax</span><span class="p">,</span>
                          <span class="s1">&#39;Y_Czone&#39;</span><span class="p">:</span><span class="n">jmax</span><span class="p">,</span>
                          <span class="s1">&#39;X_CIoffset&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
                          <span class="s1">&#39;Y_CIoffset&#39;</span><span class="p">:</span><span class="mi">1</span>
                          <span class="p">}</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">rpk</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">config</span><span class="o">.</span><span class="n">epsilon</span><span class="p">:</span>
                <span class="n">geometryname</span> <span class="o">=</span> <span class="s1">&#39;mercator&#39;</span>
            <span class="k">elif</span> <span class="nb">abs</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="nb">abs</span><span class="p">(</span><span class="n">rpk</span><span class="p">))</span> <span class="o">&lt;=</span> <span class="n">config</span><span class="o">.</span><span class="n">epsilon</span><span class="p">:</span>
                <span class="n">geometryname</span> <span class="o">=</span> <span class="s1">&#39;polar_stereographic&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">geometryname</span> <span class="o">=</span> <span class="s1">&#39;lambert&#39;</span>

            <span class="n">kwargs_geom</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">structure</span><span class="o">=</span><span class="s1">&#39;3D&#39;</span><span class="p">,</span>
                               <span class="n">name</span><span class="o">=</span><span class="n">geometryname</span><span class="p">,</span>
                               <span class="n">grid</span><span class="o">=</span><span class="n">grid</span><span class="p">,</span>
                               <span class="n">dimensions</span><span class="o">=</span><span class="n">dimensions</span><span class="p">,</span>
                               <span class="n">geoid</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">LFI_default_geoid</span><span class="p">,</span>
                               <span class="n">projection</span><span class="o">=</span><span class="n">projection</span>
                               <span class="p">)</span>

        <span class="k">if</span> <span class="n">kmax</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">H</span> <span class="o">=</span> <span class="n">zhat</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;SLEVE&#39;</span> <span class="ow">in</span> <span class="n">listnames</span><span class="p">:</span>
                <span class="n">sleve</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readfield</span><span class="p">(</span><span class="n">s</span><span class="p">(</span><span class="s1">&#39;SLEVE&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span><span class="o">.</span><span class="n">getdata</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sleve</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">Ai</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">zhat</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">kmax</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]][</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">Bi</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span> <span class="o">-</span> <span class="n">c</span> <span class="o">/</span> <span class="n">H</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">zhat</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">kmax</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]][</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">grid</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;gridlevels&#39;</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">([(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">FPDict</span><span class="p">({</span><span class="s1">&#39;Ai&#39;</span><span class="p">:</span><span class="n">Ai</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s1">&#39;Bi&#39;</span><span class="p">:</span><span class="n">Bi</span><span class="p">[</span><span class="n">i</span><span class="p">]}))</span> <span class="k">for</span>
                                         <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Ai</span><span class="p">))]),</span>
                    <span class="s1">&#39;ABgrid_position&#39;</span><span class="p">:</span><span class="s1">&#39;flux&#39;</span><span class="p">}</span>
            <span class="n">kwargs_vcoord</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;structure&#39;</span><span class="p">:</span> <span class="s1">&#39;V&#39;</span><span class="p">,</span>
                             <span class="s1">&#39;typeoffirstfixedsurface&#39;</span><span class="p">:</span><span class="mi">118</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">sleve</span> <span class="k">else</span> <span class="mi">255</span><span class="p">,</span>
                             <span class="s1">&#39;position_on_grid&#39;</span><span class="p">:</span> <span class="s1">&#39;mass&#39;</span><span class="p">,</span>
                             <span class="s1">&#39;grid&#39;</span><span class="p">:</span> <span class="n">grid</span><span class="p">,</span>
                             <span class="s1">&#39;levels&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Ai</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)])</span>
                             <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">kwargs_vcoord</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;structure&#39;</span><span class="p">:</span> <span class="s1">&#39;V&#39;</span><span class="p">,</span>
                             <span class="s1">&#39;typeoffirstfixedsurface&#39;</span><span class="p">:</span> <span class="mi">255</span><span class="p">,</span>
                             <span class="s1">&#39;position_on_grid&#39;</span><span class="p">:</span> <span class="s1">&#39;__unknown__&#39;</span><span class="p">,</span>
                             <span class="s1">&#39;levels&#39;</span><span class="p">:[</span><span class="mi">255</span><span class="p">]}</span>
        <span class="n">kwargs_geom</span><span class="p">[</span><span class="s1">&#39;position_on_horizontal_grid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;center&#39;</span>
        <span class="n">kwargs_geom</span><span class="p">[</span><span class="s1">&#39;vcoordinate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fpx</span><span class="o">.</span><span class="n">geometry</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs_vcoord</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span> <span class="o">=</span> <span class="n">fpx</span><span class="o">.</span><span class="n">geometry</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs_geom</span><span class="p">)</span>

    <span class="nd">@FileResource</span><span class="o">.</span><span class="n">_openbeforedelayed</span>
    <span class="k">def</span> <span class="nf">_read_validity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reads the validity in the LFI articles.&quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">s</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">level</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">true3d</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">name</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">level</span><span class="p">)</span>

        <span class="n">listnames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_listLFInames</span><span class="p">()</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="s1">&#39;DTEXP%TDATE&#39;</span> <span class="ow">in</span> <span class="n">listnames</span><span class="p">:</span>
            <span class="n">dtexpDate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readfield</span><span class="p">(</span><span class="n">s</span><span class="p">(</span><span class="s1">&#39;DTEXP%TDATE&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span><span class="o">.</span><span class="n">getdata</span><span class="p">()</span>
            <span class="n">dtexpTime</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">readfield</span><span class="p">(</span><span class="n">s</span><span class="p">(</span><span class="s1">&#39;DTEXP%TIME&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span><span class="o">.</span><span class="n">getdata</span><span class="p">())</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;basis&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="n">dtexpDate</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                 <span class="n">dtexpDate</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                                 <span class="n">dtexpDate</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">+</span>
                               <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">dtexpTime</span><span class="p">))</span>
            <span class="k">if</span> <span class="s1">&#39;DTCUR%TDATE&#39;</span> <span class="ow">in</span> <span class="n">listnames</span><span class="p">:</span>
                <span class="n">dtcurDate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readfield</span><span class="p">(</span><span class="n">s</span><span class="p">(</span><span class="s1">&#39;DTCUR%TDATE&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span><span class="o">.</span><span class="n">getdata</span><span class="p">()</span>
                <span class="n">dtcurTime</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">readfield</span><span class="p">(</span><span class="n">s</span><span class="p">(</span><span class="s1">&#39;DTCUR%TIME&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span><span class="o">.</span><span class="n">getdata</span><span class="p">())</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;term&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="n">dtcurDate</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                    <span class="n">dtcurDate</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                                    <span class="n">dtcurDate</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">+</span>
                                  <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">dtcurTime</span><span class="p">)</span> <span class="o">-</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;basis&#39;</span><span class="p">])</span>
        <span class="k">elif</span> <span class="s1">&#39;DTCUR%TDATE&#39;</span> <span class="ow">in</span> <span class="n">listnames</span><span class="p">:</span>
            <span class="n">dtcurDate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readfield</span><span class="p">(</span><span class="n">s</span><span class="p">(</span><span class="s1">&#39;DTCUR%TDATE&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span><span class="o">.</span><span class="n">getdata</span><span class="p">()</span>
            <span class="n">dtcurTime</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">readfield</span><span class="p">(</span><span class="n">s</span><span class="p">(</span><span class="s1">&#39;DTCUR%TIME&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span><span class="o">.</span><span class="n">getdata</span><span class="p">())</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;date_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="n">dtcurDate</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                    <span class="n">dtcurDate</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                                    <span class="n">dtcurDate</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">+</span> \
                                  <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">dtcurTime</span><span class="p">)</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;cumulativeduration&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validity</span> <span class="o">=</span> <span class="n">FieldValidity</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="nd">@FileResource</span><span class="o">.</span><span class="n">_openbeforedelayed</span>
    <span class="k">def</span> <span class="nf">_read_compression</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reads the compression.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compressed</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;LFI_COMPRESSED&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_listLFInames</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_compressed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readfield</span><span class="p">(</span><span class="s1">&#39;LFI_COMPRESSED&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">true3d</span> <span class="k">else</span> <span class="p">(</span><span class="s1">&#39;LFI_COMPRESSED&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span><span class="o">.</span><span class="n">getdata</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_compressed</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">_get_geometryValidity_from_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns special record needed to represent the geometry</span>
<span class="sd">        and the validty of this field.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">specialFields</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compressed</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_read_compression</span><span class="p">()</span>
        <span class="n">specialFields</span><span class="p">[</span><span class="s1">&#39;LFI_COMPRESSED&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compressed</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">geometry</span>
        <span class="n">field_info</span> <span class="o">=</span> <span class="n">inquire_field_dict</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">fid</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">format</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">true3d</span> <span class="k">else</span> <span class="n">field</span><span class="o">.</span><span class="n">fid</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">format</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">specialFields</span><span class="p">[</span><span class="s1">&#39;IMAX&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span>
        <span class="n">specialFields</span><span class="p">[</span><span class="s1">&#39;JMAX&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="s1">&#39;Y&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">g</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="s1">&#39;Y&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span>
        <span class="n">dimX</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">dimX</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">dimX</span> <span class="o">+=</span> <span class="mi">2</span>
        <span class="n">specialFields</span><span class="p">[</span><span class="s1">&#39;XHAT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="n">g</span><span class="o">.</span><span class="n">grid</span><span class="p">[</span><span class="s1">&#39;X_resolution&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">,</span>
                                             <span class="n">g</span><span class="o">.</span><span class="n">grid</span><span class="p">[</span><span class="s1">&#39;X_resolution&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">dimX</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
                                             <span class="n">g</span><span class="o">.</span><span class="n">grid</span><span class="p">[</span><span class="s1">&#39;X_resolution&#39;</span><span class="p">])</span>
        <span class="n">dimY</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="s1">&#39;Y&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">dimY</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">dimY</span> <span class="o">+=</span> <span class="mi">2</span>
        <span class="n">specialFields</span><span class="p">[</span><span class="s1">&#39;YHAT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="n">g</span><span class="o">.</span><span class="n">grid</span><span class="p">[</span><span class="s1">&#39;Y_resolution&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">,</span>
                                             <span class="n">g</span><span class="o">.</span><span class="n">grid</span><span class="p">[</span><span class="s1">&#39;Y_resolution&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">dimY</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
                                             <span class="n">g</span><span class="o">.</span><span class="n">grid</span><span class="p">[</span><span class="s1">&#39;Y_resolution&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">vcoordinate</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">field_info</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;3D&#39;</span><span class="p">:</span>
                <span class="n">specialFields</span><span class="p">[</span><span class="s1">&#39;SLEVE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">vcoordinate</span><span class="o">.</span><span class="n">typeoffirstfixedsurface</span> <span class="o">!=</span> <span class="mi">118</span>
                <span class="n">kmax</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">vcoordinate</span><span class="o">.</span><span class="n">grid</span><span class="p">[</span><span class="s1">&#39;gridlevels&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">kmax</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">kmax</span> <span class="o">-=</span> <span class="mi">2</span>
                <span class="n">specialFields</span><span class="p">[</span><span class="s1">&#39;KMAX&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kmax</span>
                <span class="n">Ai</span> <span class="o">=</span> <span class="p">[</span><span class="n">level</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;Ai&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">level</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">vcoordinate</span><span class="o">.</span><span class="n">grid</span><span class="p">[</span><span class="s1">&#39;gridlevels&#39;</span><span class="p">]]</span>
                <span class="n">Ai</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">Ai</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">+</span> <span class="n">Ai</span>
                <span class="n">specialFields</span><span class="p">[</span><span class="s1">&#39;ZHAT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Ai</span>
                <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">vcoordinate</span><span class="o">.</span><span class="n">grid</span><span class="p">[</span><span class="s1">&#39;ABgrid_position&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;flux&#39;</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">epygramError</span><span class="p">(</span><span class="s2">&quot;Don&#39;t jnow how to deal with ABgrid_position!=&#39;flux&#39;&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;academic&#39;</span><span class="p">:</span>
            <span class="n">specialFields</span><span class="p">[</span><span class="s1">&#39;BETA&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
            <span class="n">specialFields</span><span class="p">[</span><span class="s1">&#39;CARTESIAN&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="s1">&#39;latitude&#39;</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">grid</span><span class="p">:</span>
                <span class="n">specialFields</span><span class="p">[</span><span class="s1">&#39;LAT0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">grid</span><span class="p">[</span><span class="s1">&#39;latitude&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;degrees&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">specialFields</span><span class="p">[</span><span class="s1">&#39;LAT0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
            <span class="k">if</span> <span class="s1">&#39;longitude&#39;</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">grid</span><span class="p">:</span>
                <span class="n">specialFields</span><span class="p">[</span><span class="s1">&#39;LON0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">grid</span><span class="p">[</span><span class="s1">&#39;longitude&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;degrees&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">specialFields</span><span class="p">[</span><span class="s1">&#39;LON0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">specialFields</span><span class="p">[</span><span class="s1">&#39;BETA&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">projection</span><span class="p">[</span><span class="s1">&#39;rotation&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;degrees&#39;</span><span class="p">)</span>
            <span class="n">specialFields</span><span class="p">[</span><span class="s1">&#39;CARTESIAN&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">specialFields</span><span class="p">[</span><span class="s1">&#39;LON0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">projection</span><span class="p">[</span><span class="s1">&#39;reference_lon&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;degrees&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">secant_projection</span><span class="p">:</span>
                <span class="n">specialFields</span><span class="p">[</span><span class="s1">&#39;LAT0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">projection</span><span class="p">[</span><span class="s1">&#39;reference_lat&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;degrees&#39;</span><span class="p">)</span>
                <span class="n">specialFields</span><span class="p">[</span><span class="s1">&#39;RPK&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">projection</span><span class="p">[</span><span class="s1">&#39;reference_lat&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;radians&#39;</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;mercator&#39;</span><span class="p">,</span> <span class="s1">&#39;polar_stereographic&#39;</span><span class="p">]:</span>
                    <span class="n">specialFields</span><span class="p">[</span><span class="s1">&#39;LAT0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">projection</span><span class="p">[</span><span class="s1">&#39;secant_lat&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;degrees&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;mercator&#39;</span><span class="p">:</span>
                        <span class="n">specialFields</span><span class="p">[</span><span class="s1">&#39;RPK&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">specialFields</span><span class="p">[</span><span class="s1">&#39;RPK&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">copysign</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">specialFields</span><span class="p">[</span><span class="s1">&#39;LAT0&#39;</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">latin1</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">projection</span><span class="p">[</span><span class="s1">&#39;secant_lat1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;degrees&#39;</span><span class="p">)</span>
                    <span class="n">latin2</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">projection</span><span class="p">[</span><span class="s1">&#39;secant_lat2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;degrees&#39;</span><span class="p">)</span>
                    <span class="n">m1</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">latin1</span><span class="p">))</span>
                    <span class="n">m2</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">latin2</span><span class="p">))</span>
                    <span class="n">t1</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">4.</span> <span class="o">-</span> <span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">latin1</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">)</span>
                    <span class="n">t2</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">4.</span> <span class="o">-</span> <span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">latin2</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">)</span>
                    <span class="n">specialFields</span><span class="p">[</span><span class="s1">&#39;LAT0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">latin1</span>
                    <span class="n">specialFields</span><span class="p">[</span><span class="s1">&#39;RPK&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">m1</span><span class="p">)</span> <span class="o">-</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">m2</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">t1</span><span class="p">)</span> <span class="o">-</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">t2</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">grid</span><span class="p">[</span><span class="s1">&#39;input_position&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">specialFields</span><span class="p">[</span><span class="s1">&#39;LONOR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">grid</span><span class="p">[</span><span class="s1">&#39;input_lon&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;degrees&#39;</span><span class="p">)</span>
                <span class="n">specialFields</span><span class="p">[</span><span class="s1">&#39;LATOR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">grid</span><span class="p">[</span><span class="s1">&#39;input_lat&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;degrees&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">originPoint</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">gimme_corners_ll</span><span class="p">(</span><span class="n">subzone</span><span class="o">=</span><span class="s1">&#39;CIE&#39;</span><span class="p">,</span> <span class="n">position</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)[</span><span class="s1">&#39;ll&#39;</span><span class="p">]</span>
                <span class="n">specialFields</span><span class="p">[</span><span class="s1">&#39;LONOR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">originPoint</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">specialFields</span><span class="p">[</span><span class="s1">&#39;LATOR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">originPoint</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">specialFields</span><span class="p">[</span><span class="s1">&#39;LONORI&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">specialFields</span><span class="p">[</span><span class="s1">&#39;LONOR&#39;</span><span class="p">]</span>
            <span class="n">specialFields</span><span class="p">[</span><span class="s1">&#39;LATORI&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">specialFields</span><span class="p">[</span><span class="s1">&#39;LATOR&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">validity</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">validity</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">epygramError</span><span class="p">(</span><span class="s2">&quot;LFI can hold only one validity.&quot;</span><span class="p">)</span>
            <span class="n">basis</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">validity</span><span class="o">.</span><span class="n">getbasis</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">basis</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">specialFields</span><span class="p">[</span><span class="s1">&#39;DTEXP%TDATE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">day</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
                <span class="n">specialFields</span><span class="p">[</span><span class="s1">&#39;DTEXP%TIME&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">hour</span> <span class="o">*</span> <span class="mi">3600</span> <span class="o">+</span> <span class="n">basis</span><span class="o">.</span><span class="n">minute</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">+</span> <span class="n">basis</span><span class="o">.</span><span class="n">second</span><span class="p">)</span>
                <span class="n">validity</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">validity</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">validity</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">specialFields</span><span class="p">[</span><span class="s1">&#39;DTCUR%TDATE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">validity</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">validity</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">validity</span><span class="o">.</span><span class="n">day</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
                    <span class="n">specialFields</span><span class="p">[</span><span class="s1">&#39;DTCUR%TIME&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">validity</span><span class="o">.</span><span class="n">hour</span> <span class="o">*</span> <span class="mi">3600</span> <span class="o">+</span> <span class="n">validity</span><span class="o">.</span><span class="n">minute</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">+</span> <span class="n">validity</span><span class="o">.</span><span class="n">second</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">specialFields</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">epygram 1.4.14 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../../epygram.html" >epygram</a> &#187;</li>
          <li class="nav-item nav-item-3"><a href="../formats.html" >epygram.formats</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2014 --- 2022, A.Mary, S.Riette.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.8.5.
    </div>
  </body>
</html>